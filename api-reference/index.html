
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../getting-started/">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.6">
    
    
      
        <title>API Reference - Sibila</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.50c56a3b.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#models" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Sibila" class="md-header__button md-logo" aria-label="Sibila" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Sibila
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              API Reference
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Sibila" class="md-nav__button md-logo" aria-label="Sibila" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Sibila
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Documentation
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../getting-started/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Getting Started
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    API Reference
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    API Reference
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#models" class="md-nav__link">
    <span class="md-ellipsis">
      Models
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Models">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sibila.LlamaCppModel" class="md-nav__link">
    <span class="md-ellipsis">
      LlamaCppModel
    </span>
  </a>
  
    <nav class="md-nav" aria-label="LlamaCppModel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sibila.LlamaCppModel.gen" class="md-nav__link">
    <span class="md-ellipsis">
      gen
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.LlamaCppModel.json" class="md-nav__link">
    <span class="md-ellipsis">
      json
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.LlamaCppModel.dictype" class="md-nav__link">
    <span class="md-ellipsis">
      dictype
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.LlamaCppModel.pydantic" class="md-nav__link">
    <span class="md-ellipsis">
      pydantic
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.LlamaCppModel.gen_" class="md-nav__link">
    <span class="md-ellipsis">
      gen_
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.LlamaCppModel.json_" class="md-nav__link">
    <span class="md-ellipsis">
      json_
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.LlamaCppModel.dictype_" class="md-nav__link">
    <span class="md-ellipsis">
      dictype_
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.LlamaCppModel.pydantic_" class="md-nav__link">
    <span class="md-ellipsis">
      pydantic_
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.LlamaCppModel.token_len" class="md-nav__link">
    <span class="md-ellipsis">
      token_len
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.LlamaCppModel.tokenizer" class="md-nav__link">
    <span class="md-ellipsis">
      tokenizer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.LlamaCppModel.ctx_len" class="md-nav__link">
    <span class="md-ellipsis">
      ctx_len
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.LlamaCppModel.desc" class="md-nav__link">
    <span class="md-ellipsis">
      desc
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.LlamaCppModel.n_embd" class="md-nav__link">
    <span class="md-ellipsis">
      n_embd
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.LlamaCppModel.n_params" class="md-nav__link">
    <span class="md-ellipsis">
      n_params
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.LlamaCppModel.get_metadata" class="md-nav__link">
    <span class="md-ellipsis">
      get_metadata
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.OpenAIModel" class="md-nav__link">
    <span class="md-ellipsis">
      OpenAIModel
    </span>
  </a>
  
    <nav class="md-nav" aria-label="OpenAIModel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sibila.OpenAIModel.gen" class="md-nav__link">
    <span class="md-ellipsis">
      gen
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.OpenAIModel.json" class="md-nav__link">
    <span class="md-ellipsis">
      json
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.OpenAIModel.dictype" class="md-nav__link">
    <span class="md-ellipsis">
      dictype
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.OpenAIModel.pydantic" class="md-nav__link">
    <span class="md-ellipsis">
      pydantic
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.OpenAIModel.gen_" class="md-nav__link">
    <span class="md-ellipsis">
      gen_
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.OpenAIModel.json_" class="md-nav__link">
    <span class="md-ellipsis">
      json_
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.OpenAIModel.dictype_" class="md-nav__link">
    <span class="md-ellipsis">
      dictype_
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.OpenAIModel.pydantic_" class="md-nav__link">
    <span class="md-ellipsis">
      pydantic_
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.OpenAIModel.token_len" class="md-nav__link">
    <span class="md-ellipsis">
      token_len
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.OpenAIModel.tokenizer" class="md-nav__link">
    <span class="md-ellipsis">
      tokenizer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.OpenAIModel.ctx_len" class="md-nav__link">
    <span class="md-ellipsis">
      ctx_len
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.OpenAIModel.desc" class="md-nav__link">
    <span class="md-ellipsis">
      desc
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#messages-threads-context" class="md-nav__link">
    <span class="md-ellipsis">
      Messages, Threads, Context
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Messages, Threads, Context">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sibila.MsgKind" class="md-nav__link">
    <span class="md-ellipsis">
      MsgKind
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MsgKind">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sibila.MsgKind.IN" class="md-nav__link">
    <span class="md-ellipsis">
      IN
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.MsgKind.OUT" class="md-nav__link">
    <span class="md-ellipsis">
      OUT
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.MsgKind.INST" class="md-nav__link">
    <span class="md-ellipsis">
      INST
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.Thread" class="md-nav__link">
    <span class="md-ellipsis">
      Thread
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Thread">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sibila.Thread.clear" class="md-nav__link">
    <span class="md-ellipsis">
      clear
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.Thread.last_kind" class="md-nav__link">
    <span class="md-ellipsis">
      last_kind
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.Thread.inst" class="md-nav__link">
    <span class="md-ellipsis">
      inst
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.Thread.add" class="md-nav__link">
    <span class="md-ellipsis">
      add
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.Thread.addx" class="md-nav__link">
    <span class="md-ellipsis">
      addx
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.Thread.get_text" class="md-nav__link">
    <span class="md-ellipsis">
      get_text
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.Thread.set_text" class="md-nav__link">
    <span class="md-ellipsis">
      set_text
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.Thread.concat" class="md-nav__link">
    <span class="md-ellipsis">
      concat
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.Thread.load" class="md-nav__link">
    <span class="md-ellipsis">
      load
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.Thread.save" class="md-nav__link">
    <span class="md-ellipsis">
      save
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.Thread.msg_as_chatml" class="md-nav__link">
    <span class="md-ellipsis">
      msg_as_chatml
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.Thread.as_chatml" class="md-nav__link">
    <span class="md-ellipsis">
      as_chatml
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.Thread.has_text_lower" class="md-nav__link">
    <span class="md-ellipsis">
      has_text_lower
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.Trim" class="md-nav__link">
    <span class="md-ellipsis">
      Trim
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Trim">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sibila.Trim.NONE" class="md-nav__link">
    <span class="md-ellipsis">
      NONE
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.Trim.INST" class="md-nav__link">
    <span class="md-ellipsis">
      INST
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.Trim.IN" class="md-nav__link">
    <span class="md-ellipsis">
      IN
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.Trim.OUT" class="md-nav__link">
    <span class="md-ellipsis">
      OUT
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.Trim.KEEP_FIRST_IN" class="md-nav__link">
    <span class="md-ellipsis">
      KEEP_FIRST_IN
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.Trim.KEEP_FIRST_OUT" class="md-nav__link">
    <span class="md-ellipsis">
      KEEP_FIRST_OUT
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.Context" class="md-nav__link">
    <span class="md-ellipsis">
      Context
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Context">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sibila.Context.clear" class="md-nav__link">
    <span class="md-ellipsis">
      clear
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.Context.trim" class="md-nav__link">
    <span class="md-ellipsis">
      trim
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#generation-configs" class="md-nav__link">
    <span class="md-ellipsis">
      Generation Configs
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Generation Configs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sibila.GenConf" class="md-nav__link">
    <span class="md-ellipsis">
      GenConf
    </span>
  </a>
  
    <nav class="md-nav" aria-label="GenConf">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sibila.GenConf.max_tokens" class="md-nav__link">
    <span class="md-ellipsis">
      max_tokens
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.GenConf.stop" class="md-nav__link">
    <span class="md-ellipsis">
      stop
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.GenConf.temperature" class="md-nav__link">
    <span class="md-ellipsis">
      temperature
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.GenConf.top_p" class="md-nav__link">
    <span class="md-ellipsis">
      top_p
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.GenConf.format" class="md-nav__link">
    <span class="md-ellipsis">
      format
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.GenConf.json_schema" class="md-nav__link">
    <span class="md-ellipsis">
      json_schema
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.GenConf.asdict" class="md-nav__link">
    <span class="md-ellipsis">
      asdict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.GenConf.clone" class="md-nav__link">
    <span class="md-ellipsis">
      clone
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.GenConf.__call__" class="md-nav__link">
    <span class="md-ellipsis">
      __call__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.GenConf.__str__" class="md-nav__link">
    <span class="md-ellipsis">
      __str__
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.JSchemaConf" class="md-nav__link">
    <span class="md-ellipsis">
      JSchemaConf
    </span>
  </a>
  
    <nav class="md-nav" aria-label="JSchemaConf">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sibila.JSchemaConf.resolve_refs" class="md-nav__link">
    <span class="md-ellipsis">
      resolve_refs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.JSchemaConf.collapse_single_combines" class="md-nav__link">
    <span class="md-ellipsis">
      collapse_single_combines
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.JSchemaConf.description_from_title" class="md-nav__link">
    <span class="md-ellipsis">
      description_from_title
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.JSchemaConf.force_all_required" class="md-nav__link">
    <span class="md-ellipsis">
      force_all_required
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.JSchemaConf.remove_with_default" class="md-nav__link">
    <span class="md-ellipsis">
      remove_with_default
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.JSchemaConf.default_to_last" class="md-nav__link">
    <span class="md-ellipsis">
      default_to_last
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.JSchemaConf.additional_allowed_root_keys" class="md-nav__link">
    <span class="md-ellipsis">
      additional_allowed_root_keys
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.JSchemaConf.pydantic_strict_validation" class="md-nav__link">
    <span class="md-ellipsis">
      pydantic_strict_validation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#generation-results-and-errors" class="md-nav__link">
    <span class="md-ellipsis">
      Generation Results and Errors
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Generation Results and Errors">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sibila.GenRes" class="md-nav__link">
    <span class="md-ellipsis">
      GenRes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="GenRes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sibila.GenRes.OK_STOP" class="md-nav__link">
    <span class="md-ellipsis">
      OK_STOP
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.GenRes.OK_LENGTH" class="md-nav__link">
    <span class="md-ellipsis">
      OK_LENGTH
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.GenRes.ERROR_JSON" class="md-nav__link">
    <span class="md-ellipsis">
      ERROR_JSON
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.GenRes.ERROR_JSON_SCHEMA_VAL" class="md-nav__link">
    <span class="md-ellipsis">
      ERROR_JSON_SCHEMA_VAL
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.GenRes.ERROR_JSON_SCHEMA_ERROR" class="md-nav__link">
    <span class="md-ellipsis">
      ERROR_JSON_SCHEMA_ERROR
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.GenRes.ERROR_MODEL" class="md-nav__link">
    <span class="md-ellipsis">
      ERROR_MODEL
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.GenRes.from_finish_reason" class="md-nav__link">
    <span class="md-ellipsis">
      from_finish_reason
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.GenRes.as_text" class="md-nav__link">
    <span class="md-ellipsis">
      as_text
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.GenError" class="md-nav__link">
    <span class="md-ellipsis">
      GenError
    </span>
  </a>
  
    <nav class="md-nav" aria-label="GenError">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sibila.GenError.raise_if_error" class="md-nav__link">
    <span class="md-ellipsis">
      raise_if_error
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.GenOut" class="md-nav__link">
    <span class="md-ellipsis">
      GenOut
    </span>
  </a>
  
    <nav class="md-nav" aria-label="GenOut">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sibila.GenOut.res" class="md-nav__link">
    <span class="md-ellipsis">
      res
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.GenOut.text" class="md-nav__link">
    <span class="md-ellipsis">
      text
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.GenOut.dic" class="md-nav__link">
    <span class="md-ellipsis">
      dic
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.GenOut.obj" class="md-nav__link">
    <span class="md-ellipsis">
      obj
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.GenOut.asdict" class="md-nav__link">
    <span class="md-ellipsis">
      asdict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.GenOut.__str__" class="md-nav__link">
    <span class="md-ellipsis">
      __str__
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#directories" class="md-nav__link">
    <span class="md-ellipsis">
      Directories
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Directories">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sibila.ModelDir" class="md-nav__link">
    <span class="md-ellipsis">
      ModelDir
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ModelDir">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sibila.ModelDir.add" class="md-nav__link">
    <span class="md-ellipsis">
      add
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.ModelDir.add_model" class="md-nav__link">
    <span class="md-ellipsis">
      add_model
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.ModelDir.add_search_path" class="md-nav__link">
    <span class="md-ellipsis">
      add_search_path
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.ModelDir.set_genconf" class="md-nav__link">
    <span class="md-ellipsis">
      set_genconf
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.ModelDir.create" class="md-nav__link">
    <span class="md-ellipsis">
      create
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.ModelDir.clear" class="md-nav__link">
    <span class="md-ellipsis">
      clear
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.FormatDir" class="md-nav__link">
    <span class="md-ellipsis">
      FormatDir
    </span>
  </a>
  
    <nav class="md-nav" aria-label="FormatDir">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sibila.FormatDir.add" class="md-nav__link">
    <span class="md-ellipsis">
      add
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.FormatDir.get" class="md-nav__link">
    <span class="md-ellipsis">
      get
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.FormatDir.search" class="md-nav__link">
    <span class="md-ellipsis">
      search
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.FormatDir.info" class="md-nav__link">
    <span class="md-ellipsis">
      info
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.FormatDir.clear" class="md-nav__link">
    <span class="md-ellipsis">
      clear
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#multigen" class="md-nav__link">
    <span class="md-ellipsis">
      Multigen
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Multigen">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sibila.multigen" class="md-nav__link">
    <span class="md-ellipsis">
      multigen
    </span>
  </a>
  
    <nav class="md-nav" aria-label="multigen">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sibila.multigen.thread_multigen" class="md-nav__link">
    <span class="md-ellipsis">
      thread_multigen
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.multigen.query_multigen" class="md-nav__link">
    <span class="md-ellipsis">
      query_multigen
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.multigen.multigen" class="md-nav__link">
    <span class="md-ellipsis">
      multigen
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.multigen.cycle_gen_print" class="md-nav__link">
    <span class="md-ellipsis">
      cycle_gen_print
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tools" class="md-nav__link">
    <span class="md-ellipsis">
      Tools
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Tools">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sibila.tools" class="md-nav__link">
    <span class="md-ellipsis">
      tools
    </span>
  </a>
  
    <nav class="md-nav" aria-label="tools">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sibila.tools.interact" class="md-nav__link">
    <span class="md-ellipsis">
      interact
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.tools.loop" class="md-nav__link">
    <span class="md-ellipsis">
      loop
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.tools.recursive_summarize" class="md-nav__link">
    <span class="md-ellipsis">
      recursive_summarize
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dictype" class="md-nav__link">
    <span class="md-ellipsis">
      Dictype
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Dictype">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sibila.dictype" class="md-nav__link">
    <span class="md-ellipsis">
      dictype
    </span>
  </a>
  
    <nav class="md-nav" aria-label="dictype">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sibila.dictype--allowed-types" class="md-nav__link">
    <span class="md-ellipsis">
      Allowed types
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.dictype--alternative-shorter-notation" class="md-nav__link">
    <span class="md-ellipsis">
      Alternative shorter notation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.dictype.json_schema_from_dictype" class="md-nav__link">
    <span class="md-ellipsis">
      json_schema_from_dictype
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tokenizers" class="md-nav__link">
    <span class="md-ellipsis">
      Tokenizers
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Tokenizers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sibila.LlamaCppTokenizer" class="md-nav__link">
    <span class="md-ellipsis">
      LlamaCppTokenizer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="LlamaCppTokenizer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sibila.LlamaCppTokenizer.encode" class="md-nav__link">
    <span class="md-ellipsis">
      encode
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.LlamaCppTokenizer.decode" class="md-nav__link">
    <span class="md-ellipsis">
      decode
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.LlamaCppTokenizer.token_len" class="md-nav__link">
    <span class="md-ellipsis">
      token_len
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.OpenAITokenizer" class="md-nav__link">
    <span class="md-ellipsis">
      OpenAITokenizer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="OpenAITokenizer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sibila.OpenAITokenizer.encode" class="md-nav__link">
    <span class="md-ellipsis">
      encode
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.OpenAITokenizer.decode" class="md-nav__link">
    <span class="md-ellipsis">
      decode
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.OpenAITokenizer.token_len" class="md-nav__link">
    <span class="md-ellipsis">
      token_len
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#models" class="md-nav__link">
    <span class="md-ellipsis">
      Models
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Models">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sibila.LlamaCppModel" class="md-nav__link">
    <span class="md-ellipsis">
      LlamaCppModel
    </span>
  </a>
  
    <nav class="md-nav" aria-label="LlamaCppModel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sibila.LlamaCppModel.gen" class="md-nav__link">
    <span class="md-ellipsis">
      gen
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.LlamaCppModel.json" class="md-nav__link">
    <span class="md-ellipsis">
      json
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.LlamaCppModel.dictype" class="md-nav__link">
    <span class="md-ellipsis">
      dictype
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.LlamaCppModel.pydantic" class="md-nav__link">
    <span class="md-ellipsis">
      pydantic
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.LlamaCppModel.gen_" class="md-nav__link">
    <span class="md-ellipsis">
      gen_
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.LlamaCppModel.json_" class="md-nav__link">
    <span class="md-ellipsis">
      json_
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.LlamaCppModel.dictype_" class="md-nav__link">
    <span class="md-ellipsis">
      dictype_
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.LlamaCppModel.pydantic_" class="md-nav__link">
    <span class="md-ellipsis">
      pydantic_
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.LlamaCppModel.token_len" class="md-nav__link">
    <span class="md-ellipsis">
      token_len
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.LlamaCppModel.tokenizer" class="md-nav__link">
    <span class="md-ellipsis">
      tokenizer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.LlamaCppModel.ctx_len" class="md-nav__link">
    <span class="md-ellipsis">
      ctx_len
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.LlamaCppModel.desc" class="md-nav__link">
    <span class="md-ellipsis">
      desc
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.LlamaCppModel.n_embd" class="md-nav__link">
    <span class="md-ellipsis">
      n_embd
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.LlamaCppModel.n_params" class="md-nav__link">
    <span class="md-ellipsis">
      n_params
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.LlamaCppModel.get_metadata" class="md-nav__link">
    <span class="md-ellipsis">
      get_metadata
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.OpenAIModel" class="md-nav__link">
    <span class="md-ellipsis">
      OpenAIModel
    </span>
  </a>
  
    <nav class="md-nav" aria-label="OpenAIModel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sibila.OpenAIModel.gen" class="md-nav__link">
    <span class="md-ellipsis">
      gen
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.OpenAIModel.json" class="md-nav__link">
    <span class="md-ellipsis">
      json
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.OpenAIModel.dictype" class="md-nav__link">
    <span class="md-ellipsis">
      dictype
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.OpenAIModel.pydantic" class="md-nav__link">
    <span class="md-ellipsis">
      pydantic
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.OpenAIModel.gen_" class="md-nav__link">
    <span class="md-ellipsis">
      gen_
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.OpenAIModel.json_" class="md-nav__link">
    <span class="md-ellipsis">
      json_
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.OpenAIModel.dictype_" class="md-nav__link">
    <span class="md-ellipsis">
      dictype_
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.OpenAIModel.pydantic_" class="md-nav__link">
    <span class="md-ellipsis">
      pydantic_
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.OpenAIModel.token_len" class="md-nav__link">
    <span class="md-ellipsis">
      token_len
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.OpenAIModel.tokenizer" class="md-nav__link">
    <span class="md-ellipsis">
      tokenizer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.OpenAIModel.ctx_len" class="md-nav__link">
    <span class="md-ellipsis">
      ctx_len
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.OpenAIModel.desc" class="md-nav__link">
    <span class="md-ellipsis">
      desc
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#messages-threads-context" class="md-nav__link">
    <span class="md-ellipsis">
      Messages, Threads, Context
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Messages, Threads, Context">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sibila.MsgKind" class="md-nav__link">
    <span class="md-ellipsis">
      MsgKind
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MsgKind">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sibila.MsgKind.IN" class="md-nav__link">
    <span class="md-ellipsis">
      IN
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.MsgKind.OUT" class="md-nav__link">
    <span class="md-ellipsis">
      OUT
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.MsgKind.INST" class="md-nav__link">
    <span class="md-ellipsis">
      INST
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.Thread" class="md-nav__link">
    <span class="md-ellipsis">
      Thread
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Thread">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sibila.Thread.clear" class="md-nav__link">
    <span class="md-ellipsis">
      clear
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.Thread.last_kind" class="md-nav__link">
    <span class="md-ellipsis">
      last_kind
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.Thread.inst" class="md-nav__link">
    <span class="md-ellipsis">
      inst
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.Thread.add" class="md-nav__link">
    <span class="md-ellipsis">
      add
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.Thread.addx" class="md-nav__link">
    <span class="md-ellipsis">
      addx
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.Thread.get_text" class="md-nav__link">
    <span class="md-ellipsis">
      get_text
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.Thread.set_text" class="md-nav__link">
    <span class="md-ellipsis">
      set_text
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.Thread.concat" class="md-nav__link">
    <span class="md-ellipsis">
      concat
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.Thread.load" class="md-nav__link">
    <span class="md-ellipsis">
      load
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.Thread.save" class="md-nav__link">
    <span class="md-ellipsis">
      save
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.Thread.msg_as_chatml" class="md-nav__link">
    <span class="md-ellipsis">
      msg_as_chatml
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.Thread.as_chatml" class="md-nav__link">
    <span class="md-ellipsis">
      as_chatml
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.Thread.has_text_lower" class="md-nav__link">
    <span class="md-ellipsis">
      has_text_lower
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.Trim" class="md-nav__link">
    <span class="md-ellipsis">
      Trim
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Trim">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sibila.Trim.NONE" class="md-nav__link">
    <span class="md-ellipsis">
      NONE
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.Trim.INST" class="md-nav__link">
    <span class="md-ellipsis">
      INST
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.Trim.IN" class="md-nav__link">
    <span class="md-ellipsis">
      IN
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.Trim.OUT" class="md-nav__link">
    <span class="md-ellipsis">
      OUT
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.Trim.KEEP_FIRST_IN" class="md-nav__link">
    <span class="md-ellipsis">
      KEEP_FIRST_IN
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.Trim.KEEP_FIRST_OUT" class="md-nav__link">
    <span class="md-ellipsis">
      KEEP_FIRST_OUT
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.Context" class="md-nav__link">
    <span class="md-ellipsis">
      Context
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Context">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sibila.Context.clear" class="md-nav__link">
    <span class="md-ellipsis">
      clear
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.Context.trim" class="md-nav__link">
    <span class="md-ellipsis">
      trim
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#generation-configs" class="md-nav__link">
    <span class="md-ellipsis">
      Generation Configs
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Generation Configs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sibila.GenConf" class="md-nav__link">
    <span class="md-ellipsis">
      GenConf
    </span>
  </a>
  
    <nav class="md-nav" aria-label="GenConf">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sibila.GenConf.max_tokens" class="md-nav__link">
    <span class="md-ellipsis">
      max_tokens
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.GenConf.stop" class="md-nav__link">
    <span class="md-ellipsis">
      stop
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.GenConf.temperature" class="md-nav__link">
    <span class="md-ellipsis">
      temperature
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.GenConf.top_p" class="md-nav__link">
    <span class="md-ellipsis">
      top_p
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.GenConf.format" class="md-nav__link">
    <span class="md-ellipsis">
      format
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.GenConf.json_schema" class="md-nav__link">
    <span class="md-ellipsis">
      json_schema
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.GenConf.asdict" class="md-nav__link">
    <span class="md-ellipsis">
      asdict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.GenConf.clone" class="md-nav__link">
    <span class="md-ellipsis">
      clone
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.GenConf.__call__" class="md-nav__link">
    <span class="md-ellipsis">
      __call__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.GenConf.__str__" class="md-nav__link">
    <span class="md-ellipsis">
      __str__
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.JSchemaConf" class="md-nav__link">
    <span class="md-ellipsis">
      JSchemaConf
    </span>
  </a>
  
    <nav class="md-nav" aria-label="JSchemaConf">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sibila.JSchemaConf.resolve_refs" class="md-nav__link">
    <span class="md-ellipsis">
      resolve_refs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.JSchemaConf.collapse_single_combines" class="md-nav__link">
    <span class="md-ellipsis">
      collapse_single_combines
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.JSchemaConf.description_from_title" class="md-nav__link">
    <span class="md-ellipsis">
      description_from_title
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.JSchemaConf.force_all_required" class="md-nav__link">
    <span class="md-ellipsis">
      force_all_required
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.JSchemaConf.remove_with_default" class="md-nav__link">
    <span class="md-ellipsis">
      remove_with_default
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.JSchemaConf.default_to_last" class="md-nav__link">
    <span class="md-ellipsis">
      default_to_last
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.JSchemaConf.additional_allowed_root_keys" class="md-nav__link">
    <span class="md-ellipsis">
      additional_allowed_root_keys
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.JSchemaConf.pydantic_strict_validation" class="md-nav__link">
    <span class="md-ellipsis">
      pydantic_strict_validation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#generation-results-and-errors" class="md-nav__link">
    <span class="md-ellipsis">
      Generation Results and Errors
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Generation Results and Errors">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sibila.GenRes" class="md-nav__link">
    <span class="md-ellipsis">
      GenRes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="GenRes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sibila.GenRes.OK_STOP" class="md-nav__link">
    <span class="md-ellipsis">
      OK_STOP
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.GenRes.OK_LENGTH" class="md-nav__link">
    <span class="md-ellipsis">
      OK_LENGTH
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.GenRes.ERROR_JSON" class="md-nav__link">
    <span class="md-ellipsis">
      ERROR_JSON
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.GenRes.ERROR_JSON_SCHEMA_VAL" class="md-nav__link">
    <span class="md-ellipsis">
      ERROR_JSON_SCHEMA_VAL
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.GenRes.ERROR_JSON_SCHEMA_ERROR" class="md-nav__link">
    <span class="md-ellipsis">
      ERROR_JSON_SCHEMA_ERROR
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.GenRes.ERROR_MODEL" class="md-nav__link">
    <span class="md-ellipsis">
      ERROR_MODEL
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.GenRes.from_finish_reason" class="md-nav__link">
    <span class="md-ellipsis">
      from_finish_reason
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.GenRes.as_text" class="md-nav__link">
    <span class="md-ellipsis">
      as_text
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.GenError" class="md-nav__link">
    <span class="md-ellipsis">
      GenError
    </span>
  </a>
  
    <nav class="md-nav" aria-label="GenError">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sibila.GenError.raise_if_error" class="md-nav__link">
    <span class="md-ellipsis">
      raise_if_error
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.GenOut" class="md-nav__link">
    <span class="md-ellipsis">
      GenOut
    </span>
  </a>
  
    <nav class="md-nav" aria-label="GenOut">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sibila.GenOut.res" class="md-nav__link">
    <span class="md-ellipsis">
      res
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.GenOut.text" class="md-nav__link">
    <span class="md-ellipsis">
      text
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.GenOut.dic" class="md-nav__link">
    <span class="md-ellipsis">
      dic
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.GenOut.obj" class="md-nav__link">
    <span class="md-ellipsis">
      obj
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.GenOut.asdict" class="md-nav__link">
    <span class="md-ellipsis">
      asdict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.GenOut.__str__" class="md-nav__link">
    <span class="md-ellipsis">
      __str__
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#directories" class="md-nav__link">
    <span class="md-ellipsis">
      Directories
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Directories">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sibila.ModelDir" class="md-nav__link">
    <span class="md-ellipsis">
      ModelDir
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ModelDir">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sibila.ModelDir.add" class="md-nav__link">
    <span class="md-ellipsis">
      add
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.ModelDir.add_model" class="md-nav__link">
    <span class="md-ellipsis">
      add_model
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.ModelDir.add_search_path" class="md-nav__link">
    <span class="md-ellipsis">
      add_search_path
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.ModelDir.set_genconf" class="md-nav__link">
    <span class="md-ellipsis">
      set_genconf
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.ModelDir.create" class="md-nav__link">
    <span class="md-ellipsis">
      create
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.ModelDir.clear" class="md-nav__link">
    <span class="md-ellipsis">
      clear
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.FormatDir" class="md-nav__link">
    <span class="md-ellipsis">
      FormatDir
    </span>
  </a>
  
    <nav class="md-nav" aria-label="FormatDir">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sibila.FormatDir.add" class="md-nav__link">
    <span class="md-ellipsis">
      add
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.FormatDir.get" class="md-nav__link">
    <span class="md-ellipsis">
      get
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.FormatDir.search" class="md-nav__link">
    <span class="md-ellipsis">
      search
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.FormatDir.info" class="md-nav__link">
    <span class="md-ellipsis">
      info
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.FormatDir.clear" class="md-nav__link">
    <span class="md-ellipsis">
      clear
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#multigen" class="md-nav__link">
    <span class="md-ellipsis">
      Multigen
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Multigen">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sibila.multigen" class="md-nav__link">
    <span class="md-ellipsis">
      multigen
    </span>
  </a>
  
    <nav class="md-nav" aria-label="multigen">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sibila.multigen.thread_multigen" class="md-nav__link">
    <span class="md-ellipsis">
      thread_multigen
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.multigen.query_multigen" class="md-nav__link">
    <span class="md-ellipsis">
      query_multigen
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.multigen.multigen" class="md-nav__link">
    <span class="md-ellipsis">
      multigen
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.multigen.cycle_gen_print" class="md-nav__link">
    <span class="md-ellipsis">
      cycle_gen_print
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tools" class="md-nav__link">
    <span class="md-ellipsis">
      Tools
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Tools">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sibila.tools" class="md-nav__link">
    <span class="md-ellipsis">
      tools
    </span>
  </a>
  
    <nav class="md-nav" aria-label="tools">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sibila.tools.interact" class="md-nav__link">
    <span class="md-ellipsis">
      interact
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.tools.loop" class="md-nav__link">
    <span class="md-ellipsis">
      loop
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.tools.recursive_summarize" class="md-nav__link">
    <span class="md-ellipsis">
      recursive_summarize
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dictype" class="md-nav__link">
    <span class="md-ellipsis">
      Dictype
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Dictype">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sibila.dictype" class="md-nav__link">
    <span class="md-ellipsis">
      dictype
    </span>
  </a>
  
    <nav class="md-nav" aria-label="dictype">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sibila.dictype--allowed-types" class="md-nav__link">
    <span class="md-ellipsis">
      Allowed types
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.dictype--alternative-shorter-notation" class="md-nav__link">
    <span class="md-ellipsis">
      Alternative shorter notation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.dictype.json_schema_from_dictype" class="md-nav__link">
    <span class="md-ellipsis">
      json_schema_from_dictype
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tokenizers" class="md-nav__link">
    <span class="md-ellipsis">
      Tokenizers
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Tokenizers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sibila.LlamaCppTokenizer" class="md-nav__link">
    <span class="md-ellipsis">
      LlamaCppTokenizer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="LlamaCppTokenizer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sibila.LlamaCppTokenizer.encode" class="md-nav__link">
    <span class="md-ellipsis">
      encode
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.LlamaCppTokenizer.decode" class="md-nav__link">
    <span class="md-ellipsis">
      decode
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.LlamaCppTokenizer.token_len" class="md-nav__link">
    <span class="md-ellipsis">
      token_len
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.OpenAITokenizer" class="md-nav__link">
    <span class="md-ellipsis">
      OpenAITokenizer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="OpenAITokenizer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sibila.OpenAITokenizer.encode" class="md-nav__link">
    <span class="md-ellipsis">
      encode
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.OpenAITokenizer.decode" class="md-nav__link">
    <span class="md-ellipsis">
      decode
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sibila.OpenAITokenizer.token_len" class="md-nav__link">
    <span class="md-ellipsis">
      token_len
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  <h1>API Reference</h1>

<h2 id="models">Models</h2>


<div class="doc doc-object doc-class">



<h3 id="sibila.LlamaCppModel" class="doc doc-heading">
          <span class="doc doc-object-name doc-class-name">LlamaCppModel</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">LlamaCppModel</span><span class="p">(</span>
    <span class="n">path</span><span class="p">,</span>
    <span class="nb">format</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">format_search_order</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;meta_template&quot;</span><span class="p">],</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">genconf</span><span class="o">=</span><span class="n">GenConf</span><span class="p">(),</span>
    <span class="n">tokenizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">ctx_len</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span>
    <span class="n">n_gpu_layers</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">main_gpu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">n_batch</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span>
    <span class="n">seed</span><span class="o">=</span><span class="mi">4294967295</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="o">**</span><span class="n">llamacpp_kwargs</span>
<span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents first">

  
      <p>Use local GGUF format models via llama.cpp engine.</p>
<p>Supports grammar-constrained JSON output, possibly following a JSON schema.</p>
  



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>path</code></td>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>File path to the GGUF file.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>format</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a>, None]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Chat template format to use with model. Leave as None for auto-detection.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>format_search_order</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Search order for auto-detecting format, "name" searches in the filename, "meta_template" looks in the model's metadata. Defaults to ["name","meta_template"].</p>
            </div>
          </td>
          <td>
                <code>[&#39;name&#39;, &#39;meta_template&#39;]</code>
          </td>
        </tr>
        <tr>
          <td><code>genconf</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-internal" title="sibila.gen.GenConf" href="#sibila.GenConf">GenConf</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Default generation configuration, which can be used in gen() and related. Defaults to GenConf().</p>
            </div>
          </td>
          <td>
                <code><a class="autorefs autorefs-internal" title="sibila.gen.GenConf" href="#sibila.GenConf">GenConf</a>()</code>
          </td>
        </tr>
        <tr>
          <td><code>tokenizer</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<span title="sibila.model.Tokenizer">Tokenizer</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>An external initialized tokenizer to use instead of the created from the GGUF file. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>ctx_len</code></td>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Maximum context length to be used (shared for input and output). Defaults to 2048.</p>
            </div>
          </td>
          <td>
                <code>2048</code>
          </td>
        </tr>
        <tr>
          <td><code>n_gpu_layers</code></td>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Number of model layers to run in a GPU. Defaults to -1 for all.</p>
            </div>
          </td>
          <td>
                <code>-1</code>
          </td>
        </tr>
        <tr>
          <td><code>main_gpu</code></td>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Index of the GPU to use. Defaults to 0.</p>
            </div>
          </td>
          <td>
                <code>0</code>
          </td>
        </tr>
        <tr>
          <td><code>n_batch</code></td>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Prompt processing batch size. Defaults to 512.</p>
            </div>
          </td>
          <td>
                <code>512</code>
          </td>
        </tr>
        <tr>
          <td><code>seed</code></td>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Random number generation seed, for non zero temperature inference. Defaults to 4294967295.</p>
            </div>
          </td>
          <td>
                <code>4294967295</code>
          </td>
        </tr>
        <tr>
          <td><code>verbose</code></td>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Emit (very) verbose output. Defaults to False.</p>
            </div>
          </td>
          <td>
                <code>False</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Raises:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#ImportError">ImportError</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>If llama-cpp-python is not installed.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#ValueError">ValueError</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>If ctx_len is 0 or larger than the values supported by model.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

                <details class="quote">
                  <summary>Source code in <code>sibila/llamacpp.py</code></summary>
                  <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
             <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>

             <span class="nb">format</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">dict</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>                 
             <span class="n">format_search_order</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span><span class="s2">&quot;meta_template&quot;</span><span class="p">],</span>

             <span class="o">*</span><span class="p">,</span>

             <span class="c1"># common base model args</span>
             <span class="n">genconf</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GenConf</span><span class="p">]</span> <span class="o">=</span> <span class="n">GenConf</span><span class="p">(),</span>
             <span class="n">tokenizer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tokenizer</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">ctx_len</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">,</span>

             <span class="c1"># important LlamaCpp-specific args</span>
             <span class="n">n_gpu_layers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
             <span class="n">main_gpu</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
             <span class="n">n_batch</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span>
             <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4294967295</span><span class="p">,</span>
             <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>

             <span class="c1"># other LlamaCpp-specific args</span>
             <span class="o">**</span><span class="n">llamacpp_kwargs</span>
             <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        path: File path to the GGUF file.</span>
<span class="sd">        format: Chat template format to use with model. Leave as None for auto-detection.</span>
<span class="sd">        format_search_order: Search order for auto-detecting format, &quot;name&quot; searches in the filename, &quot;meta_template&quot; looks in the model&#39;s metadata. Defaults to [&quot;name&quot;,&quot;meta_template&quot;].</span>
<span class="sd">        genconf: Default generation configuration, which can be used in gen() and related. Defaults to GenConf().</span>
<span class="sd">        tokenizer: An external initialized tokenizer to use instead of the created from the GGUF file. Defaults to None.</span>
<span class="sd">        ctx_len: Maximum context length to be used (shared for input and output). Defaults to 2048.</span>
<span class="sd">        n_gpu_layers: Number of model layers to run in a GPU. Defaults to -1 for all.</span>
<span class="sd">        main_gpu: Index of the GPU to use. Defaults to 0.</span>
<span class="sd">        n_batch: Prompt processing batch size. Defaults to 512.</span>
<span class="sd">        seed: Random number generation seed, for non zero temperature inference. Defaults to 4294967295.</span>
<span class="sd">        verbose: Emit (very) verbose output. Defaults to False.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ImportError: If llama-cpp-python is not installed.</span>
<span class="sd">        ValueError: If ctx_len is 0 or larger than the values supported by model.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_llama</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">has_llama_cpp</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;Please install llama-cpp-python by running: pip install llama-cpp-python&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ctx_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;LlamaCppModel doesn&#39;t support ctx_len=0&quot;</span><span class="p">)</span>

    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span>
                     <span class="n">genconf</span><span class="p">,</span>
                     <span class="n">tokenizer</span>
                     <span class="p">)</span>

    <span class="c1"># update kwargs from important args</span>
    <span class="n">llamacpp_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">n_ctx</span><span class="o">=</span><span class="n">ctx_len</span><span class="p">,</span>
                           <span class="n">n_batch</span><span class="o">=</span><span class="n">n_batch</span><span class="p">,</span>
                           <span class="n">n_gpu_layers</span><span class="o">=</span><span class="n">n_gpu_layers</span><span class="p">,</span>
                           <span class="n">main_gpu</span><span class="o">=</span><span class="n">main_gpu</span><span class="p">,</span>
                           <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span>
                           <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
                           <span class="p">)</span>

    <span class="k">with</span> <span class="n">normalize_notebook_stdout_stderr</span><span class="p">(</span><span class="ow">not</span> <span class="n">verbose</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_llama</span> <span class="o">=</span> <span class="n">Llama</span><span class="p">(</span><span class="n">model_path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">llamacpp_kwargs</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_model_path</span> <span class="o">=</span> <span class="n">path</span>

    <span class="c1"># correct super __init__ values</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_ctx_len</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_llama</span><span class="o">.</span><span class="n">n_ctx</span><span class="p">()</span>

    <span class="n">n_ctx_train</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_llama</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">n_ctx_train</span><span class="p">()</span>        
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctx_len</span> <span class="o">&gt;</span> <span class="n">n_ctx_train</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ctx_len (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ctx_len</span><span class="si">}</span><span class="s2">) is greater than n_ctx_train (</span><span class="si">{</span><span class="n">n_ctx_train</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>


    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">LlamaCppTokenizer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_llama</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_format</span><span class="p">(</span><span class="nb">format</span><span class="p">,</span>
                         <span class="n">format_search_order</span><span class="p">,</span>
                         <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_path</span><span class="p">),</span>
                          <span class="s2">&quot;meta_template_name&quot;</span><span class="p">:</span> <span class="s2">&quot;tokenizer.chat_template&quot;</span><span class="p">}</span>
                         <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_llama</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_llama</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">raise</span> <span class="n">e</span>
</code></pre></div></td></tr></table></div>
                </details>

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">



<h4 id="sibila.LlamaCppModel.gen" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">gen</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">gen</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="n">genconf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ok_length_is_error</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Text generation from a Thread, used by the other model generation methods.
Like the gen_() method but will raise a GenError exception if an error occurs.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>thread</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="sibila.thread.Thread" href="#sibila.Thread">Thread</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The Thread to use as model input.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>genconf</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-internal" title="sibila.gen.GenConf" href="#sibila.GenConf">GenConf</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Model generation configuration. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>ok_length_is_error</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Should a result of GenRes.OK_LENGTH be considered an error and raise?</p>
            </div>
          </td>
          <td>
                <code>False</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Raises:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-internal" title="sibila.gen.GenError" href="#sibila.GenError">GenError</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>If an error occurred. This can be a model error, or an invalid JSON output error.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Text generated by model.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>sibila/model.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">gen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">thread</span><span class="p">:</span> <span class="n">Thread</span><span class="p">,</span>
        <span class="n">genconf</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GenConf</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ok_length_is_error</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Text generation from a Thread, used by the other model generation methods.</span>
<span class="sd">    Like the gen_() method but will raise a GenError exception if an error occurs.</span>

<span class="sd">    Args:</span>
<span class="sd">        thread: The Thread to use as model input.</span>
<span class="sd">        genconf: Model generation configuration. Defaults to None.</span>
<span class="sd">        ok_length_is_error: Should a result of GenRes.OK_LENGTH be considered an error and raise?</span>

<span class="sd">    Raises:</span>
<span class="sd">        GenError: If an error occurred. This can be a model error, or an invalid JSON output error.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Text generated by model.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> 
                    <span class="n">genconf</span><span class="p">)</span>

    <span class="n">GenError</span><span class="o">.</span><span class="n">raise_if_error</span><span class="p">(</span><span class="n">out</span><span class="p">,</span>
                            <span class="n">ok_length_is_error</span><span class="o">=</span><span class="n">ok_length_is_error</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">out</span><span class="o">.</span><span class="n">text</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>







<div class="doc doc-object doc-function">



<h4 id="sibila.LlamaCppModel.json" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">json</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">json</span><span class="p">(</span>
    <span class="n">thread</span><span class="p">,</span>
    <span class="n">genconf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">json_schema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">massage_schema</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">schemaconf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>JSON/JSON-schema grammar-constrained generation, returning a Python dict of values, constrained or not by a JSON schema.
Raises GenError if unable to get a valid/schema-validated JSON.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>thread</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="sibila.thread.Thread" href="#sibila.Thread">Thread</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The Thread to use as model input.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>genconf</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-internal" title="sibila.gen.GenConf" href="#sibila.GenConf">GenConf</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Model generation configuration. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>json_schema</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>An optional JSON schema describing the dict fields that will be output. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>massage_schema</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Simplify schema. Defaults to True.</p>
            </div>
          </td>
          <td>
                <code>True</code>
          </td>
        </tr>
        <tr>
          <td><code>schemaconf</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-internal" title="sibila.json_utils.JSchemaConf" href="#sibila.JSchemaConf">JSchemaConf</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>JSchemaConf object that controls schema simplification. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Raises:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-internal" title="sibila.gen.GenError" href="#sibila.GenError">GenError</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>If an error occurred, for example an invalid JSON schema output error. See GenError.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A dict from model's JSON response, following genconf.jsonschema, if provided.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>sibila/model.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>

         <span class="n">thread</span><span class="p">:</span> <span class="n">Thread</span><span class="p">,</span>
         <span class="n">genconf</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GenConf</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>

         <span class="n">json_schema</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>

         <span class="n">massage_schema</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
         <span class="n">schemaconf</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">JSchemaConf</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
         <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;JSON/JSON-schema grammar-constrained generation, returning a Python dict of values, constrained or not by a JSON schema.</span>
<span class="sd">    Raises GenError if unable to get a valid/schema-validated JSON.</span>

<span class="sd">    Args:</span>
<span class="sd">        thread: The Thread to use as model input.</span>
<span class="sd">        genconf: Model generation configuration. Defaults to None.</span>
<span class="sd">        json_schema: An optional JSON schema describing the dict fields that will be output. Defaults to None.</span>
<span class="sd">        massage_schema: Simplify schema. Defaults to True.</span>
<span class="sd">        schemaconf: JSchemaConf object that controls schema simplification. Defaults to None.</span>

<span class="sd">    Raises:</span>
<span class="sd">        GenError: If an error occurred, for example an invalid JSON schema output error. See GenError.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A dict from model&#39;s JSON response, following genconf.jsonschema, if provided.</span>
<span class="sd">    &quot;&quot;&quot;</span>        
    <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">json_</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span>
                     <span class="n">genconf</span><span class="p">,</span>

                     <span class="n">json_schema</span><span class="p">,</span>
                     <span class="n">massage_schema</span><span class="p">,</span>
                     <span class="n">schemaconf</span><span class="p">)</span>

    <span class="n">GenError</span><span class="o">.</span><span class="n">raise_if_error</span><span class="p">(</span><span class="n">out</span><span class="p">,</span>
                            <span class="n">ok_length_is_error</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># as valid JSON can still be produced</span>

    <span class="k">return</span> <span class="n">out</span><span class="o">.</span><span class="n">dic</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>







<div class="doc doc-object doc-function">



<h4 id="sibila.LlamaCppModel.dictype" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">dictype</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">dictype</span><span class="p">(</span><span class="n">dictype</span><span class="p">,</span> <span class="n">thread</span><span class="p">,</span> <span class="n">genconf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">schemaconf</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Grammar-constrained generation after a dictype definition (see dictype.py), returning a Python dict of values, 
Raises GenError if unable to get a valid dict that follows the dictype definition.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>dictype</code></td>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p><em>description</em></p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>thread</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="sibila.thread.Thread" href="#sibila.Thread">Thread</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p><em>description</em></p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>genconf</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-internal" title="sibila.gen.GenConf" href="#sibila.GenConf">GenConf</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p><em>description</em>. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>schemaconf</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-internal" title="sibila.json_utils.JSchemaConf" href="#sibila.JSchemaConf">JSchemaConf</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p><em>description</em>. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Raises:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-internal" title="sibila.gen.GenError" href="#sibila.GenError">GenError</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>If an error occurred, for example an invalid JSON schema output error. See GenError.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A dict following the dictype definition.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>sibila/model.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">dictype</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">dictype</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
            <span class="n">thread</span><span class="p">:</span> <span class="n">Thread</span><span class="p">,</span>
            <span class="n">genconf</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GenConf</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">schemaconf</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">JSchemaConf</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Grammar-constrained generation after a dictype definition (see dictype.py), returning a Python dict of values, </span>
<span class="sd">    Raises GenError if unable to get a valid dict that follows the dictype definition.</span>

<span class="sd">    Args:</span>
<span class="sd">        dictype: _description_</span>
<span class="sd">        thread: _description_</span>
<span class="sd">        genconf: _description_. Defaults to None.</span>
<span class="sd">        schemaconf: _description_. Defaults to None.</span>

<span class="sd">    Raises:</span>
<span class="sd">        GenError: If an error occurred, for example an invalid JSON schema output error. See GenError.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A dict following the dictype definition.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictype_</span><span class="p">(</span><span class="n">dictype</span><span class="p">,</span>
                        <span class="n">thread</span><span class="p">,</span>
                        <span class="n">genconf</span><span class="p">,</span>
                        <span class="n">schemaconf</span><span class="p">)</span>

    <span class="n">GenError</span><span class="o">.</span><span class="n">raise_if_error</span><span class="p">(</span><span class="n">out</span><span class="p">,</span>
                            <span class="n">ok_length_is_error</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># as valid JSON can still be produced</span>

    <span class="k">return</span> <span class="n">out</span><span class="o">.</span><span class="n">dic</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>







<div class="doc doc-object doc-function">



<h4 id="sibila.LlamaCppModel.pydantic" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">pydantic</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">pydantic</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">thread</span><span class="p">,</span> <span class="n">genconf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">schemaconf</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Grammar-constrained generation after a Pydantic BaseModel-derived class definition.
An initialized Pydantic BaseModel object is returned in the "obj" field of return dict.
Raises GenError if unable to get a valid dict that follows the BaseModel class definition.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>cls</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A class derived from a Pydantic BaseModel class.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>thread</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="sibila.thread.Thread" href="#sibila.Thread">Thread</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The Thread to use as model input.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>genconf</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-internal" title="sibila.gen.GenConf" href="#sibila.GenConf">GenConf</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Model generation configuration. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>schemaconf</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-internal" title="sibila.json_utils.JSchemaConf" href="#sibila.JSchemaConf">JSchemaConf</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>JSchemaConf object that controls schema simplification. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Raises:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-internal" title="sibila.gen.GenError" href="#sibila.GenError">GenError</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>If an error occurred, for example an invalid BaseModel object. See GenError.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A Pydantic object of class cls (derived from BaseModel) initialized from the constrained JSON output.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>sibila/model.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">pydantic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
             <span class="bp">cls</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="c1"># a Pydantic BaseModel class</span>
             <span class="n">thread</span><span class="p">:</span> <span class="n">Thread</span><span class="p">,</span>
             <span class="n">genconf</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GenConf</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">schemaconf</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">JSchemaConf</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
             <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span> <span class="c1"># a Pydantic BaseModel object</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Grammar-constrained generation after a Pydantic BaseModel-derived class definition.</span>
<span class="sd">    An initialized Pydantic BaseModel object is returned in the &quot;obj&quot; field of return dict.</span>
<span class="sd">    Raises GenError if unable to get a valid dict that follows the BaseModel class definition.</span>

<span class="sd">    Args:</span>
<span class="sd">        cls: A class derived from a Pydantic BaseModel class.</span>
<span class="sd">        thread: The Thread to use as model input.</span>
<span class="sd">        genconf: Model generation configuration. Defaults to None.</span>
<span class="sd">        schemaconf: JSchemaConf object that controls schema simplification. Defaults to None.</span>

<span class="sd">    Raises:</span>
<span class="sd">        GenError: If an error occurred, for example an invalid BaseModel object. See GenError.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A Pydantic object of class cls (derived from BaseModel) initialized from the constrained JSON output.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pydantic_</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span>
                         <span class="n">thread</span><span class="p">,</span>
                         <span class="n">genconf</span><span class="p">,</span>
                         <span class="n">schemaconf</span><span class="p">)</span>

    <span class="n">GenError</span><span class="o">.</span><span class="n">raise_if_error</span><span class="p">(</span><span class="n">out</span><span class="p">,</span>
                            <span class="n">ok_length_is_error</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># as valid JSON can still be produced</span>

    <span class="k">return</span> <span class="n">out</span><span class="o">.</span><span class="n">obj</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>







<div class="doc doc-object doc-function">



<h4 id="sibila.LlamaCppModel.gen_" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">gen_</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">gen_</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="n">genconf</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Text generation from a Thread, used by the other model generation methods.
Doesn't raise an exception if an error occurs, always returns a result dict.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>thread</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="sibila.thread.Thread" href="#sibila.Thread">Thread</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The Thread object to use as model input.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>genconf</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-internal" title="sibila.gen.GenConf" href="#sibila.GenConf">GenConf</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Model generation configuration. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-internal" title="sibila.gen.GenOut" href="#sibila.GenOut">GenOut</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A GenOut object with result, generated text, etc.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>sibila/model.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span>
<span class="normal">934</span>
<span class="normal">935</span>
<span class="normal">936</span>
<span class="normal">937</span>
<span class="normal">938</span>
<span class="normal">939</span>
<span class="normal">940</span>
<span class="normal">941</span>
<span class="normal">942</span>
<span class="normal">943</span>
<span class="normal">944</span>
<span class="normal">945</span>
<span class="normal">946</span>
<span class="normal">947</span>
<span class="normal">948</span>
<span class="normal">949</span>
<span class="normal">950</span>
<span class="normal">951</span>
<span class="normal">952</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">gen_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
         <span class="n">thread</span><span class="p">:</span> <span class="n">Thread</span><span class="p">,</span>
         <span class="n">genconf</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GenConf</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
         <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GenOut</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Text generation from a Thread, used by the other model generation methods.</span>
<span class="sd">    Doesn&#39;t raise an exception if an error occurs, always returns a result dict.</span>

<span class="sd">    Args:</span>
<span class="sd">        thread: The Thread object to use as model input.</span>
<span class="sd">        genconf: Model generation configuration. Defaults to None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A GenOut object with result, generated text, etc. </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">genconf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">genconf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">genconf</span>

    <span class="n">thread</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_gen_in</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="n">genconf</span><span class="p">)</span>

    <span class="n">prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_from_thread</span><span class="p">(</span><span class="n">thread</span><span class="p">)</span>

    <span class="n">text</span><span class="p">,</span><span class="n">finish</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text_gen</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">genconf</span><span class="p">)</span>

    <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_gen_out</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">finish</span><span class="p">,</span> <span class="n">genconf</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">out</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>







<div class="doc doc-object doc-function">



<h4 id="sibila.LlamaCppModel.json_" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">json_</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">json_</span><span class="p">(</span>
    <span class="n">thread</span><span class="p">,</span>
    <span class="n">genconf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">json_schema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">massage_schema</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">schemaconf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>JSON/JSON-schema grammar-constrained generation, returning a Python dict of values, constrained or not by a JSON schema.
Doesn't raise an exception if an error occurs, always returns GenOut.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>thread</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="sibila.thread.Thread" href="#sibila.Thread">Thread</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The Thread to use as model input.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>genconf</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-internal" title="sibila.gen.GenConf" href="#sibila.GenConf">GenConf</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Model generation configuration. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>json_schema</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>An optional JSON schema describing the dict fields that will be output. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>massage_schema</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Simplify schema. Defaults to True.</p>
            </div>
          </td>
          <td>
                <code>True</code>
          </td>
        </tr>
        <tr>
          <td><code>schemaconf</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-internal" title="sibila.json_utils.JSchemaConf" href="#sibila.JSchemaConf">JSchemaConf</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>JSchemaConf object that controls schema simplification. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-internal" title="sibila.gen.GenOut" href="#sibila.GenOut">GenOut</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A GenOut object with result, generated text, etc. The output dict is in GenOut.dic.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>sibila/model.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">json_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>

          <span class="n">thread</span><span class="p">:</span> <span class="n">Thread</span><span class="p">,</span>
          <span class="n">genconf</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GenConf</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>

          <span class="n">json_schema</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>

          <span class="n">massage_schema</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
          <span class="n">schemaconf</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">JSchemaConf</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
          <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GenOut</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;JSON/JSON-schema grammar-constrained generation, returning a Python dict of values, constrained or not by a JSON schema.</span>
<span class="sd">    Doesn&#39;t raise an exception if an error occurs, always returns GenOut.</span>

<span class="sd">    Args:</span>
<span class="sd">        thread: The Thread to use as model input.</span>
<span class="sd">        genconf: Model generation configuration. Defaults to None.</span>
<span class="sd">        json_schema: An optional JSON schema describing the dict fields that will be output. Defaults to None.</span>
<span class="sd">        massage_schema: Simplify schema. Defaults to True.</span>
<span class="sd">        schemaconf: JSchemaConf object that controls schema simplification. Defaults to None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A GenOut object with result, generated text, etc. The output dict is in GenOut.dic.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">genconf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">genconf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">genconf</span>

    <span class="k">if</span> <span class="n">genconf</span><span class="o">.</span><span class="n">json_schema</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">json_schema</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Both json_schema and genconf.json_schema are set: using json_schema&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">json_schema</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">massage_schema</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">schemaconf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">schemaconf</span> <span class="o">=</span> <span class="n">JSchemaConf</span><span class="p">()</span>
        <span class="n">json_schema</span> <span class="o">=</span> <span class="n">json_schema_massage</span><span class="p">(</span><span class="n">json_schema</span><span class="p">,</span> <span class="n">schemaconf</span><span class="p">)</span>

    <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> 
                    <span class="n">genconf</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s2">&quot;json&quot;</span><span class="p">,</span> 
                            <span class="n">json_schema</span><span class="o">=</span><span class="n">json_schema</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">out</span>        
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>







<div class="doc doc-object doc-function">



<h4 id="sibila.LlamaCppModel.dictype_" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">dictype_</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">dictype_</span><span class="p">(</span><span class="n">dictype</span><span class="p">,</span> <span class="n">thread</span><span class="p">,</span> <span class="n">genconf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">schemaconf</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Grammar-constrained generation after a dictype definition (see dictype.py), returning a Python dict of values, 
Doesn't raise an exception if an error occurs, always returns GenOut.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>dictype</code></td>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A dictype defining the layout of the returned dict.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>thread</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="sibila.thread.Thread" href="#sibila.Thread">Thread</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The Thread to use as model input.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>genconf</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-internal" title="sibila.gen.GenConf" href="#sibila.GenConf">GenConf</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Model generation configuration. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>schemaconf</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-internal" title="sibila.json_utils.JSchemaConf" href="#sibila.JSchemaConf">JSchemaConf</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>JSchemaConf object that controls schema simplification. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-internal" title="sibila.gen.GenOut" href="#sibila.GenOut">GenOut</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A GenOut object with result, generated text, etc, with the output dict in GenOut.dic.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>sibila/model.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">dictype_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
             <span class="n">dictype</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
             <span class="n">thread</span><span class="p">:</span> <span class="n">Thread</span><span class="p">,</span>
             <span class="n">genconf</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GenConf</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">schemaconf</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">JSchemaConf</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
             <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GenOut</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Grammar-constrained generation after a dictype definition (see dictype.py), returning a Python dict of values, </span>
<span class="sd">    Doesn&#39;t raise an exception if an error occurs, always returns GenOut.</span>

<span class="sd">    Args:</span>
<span class="sd">        dictype: A dictype defining the layout of the returned dict.</span>
<span class="sd">        thread: The Thread to use as model input.</span>
<span class="sd">        genconf: Model generation configuration. Defaults to None.</span>
<span class="sd">        schemaconf: JSchemaConf object that controls schema simplification. Defaults to None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A GenOut object with result, generated text, etc, with the output dict in GenOut.dic.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">schemaconf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">schemaconf</span> <span class="o">=</span> <span class="n">JSchemaConf</span><span class="p">()</span>

    <span class="n">params_scheme</span> <span class="o">=</span> <span class="n">dictype_get_json_schema</span><span class="p">(</span><span class="n">dictype</span><span class="p">,</span> <span class="n">schemaconf</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">genconf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">genconf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">genconf</span>

    <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">json_</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span>
                     <span class="n">genconf</span><span class="p">,</span>
                     <span class="n">params_scheme</span><span class="p">,</span>
                     <span class="n">massage_schema</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="c1"># already done in dictype_get_json_schema()</span>
                     <span class="n">schemaconf</span><span class="o">=</span><span class="n">schemaconf</span><span class="p">)</span> 
    <span class="k">return</span> <span class="n">out</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>







<div class="doc doc-object doc-function">



<h4 id="sibila.LlamaCppModel.pydantic_" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">pydantic_</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">pydantic_</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">thread</span><span class="p">,</span> <span class="n">genconf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">schemaconf</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Grammar-constrained generation after a Pydantic BaseModel-derived class definition.
An initialized Pydantic BaseModel object is returned in the "obj" field of return dict.
Doesn't raise an exception if an error occurs, always returns GenOut containing the created object.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>cls</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A class derived from a Pydantic BaseModel class.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>thread</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="sibila.thread.Thread" href="#sibila.Thread">Thread</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The Thread to use as model input.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>genconf</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-internal" title="sibila.gen.GenConf" href="#sibila.GenConf">GenConf</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Model generation configuration. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>schemaconf</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-internal" title="sibila.json_utils.JSchemaConf" href="#sibila.JSchemaConf">JSchemaConf</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>JSchemaConf object that controls schema simplification. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-internal" title="sibila.gen.GenOut" href="#sibila.GenOut">GenOut</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A GenOut object with result, generated text, etc. The initialized Pydantic BaseModel-derived object is in GenOut.obj.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>sibila/model.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">pydantic_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
              <span class="bp">cls</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="c1"># a Pydantic BaseModel class</span>
              <span class="n">thread</span><span class="p">:</span> <span class="n">Thread</span><span class="p">,</span>
              <span class="n">genconf</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GenConf</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
              <span class="n">schemaconf</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">JSchemaConf</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
              <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GenOut</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Grammar-constrained generation after a Pydantic BaseModel-derived class definition.</span>
<span class="sd">    An initialized Pydantic BaseModel object is returned in the &quot;obj&quot; field of return dict.</span>
<span class="sd">    Doesn&#39;t raise an exception if an error occurs, always returns GenOut containing the created object.</span>

<span class="sd">    Args:</span>
<span class="sd">        cls: A class derived from a Pydantic BaseModel class.</span>
<span class="sd">        thread: The Thread to use as model input.</span>
<span class="sd">        genconf: Model generation configuration. Defaults to None.</span>
<span class="sd">        schemaconf: JSchemaConf object that controls schema simplification. Defaults to None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A GenOut object with result, generated text, etc. The initialized Pydantic BaseModel-derived object is in GenOut.obj.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">schemaconf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">schemaconf</span> <span class="o">=</span> <span class="n">JSchemaConf</span><span class="p">()</span>

    <span class="n">params_scheme</span> <span class="o">=</span> <span class="n">pydantic_get_class_parameters</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">schemaconf</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">genconf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">genconf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">genconf</span>

    <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">json_</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span>
                     <span class="n">genconf</span><span class="p">,</span>
                     <span class="n">params_scheme</span><span class="p">,</span>
                     <span class="n">massage_schema</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="c1"># already done in dictype_get_json_schema()</span>
                     <span class="n">schemaconf</span><span class="o">=</span><span class="n">schemaconf</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">out</span><span class="o">.</span><span class="n">dic</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">pydantic_obj_from_json</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> 
                                         <span class="n">out</span><span class="o">.</span><span class="n">dic</span><span class="p">,</span>
                                         <span class="n">schemaconf</span><span class="o">=</span><span class="n">schemaconf</span><span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span>

        <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">res</span> <span class="o">=</span> <span class="n">GenRes</span><span class="o">.</span><span class="n">ERROR_JSON_SCHEMA_VAL</span> <span class="c1"># error validating for object (by Pydantic), but JSON is valid for its schema</span>
            <span class="n">out</span><span class="o">.</span><span class="n">text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">JSON Schema error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># out.res already holds the right error</span>
        <span class="o">...</span>

    <span class="k">return</span> <span class="n">out</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>







<div class="doc doc-object doc-function">



<h4 id="sibila.LlamaCppModel.token_len" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">token_len</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">token_len</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="n">_</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Calculate token length for a Thread.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>thread</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="sibila.thread.Thread" href="#sibila.Thread">Thread</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>For token length calculation.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Number of tokens the thread will use.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>sibila/model.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">token_len</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
              <span class="n">thread</span><span class="p">:</span> <span class="n">Thread</span><span class="p">,</span>
              <span class="n">_</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GenConf</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate token length for a Thread.</span>

<span class="sd">    Args:</span>
<span class="sd">        thread: For token length calculation.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Number of tokens the thread will use.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_from_thread</span><span class="p">(</span><span class="n">thread</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">token_len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>






<div class="doc doc-object doc-attribute">



<h4 id="sibila.LlamaCppModel.tokenizer" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">tokenizer</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">tokenizer</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div>

  <div class="doc doc-contents ">
  </div>

</div>






<div class="doc doc-object doc-attribute">



<h4 id="sibila.LlamaCppModel.ctx_len" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">ctx_len</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">ctx_len</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Maximum context length, shared for input + output.
We assume a common in+out context where total token length must always be less than this number.</p>
  </div>

</div>






<div class="doc doc-object doc-attribute">



<h4 id="sibila.LlamaCppModel.desc" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">desc</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">desc</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Model description.</p>
  </div>

</div>






<div class="doc doc-object doc-attribute">



<h4 id="sibila.LlamaCppModel.n_embd" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">n_embd</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">n_embd</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Embedding size of model.</p>
  </div>

</div>






<div class="doc doc-object doc-attribute">



<h4 id="sibila.LlamaCppModel.n_params" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">n_params</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">n_params</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Total number of model parameters.</p>
  </div>

</div>







<div class="doc doc-object doc-function">



<h4 id="sibila.LlamaCppModel.get_metadata" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">get_metadata</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">get_metadata</span><span class="p">()</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Returns model metadata.</p>

          <details class="quote">
            <summary>Source code in <code>sibila/llamacpp.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns model metadata.&quot;&quot;&quot;</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">buf</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span>
    <span class="n">lmodel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_llama</span><span class="o">.</span><span class="n">model</span>
    <span class="n">count</span> <span class="o">=</span> <span class="n">llama_cpp</span><span class="o">.</span><span class="n">llama_model_meta_count</span><span class="p">(</span><span class="n">lmodel</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">llama_cpp</span><span class="o">.</span><span class="n">llama_model_meta_key_by_index</span><span class="p">(</span><span class="n">lmodel</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">res</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[:</span><span class="n">res</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">llama_cpp</span><span class="o">.</span><span class="n">llama_model_meta_val_str_by_index</span><span class="p">(</span><span class="n">lmodel</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">res</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[:</span><span class="n">res</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                <span class="n">out</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">return</span> <span class="n">out</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>




  </div>

  </div>


</div>

<div class="doc doc-object doc-class">



<h3 id="sibila.OpenAIModel" class="doc doc-heading">
          <span class="doc doc-object-name doc-class-name">OpenAIModel</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">OpenAIModel</span><span class="p">(</span>
    <span class="n">name</span><span class="p">,</span>
    <span class="n">unknown_name_mask</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">genconf</span><span class="o">=</span><span class="n">GenConf</span><span class="p">(),</span>
    <span class="n">tokenizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">ctx_len</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">api_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">base_url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">openai_init_kwargs</span><span class="o">=</span><span class="p">{}</span>
<span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents first">

  
      <p>Access an OpenAI model via OpenAI API.</p>
<p>Supports grammar-constrained JSON output, via the OpenAI API tools mechanism.
Ref: https://platform.openai.com/docs/api-reference/chat/create</p>
  



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>name</code></td>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Model name.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>unknown_name_mask</code></td>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>How to deal with unmatched names, a mask of:
2: Raise NameError if exact name not found.
1: Only allow versioned names - raise NameError if generic non-versioned model name used.
0 (Default): Accept any name, use first in list if necessary. </p>
            </div>
          </td>
          <td>
                <code>0</code>
          </td>
        </tr>
        <tr>
          <td><code>genconf</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-internal" title="sibila.gen.GenConf" href="#sibila.GenConf">GenConf</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Model generation configuration. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code><a class="autorefs autorefs-internal" title="sibila.gen.GenConf" href="#sibila.GenConf">GenConf</a>()</code>
          </td>
        </tr>
        <tr>
          <td><code>tokenizer</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<span title="sibila.model.Tokenizer">Tokenizer</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>An external initialized tokenizer to use instead of the created from the GGUF file. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>ctx_len</code></td>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Maximum context length to be used (shared for input and output). Defaults to 0 which means model's maximum.</p>
            </div>
          </td>
          <td>
                <code>0</code>
          </td>
        </tr>
        <tr>
          <td><code>api_key</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>OpenAI API key. Defaults to None, which will use env variable OPENAI_API_KEY.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>base_url</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p><em>description</em>. Defaults to None, which will use en variable OPENAI_BASE_URL.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>openai_init_kwargs</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Extra args for OpenAI.OpenAI() initialization. Defaults to {}.</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Raises:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#ImportError">ImportError</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>If OpenAI API is not installed.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

                <details class="quote">
                  <summary>Source code in <code>sibila/openai.py</code></summary>
                  <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
             <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
             <span class="n">unknown_name_mask</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
             <span class="o">*</span><span class="p">,</span>

             <span class="c1"># common base model args</span>
             <span class="n">genconf</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GenConf</span><span class="p">]</span> <span class="o">=</span> <span class="n">GenConf</span><span class="p">(),</span>
             <span class="n">tokenizer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tokenizer</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">ctx_len</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>

             <span class="c1"># most important OpenAI-specific args</span>
             <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">base_url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>

             <span class="c1"># OpenAI-specific args</span>
             <span class="n">openai_init_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span>
             <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        name: Model name.</span>
<span class="sd">        unknown_name_mask: How to deal with unmatched names, a mask of:</span>
<span class="sd">            2: Raise NameError if exact name not found.</span>
<span class="sd">            1: Only allow versioned names - raise NameError if generic non-versioned model name used.</span>
<span class="sd">            0 (Default): Accept any name, use first in list if necessary. </span>
<span class="sd">        genconf: Model generation configuration. Defaults to None.</span>
<span class="sd">        tokenizer: An external initialized tokenizer to use instead of the created from the GGUF file. Defaults to None.</span>
<span class="sd">        ctx_len: Maximum context length to be used (shared for input and output). Defaults to 0 which means model&#39;s maximum.</span>
<span class="sd">        api_key: OpenAI API key. Defaults to None, which will use env variable OPENAI_API_KEY.</span>
<span class="sd">        base_url: _description_. Defaults to None, which will use en variable OPENAI_BASE_URL.</span>
<span class="sd">        openai_init_kwargs: Extra args for OpenAI.OpenAI() initialization. Defaults to {}.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ImportError: If OpenAI API is not installed.</span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="k">if</span> <span class="ow">not</span> <span class="n">has_openai</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;Please install openai by running: pip install openai&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_model_name</span><span class="p">,</span> <span class="n">max_ctx_len</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tokens_per_message</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tokens_per_name</span> <span class="o">=</span> <span class="n">resolve_model</span><span class="p">(</span>
        <span class="n">name</span><span class="p">,</span>
        <span class="n">unknown_name_mask</span>
    <span class="p">)</span>


    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span>
                     <span class="n">genconf</span><span class="p">,</span>
                     <span class="n">tokenizer</span>
                     <span class="p">)</span>

    <span class="c1"># only check for &quot;json&quot; text presence as json schema is requested with the tools facility.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">json_format_instructors</span><span class="p">[</span><span class="s2">&quot;json_schema&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">json_format_instructors</span><span class="p">[</span><span class="s2">&quot;json&quot;</span><span class="p">]</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="o">=</span> <span class="n">openai</span><span class="o">.</span><span class="n">OpenAI</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
                                 <span class="n">base_url</span><span class="o">=</span><span class="n">base_url</span><span class="p">,</span>

                                 <span class="o">**</span><span class="n">openai_init_kwargs</span>
                                 <span class="p">)</span>


    <span class="c1"># correct super __init__ values</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">OpenAITokenizer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_name</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ctx_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ctx_len</span> <span class="o">=</span> <span class="n">max_ctx_len</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ctx_len</span> <span class="o">=</span> <span class="n">ctx_len</span>
</code></pre></div></td></tr></table></div>
                </details>

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">



<h4 id="sibila.OpenAIModel.gen" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">gen</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">gen</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="n">genconf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ok_length_is_error</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Text generation from a Thread, used by the other model generation methods.
Like the gen_() method but will raise a GenError exception if an error occurs.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>thread</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="sibila.thread.Thread" href="#sibila.Thread">Thread</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The Thread to use as model input.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>genconf</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-internal" title="sibila.gen.GenConf" href="#sibila.GenConf">GenConf</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Model generation configuration. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>ok_length_is_error</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Should a result of GenRes.OK_LENGTH be considered an error and raise?</p>
            </div>
          </td>
          <td>
                <code>False</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Raises:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-internal" title="sibila.gen.GenError" href="#sibila.GenError">GenError</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>If an error occurred. This can be a model error, or an invalid JSON output error.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Text generated by model.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>sibila/model.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">gen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">thread</span><span class="p">:</span> <span class="n">Thread</span><span class="p">,</span>
        <span class="n">genconf</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GenConf</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ok_length_is_error</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Text generation from a Thread, used by the other model generation methods.</span>
<span class="sd">    Like the gen_() method but will raise a GenError exception if an error occurs.</span>

<span class="sd">    Args:</span>
<span class="sd">        thread: The Thread to use as model input.</span>
<span class="sd">        genconf: Model generation configuration. Defaults to None.</span>
<span class="sd">        ok_length_is_error: Should a result of GenRes.OK_LENGTH be considered an error and raise?</span>

<span class="sd">    Raises:</span>
<span class="sd">        GenError: If an error occurred. This can be a model error, or an invalid JSON output error.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Text generated by model.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> 
                    <span class="n">genconf</span><span class="p">)</span>

    <span class="n">GenError</span><span class="o">.</span><span class="n">raise_if_error</span><span class="p">(</span><span class="n">out</span><span class="p">,</span>
                            <span class="n">ok_length_is_error</span><span class="o">=</span><span class="n">ok_length_is_error</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">out</span><span class="o">.</span><span class="n">text</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>







<div class="doc doc-object doc-function">



<h4 id="sibila.OpenAIModel.json" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">json</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">json</span><span class="p">(</span>
    <span class="n">thread</span><span class="p">,</span>
    <span class="n">genconf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">json_schema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">massage_schema</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">schemaconf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>JSON/JSON-schema grammar-constrained generation, returning a Python dict of values, constrained or not by a JSON schema.
Raises GenError if unable to get a valid/schema-validated JSON.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>thread</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="sibila.thread.Thread" href="#sibila.Thread">Thread</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The Thread to use as model input.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>genconf</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-internal" title="sibila.gen.GenConf" href="#sibila.GenConf">GenConf</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Model generation configuration. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>json_schema</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>An optional JSON schema describing the dict fields that will be output. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>massage_schema</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Simplify schema. Defaults to True.</p>
            </div>
          </td>
          <td>
                <code>True</code>
          </td>
        </tr>
        <tr>
          <td><code>schemaconf</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-internal" title="sibila.json_utils.JSchemaConf" href="#sibila.JSchemaConf">JSchemaConf</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>JSchemaConf object that controls schema simplification. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Raises:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-internal" title="sibila.gen.GenError" href="#sibila.GenError">GenError</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>If an error occurred, for example an invalid JSON schema output error. See GenError.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A dict from model's JSON response, following genconf.jsonschema, if provided.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>sibila/model.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>

         <span class="n">thread</span><span class="p">:</span> <span class="n">Thread</span><span class="p">,</span>
         <span class="n">genconf</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GenConf</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>

         <span class="n">json_schema</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>

         <span class="n">massage_schema</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
         <span class="n">schemaconf</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">JSchemaConf</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
         <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;JSON/JSON-schema grammar-constrained generation, returning a Python dict of values, constrained or not by a JSON schema.</span>
<span class="sd">    Raises GenError if unable to get a valid/schema-validated JSON.</span>

<span class="sd">    Args:</span>
<span class="sd">        thread: The Thread to use as model input.</span>
<span class="sd">        genconf: Model generation configuration. Defaults to None.</span>
<span class="sd">        json_schema: An optional JSON schema describing the dict fields that will be output. Defaults to None.</span>
<span class="sd">        massage_schema: Simplify schema. Defaults to True.</span>
<span class="sd">        schemaconf: JSchemaConf object that controls schema simplification. Defaults to None.</span>

<span class="sd">    Raises:</span>
<span class="sd">        GenError: If an error occurred, for example an invalid JSON schema output error. See GenError.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A dict from model&#39;s JSON response, following genconf.jsonschema, if provided.</span>
<span class="sd">    &quot;&quot;&quot;</span>        
    <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">json_</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span>
                     <span class="n">genconf</span><span class="p">,</span>

                     <span class="n">json_schema</span><span class="p">,</span>
                     <span class="n">massage_schema</span><span class="p">,</span>
                     <span class="n">schemaconf</span><span class="p">)</span>

    <span class="n">GenError</span><span class="o">.</span><span class="n">raise_if_error</span><span class="p">(</span><span class="n">out</span><span class="p">,</span>
                            <span class="n">ok_length_is_error</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># as valid JSON can still be produced</span>

    <span class="k">return</span> <span class="n">out</span><span class="o">.</span><span class="n">dic</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>







<div class="doc doc-object doc-function">



<h4 id="sibila.OpenAIModel.dictype" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">dictype</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">dictype</span><span class="p">(</span><span class="n">dictype</span><span class="p">,</span> <span class="n">thread</span><span class="p">,</span> <span class="n">genconf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">schemaconf</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Grammar-constrained generation after a dictype definition (see dictype.py), returning a Python dict of values, 
Raises GenError if unable to get a valid dict that follows the dictype definition.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>dictype</code></td>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p><em>description</em></p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>thread</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="sibila.thread.Thread" href="#sibila.Thread">Thread</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p><em>description</em></p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>genconf</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-internal" title="sibila.gen.GenConf" href="#sibila.GenConf">GenConf</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p><em>description</em>. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>schemaconf</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-internal" title="sibila.json_utils.JSchemaConf" href="#sibila.JSchemaConf">JSchemaConf</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p><em>description</em>. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Raises:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-internal" title="sibila.gen.GenError" href="#sibila.GenError">GenError</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>If an error occurred, for example an invalid JSON schema output error. See GenError.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A dict following the dictype definition.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>sibila/model.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">dictype</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">dictype</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
            <span class="n">thread</span><span class="p">:</span> <span class="n">Thread</span><span class="p">,</span>
            <span class="n">genconf</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GenConf</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">schemaconf</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">JSchemaConf</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Grammar-constrained generation after a dictype definition (see dictype.py), returning a Python dict of values, </span>
<span class="sd">    Raises GenError if unable to get a valid dict that follows the dictype definition.</span>

<span class="sd">    Args:</span>
<span class="sd">        dictype: _description_</span>
<span class="sd">        thread: _description_</span>
<span class="sd">        genconf: _description_. Defaults to None.</span>
<span class="sd">        schemaconf: _description_. Defaults to None.</span>

<span class="sd">    Raises:</span>
<span class="sd">        GenError: If an error occurred, for example an invalid JSON schema output error. See GenError.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A dict following the dictype definition.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictype_</span><span class="p">(</span><span class="n">dictype</span><span class="p">,</span>
                        <span class="n">thread</span><span class="p">,</span>
                        <span class="n">genconf</span><span class="p">,</span>
                        <span class="n">schemaconf</span><span class="p">)</span>

    <span class="n">GenError</span><span class="o">.</span><span class="n">raise_if_error</span><span class="p">(</span><span class="n">out</span><span class="p">,</span>
                            <span class="n">ok_length_is_error</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># as valid JSON can still be produced</span>

    <span class="k">return</span> <span class="n">out</span><span class="o">.</span><span class="n">dic</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>







<div class="doc doc-object doc-function">



<h4 id="sibila.OpenAIModel.pydantic" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">pydantic</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">pydantic</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">thread</span><span class="p">,</span> <span class="n">genconf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">schemaconf</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Grammar-constrained generation after a Pydantic BaseModel-derived class definition.
An initialized Pydantic BaseModel object is returned in the "obj" field of return dict.
Raises GenError if unable to get a valid dict that follows the BaseModel class definition.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>cls</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A class derived from a Pydantic BaseModel class.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>thread</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="sibila.thread.Thread" href="#sibila.Thread">Thread</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The Thread to use as model input.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>genconf</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-internal" title="sibila.gen.GenConf" href="#sibila.GenConf">GenConf</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Model generation configuration. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>schemaconf</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-internal" title="sibila.json_utils.JSchemaConf" href="#sibila.JSchemaConf">JSchemaConf</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>JSchemaConf object that controls schema simplification. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Raises:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-internal" title="sibila.gen.GenError" href="#sibila.GenError">GenError</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>If an error occurred, for example an invalid BaseModel object. See GenError.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A Pydantic object of class cls (derived from BaseModel) initialized from the constrained JSON output.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>sibila/model.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">pydantic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
             <span class="bp">cls</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="c1"># a Pydantic BaseModel class</span>
             <span class="n">thread</span><span class="p">:</span> <span class="n">Thread</span><span class="p">,</span>
             <span class="n">genconf</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GenConf</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">schemaconf</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">JSchemaConf</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
             <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span> <span class="c1"># a Pydantic BaseModel object</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Grammar-constrained generation after a Pydantic BaseModel-derived class definition.</span>
<span class="sd">    An initialized Pydantic BaseModel object is returned in the &quot;obj&quot; field of return dict.</span>
<span class="sd">    Raises GenError if unable to get a valid dict that follows the BaseModel class definition.</span>

<span class="sd">    Args:</span>
<span class="sd">        cls: A class derived from a Pydantic BaseModel class.</span>
<span class="sd">        thread: The Thread to use as model input.</span>
<span class="sd">        genconf: Model generation configuration. Defaults to None.</span>
<span class="sd">        schemaconf: JSchemaConf object that controls schema simplification. Defaults to None.</span>

<span class="sd">    Raises:</span>
<span class="sd">        GenError: If an error occurred, for example an invalid BaseModel object. See GenError.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A Pydantic object of class cls (derived from BaseModel) initialized from the constrained JSON output.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pydantic_</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span>
                         <span class="n">thread</span><span class="p">,</span>
                         <span class="n">genconf</span><span class="p">,</span>
                         <span class="n">schemaconf</span><span class="p">)</span>

    <span class="n">GenError</span><span class="o">.</span><span class="n">raise_if_error</span><span class="p">(</span><span class="n">out</span><span class="p">,</span>
                            <span class="n">ok_length_is_error</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># as valid JSON can still be produced</span>

    <span class="k">return</span> <span class="n">out</span><span class="o">.</span><span class="n">obj</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>







<div class="doc doc-object doc-function">



<h4 id="sibila.OpenAIModel.gen_" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">gen_</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">gen_</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="n">genconf</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Text generation from a Thread, used by the other model generation methods.
Doesn't raise an exception if an error occurs, always returns GenOut.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>thread</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="sibila.thread.Thread" href="#sibila.Thread">Thread</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The Thread to use as model input.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>genconf</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-internal" title="sibila.gen.GenConf" href="#sibila.GenConf">GenConf</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Model generation configuration. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Raises:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#NotImplementedError">NotImplementedError</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>If method was not defined by a derived class.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-internal" title="sibila.gen.GenOut" href="#sibila.GenOut">GenOut</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A GenOut object with result, generated text, etc.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td>
                <code><a class="autorefs autorefs-internal" title="sibila.gen.GenOut" href="#sibila.GenOut">GenOut</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The output text is in GenOut.text.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>sibila/openai.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">gen_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
         <span class="n">thread</span><span class="p">:</span> <span class="n">Thread</span><span class="p">,</span>
         <span class="n">genconf</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GenConf</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
         <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GenOut</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Text generation from a Thread, used by the other model generation methods.</span>
<span class="sd">    Doesn&#39;t raise an exception if an error occurs, always returns GenOut.</span>

<span class="sd">    Args:</span>
<span class="sd">        thread: The Thread to use as model input.</span>
<span class="sd">        genconf: Model generation configuration. Defaults to None.</span>

<span class="sd">    Raises:</span>
<span class="sd">        NotImplementedError: If method was not defined by a derived class.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A GenOut object with result, generated text, etc.</span>
<span class="sd">        The output text is in GenOut.text.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">genconf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">genconf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">genconf</span>

    <span class="n">token_len</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">token_len</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="n">genconf</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">genconf</span><span class="o">.</span><span class="n">max_tokens</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">genconf</span> <span class="o">=</span> <span class="n">genconf</span><span class="p">(</span><span class="n">max_tokens</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ctx_len</span> <span class="o">-</span> <span class="n">token_len</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">token_len</span> <span class="o">+</span> <span class="n">genconf</span><span class="o">.</span><span class="n">max_tokens</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctx_len</span><span class="p">:</span>
        <span class="c1"># this is not true for all models: 1106 models have 128k max input and 4k max output (in and out ctx are not shared)</span>
        <span class="c1"># so we assume the smaller max ctx length for the model</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Token length + genconf.max_tokens (</span><span class="si">{</span><span class="n">token_len</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">genconf</span><span class="o">.</span><span class="n">max_tokens</span><span class="si">}</span><span class="s2">) is greater than model&#39;s context window length (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ctx_len</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>


    <span class="n">thread</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_gen_in</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="n">genconf</span><span class="p">)</span>

    <span class="n">fn_name</span> <span class="o">=</span> <span class="s2">&quot;json_out&quot;</span>

    <span class="n">json_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="nb">format</span> <span class="o">=</span> <span class="n">genconf</span><span class="o">.</span><span class="n">format</span>
    <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s2">&quot;json&quot;</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">genconf</span><span class="o">.</span><span class="n">json_schema</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">json_kwargs</span><span class="p">[</span><span class="s2">&quot;response_format&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;json_object&quot;</span><span class="p">}</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># use json_schema in OpenAi&#39;s tool api</span>
            <span class="n">json_kwargs</span><span class="p">[</span><span class="s2">&quot;tool_choice&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;function&quot;</span><span class="p">,</span>
                <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">},</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">genconf</span><span class="o">.</span><span class="n">json_schema</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">params</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">genconf</span><span class="o">.</span><span class="n">json_schema</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">params</span> <span class="o">=</span> <span class="n">genconf</span><span class="o">.</span><span class="n">json_schema</span>

            <span class="n">json_kwargs</span><span class="p">[</span><span class="s2">&quot;tools&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;function&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">fn_name</span><span class="p">,</span>
                        <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="n">params</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">]</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;OpenAI json args: </span><span class="si">{</span><span class="n">json_kwargs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">msgs</span> <span class="o">=</span> <span class="n">thread</span><span class="o">.</span><span class="n">as_chatml</span><span class="p">()</span>

    <span class="c1"># https://platform.openai.com/docs/api-reference/chat/create</span>
    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">completions</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_name</span><span class="p">,</span>
                                                    <span class="n">messages</span><span class="o">=</span><span class="n">msgs</span><span class="p">,</span>

                                                    <span class="n">max_tokens</span><span class="o">=</span><span class="n">genconf</span><span class="o">.</span><span class="n">max_tokens</span><span class="p">,</span>
                                                    <span class="n">stop</span><span class="o">=</span><span class="n">genconf</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span>
                                                    <span class="n">temperature</span><span class="o">=</span><span class="n">genconf</span><span class="o">.</span><span class="n">temperature</span><span class="p">,</span>
                                                    <span class="n">top_p</span><span class="o">=</span><span class="n">genconf</span><span class="o">.</span><span class="n">top_p</span><span class="p">,</span>
                                                    <span class="o">**</span><span class="n">json_kwargs</span><span class="p">,</span>

                                                    <span class="n">n</span><span class="o">=</span><span class="mi">1</span>
                                                    <span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;OpenAI response: </span><span class="si">{</span><span class="n">response</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">choice</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">finish</span> <span class="o">=</span> <span class="n">choice</span><span class="o">.</span><span class="n">finish_reason</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">choice</span><span class="o">.</span><span class="n">message</span>

    <span class="k">if</span> <span class="s2">&quot;tool_choice&quot;</span> <span class="ow">in</span> <span class="n">json_kwargs</span><span class="p">:</span>

        <span class="c1"># json schema generation via the tools API:</span>
        <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">tool_calls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">function</span>
            <span class="k">if</span> <span class="n">fn</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">fn_name</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;OpenAIModel: different returned JSON function name (</span><span class="si">{</span><span class="n">fn</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

            <span class="n">text</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">arguments</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># use content instead</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">content</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># text or simple json format</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">content</span>

    <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_gen_out</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">finish</span><span class="p">,</span> <span class="n">genconf</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">out</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>







<div class="doc doc-object doc-function">



<h4 id="sibila.OpenAIModel.json_" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">json_</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">json_</span><span class="p">(</span>
    <span class="n">thread</span><span class="p">,</span>
    <span class="n">genconf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">json_schema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">massage_schema</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">schemaconf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>JSON/JSON-schema grammar-constrained generation, returning a Python dict of values, constrained or not by a JSON schema.
Doesn't raise an exception if an error occurs, always returns GenOut.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>thread</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="sibila.thread.Thread" href="#sibila.Thread">Thread</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The Thread to use as model input.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>genconf</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-internal" title="sibila.gen.GenConf" href="#sibila.GenConf">GenConf</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Model generation configuration. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>json_schema</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>An optional JSON schema describing the dict fields that will be output. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>massage_schema</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Simplify schema. Defaults to True.</p>
            </div>
          </td>
          <td>
                <code>True</code>
          </td>
        </tr>
        <tr>
          <td><code>schemaconf</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-internal" title="sibila.json_utils.JSchemaConf" href="#sibila.JSchemaConf">JSchemaConf</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>JSchemaConf object that controls schema simplification. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-internal" title="sibila.gen.GenOut" href="#sibila.GenOut">GenOut</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A GenOut object with result, generated text, etc. The output dict is in GenOut.dic.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>sibila/model.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">json_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>

          <span class="n">thread</span><span class="p">:</span> <span class="n">Thread</span><span class="p">,</span>
          <span class="n">genconf</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GenConf</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>

          <span class="n">json_schema</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>

          <span class="n">massage_schema</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
          <span class="n">schemaconf</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">JSchemaConf</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
          <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GenOut</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;JSON/JSON-schema grammar-constrained generation, returning a Python dict of values, constrained or not by a JSON schema.</span>
<span class="sd">    Doesn&#39;t raise an exception if an error occurs, always returns GenOut.</span>

<span class="sd">    Args:</span>
<span class="sd">        thread: The Thread to use as model input.</span>
<span class="sd">        genconf: Model generation configuration. Defaults to None.</span>
<span class="sd">        json_schema: An optional JSON schema describing the dict fields that will be output. Defaults to None.</span>
<span class="sd">        massage_schema: Simplify schema. Defaults to True.</span>
<span class="sd">        schemaconf: JSchemaConf object that controls schema simplification. Defaults to None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A GenOut object with result, generated text, etc. The output dict is in GenOut.dic.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">genconf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">genconf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">genconf</span>

    <span class="k">if</span> <span class="n">genconf</span><span class="o">.</span><span class="n">json_schema</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">json_schema</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Both json_schema and genconf.json_schema are set: using json_schema&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">json_schema</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">massage_schema</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">schemaconf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">schemaconf</span> <span class="o">=</span> <span class="n">JSchemaConf</span><span class="p">()</span>
        <span class="n">json_schema</span> <span class="o">=</span> <span class="n">json_schema_massage</span><span class="p">(</span><span class="n">json_schema</span><span class="p">,</span> <span class="n">schemaconf</span><span class="p">)</span>

    <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> 
                    <span class="n">genconf</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s2">&quot;json&quot;</span><span class="p">,</span> 
                            <span class="n">json_schema</span><span class="o">=</span><span class="n">json_schema</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">out</span>        
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>







<div class="doc doc-object doc-function">



<h4 id="sibila.OpenAIModel.dictype_" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">dictype_</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">dictype_</span><span class="p">(</span><span class="n">dictype</span><span class="p">,</span> <span class="n">thread</span><span class="p">,</span> <span class="n">genconf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">schemaconf</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Grammar-constrained generation after a dictype definition (see dictype.py), returning a Python dict of values, 
Doesn't raise an exception if an error occurs, always returns GenOut.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>dictype</code></td>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A dictype defining the layout of the returned dict.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>thread</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="sibila.thread.Thread" href="#sibila.Thread">Thread</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The Thread to use as model input.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>genconf</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-internal" title="sibila.gen.GenConf" href="#sibila.GenConf">GenConf</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Model generation configuration. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>schemaconf</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-internal" title="sibila.json_utils.JSchemaConf" href="#sibila.JSchemaConf">JSchemaConf</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>JSchemaConf object that controls schema simplification. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-internal" title="sibila.gen.GenOut" href="#sibila.GenOut">GenOut</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A GenOut object with result, generated text, etc, with the output dict in GenOut.dic.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>sibila/model.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">dictype_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
             <span class="n">dictype</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
             <span class="n">thread</span><span class="p">:</span> <span class="n">Thread</span><span class="p">,</span>
             <span class="n">genconf</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GenConf</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">schemaconf</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">JSchemaConf</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
             <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GenOut</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Grammar-constrained generation after a dictype definition (see dictype.py), returning a Python dict of values, </span>
<span class="sd">    Doesn&#39;t raise an exception if an error occurs, always returns GenOut.</span>

<span class="sd">    Args:</span>
<span class="sd">        dictype: A dictype defining the layout of the returned dict.</span>
<span class="sd">        thread: The Thread to use as model input.</span>
<span class="sd">        genconf: Model generation configuration. Defaults to None.</span>
<span class="sd">        schemaconf: JSchemaConf object that controls schema simplification. Defaults to None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A GenOut object with result, generated text, etc, with the output dict in GenOut.dic.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">schemaconf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">schemaconf</span> <span class="o">=</span> <span class="n">JSchemaConf</span><span class="p">()</span>

    <span class="n">params_scheme</span> <span class="o">=</span> <span class="n">dictype_get_json_schema</span><span class="p">(</span><span class="n">dictype</span><span class="p">,</span> <span class="n">schemaconf</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">genconf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">genconf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">genconf</span>

    <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">json_</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span>
                     <span class="n">genconf</span><span class="p">,</span>
                     <span class="n">params_scheme</span><span class="p">,</span>
                     <span class="n">massage_schema</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="c1"># already done in dictype_get_json_schema()</span>
                     <span class="n">schemaconf</span><span class="o">=</span><span class="n">schemaconf</span><span class="p">)</span> 
    <span class="k">return</span> <span class="n">out</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>







<div class="doc doc-object doc-function">



<h4 id="sibila.OpenAIModel.pydantic_" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">pydantic_</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">pydantic_</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">thread</span><span class="p">,</span> <span class="n">genconf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">schemaconf</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Grammar-constrained generation after a Pydantic BaseModel-derived class definition.
An initialized Pydantic BaseModel object is returned in the "obj" field of return dict.
Doesn't raise an exception if an error occurs, always returns GenOut containing the created object.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>cls</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A class derived from a Pydantic BaseModel class.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>thread</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="sibila.thread.Thread" href="#sibila.Thread">Thread</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The Thread to use as model input.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>genconf</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-internal" title="sibila.gen.GenConf" href="#sibila.GenConf">GenConf</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Model generation configuration. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>schemaconf</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-internal" title="sibila.json_utils.JSchemaConf" href="#sibila.JSchemaConf">JSchemaConf</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>JSchemaConf object that controls schema simplification. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-internal" title="sibila.gen.GenOut" href="#sibila.GenOut">GenOut</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A GenOut object with result, generated text, etc. The initialized Pydantic BaseModel-derived object is in GenOut.obj.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>sibila/model.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">pydantic_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
              <span class="bp">cls</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="c1"># a Pydantic BaseModel class</span>
              <span class="n">thread</span><span class="p">:</span> <span class="n">Thread</span><span class="p">,</span>
              <span class="n">genconf</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GenConf</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
              <span class="n">schemaconf</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">JSchemaConf</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
              <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GenOut</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Grammar-constrained generation after a Pydantic BaseModel-derived class definition.</span>
<span class="sd">    An initialized Pydantic BaseModel object is returned in the &quot;obj&quot; field of return dict.</span>
<span class="sd">    Doesn&#39;t raise an exception if an error occurs, always returns GenOut containing the created object.</span>

<span class="sd">    Args:</span>
<span class="sd">        cls: A class derived from a Pydantic BaseModel class.</span>
<span class="sd">        thread: The Thread to use as model input.</span>
<span class="sd">        genconf: Model generation configuration. Defaults to None.</span>
<span class="sd">        schemaconf: JSchemaConf object that controls schema simplification. Defaults to None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A GenOut object with result, generated text, etc. The initialized Pydantic BaseModel-derived object is in GenOut.obj.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">schemaconf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">schemaconf</span> <span class="o">=</span> <span class="n">JSchemaConf</span><span class="p">()</span>

    <span class="n">params_scheme</span> <span class="o">=</span> <span class="n">pydantic_get_class_parameters</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">schemaconf</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">genconf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">genconf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">genconf</span>

    <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">json_</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span>
                     <span class="n">genconf</span><span class="p">,</span>
                     <span class="n">params_scheme</span><span class="p">,</span>
                     <span class="n">massage_schema</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="c1"># already done in dictype_get_json_schema()</span>
                     <span class="n">schemaconf</span><span class="o">=</span><span class="n">schemaconf</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">out</span><span class="o">.</span><span class="n">dic</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">pydantic_obj_from_json</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> 
                                         <span class="n">out</span><span class="o">.</span><span class="n">dic</span><span class="p">,</span>
                                         <span class="n">schemaconf</span><span class="o">=</span><span class="n">schemaconf</span><span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span>

        <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">res</span> <span class="o">=</span> <span class="n">GenRes</span><span class="o">.</span><span class="n">ERROR_JSON_SCHEMA_VAL</span> <span class="c1"># error validating for object (by Pydantic), but JSON is valid for its schema</span>
            <span class="n">out</span><span class="o">.</span><span class="n">text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">JSON Schema error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># out.res already holds the right error</span>
        <span class="o">...</span>

    <span class="k">return</span> <span class="n">out</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>







<div class="doc doc-object doc-function">



<h4 id="sibila.OpenAIModel.token_len" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">token_len</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">token_len</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="n">genconf</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Calculate the number of tokens used by a list of messages.
If a json_schema is provided in genconf, we use its string's token_len as upper bound for the extra prompt tokens.</p>
<p>From https://github.com/openai/openai-cookbook/blob/main/examples/How_to_count_tokens_with_tiktoken.ipynb</p>
<p>More info on calculating function_call (and tools?) tokens:</p>
<p>https://community.openai.com/t/how-to-calculate-the-tokens-when-using-function-call/266573/24</p>
<p>https://gist.github.com/CGamesPlay/dd4f108f27e2eec145eedf5c717318f5</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>thread</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="sibila.thread.Thread" href="#sibila.Thread">Thread</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>For token length calculation.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>genconf</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-internal" title="sibila.gen.GenConf" href="#sibila.GenConf">GenConf</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Model generation configuration. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Estimated number of tokens the thread will use.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>sibila/openai.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">token_len</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
              <span class="n">thread</span><span class="p">:</span> <span class="n">Thread</span><span class="p">,</span>
              <span class="n">genconf</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GenConf</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate the number of tokens used by a list of messages.</span>
<span class="sd">    If a json_schema is provided in genconf, we use its string&#39;s token_len as upper bound for the extra prompt tokens.</span>

<span class="sd">    From https://github.com/openai/openai-cookbook/blob/main/examples/How_to_count_tokens_with_tiktoken.ipynb</span>

<span class="sd">    More info on calculating function_call (and tools?) tokens:</span>

<span class="sd">    https://community.openai.com/t/how-to-calculate-the-tokens-when-using-function-call/266573/24</span>

<span class="sd">    https://gist.github.com/CGamesPlay/dd4f108f27e2eec145eedf5c717318f5</span>

<span class="sd">    Args:</span>
<span class="sd">        thread: For token length calculation.</span>
<span class="sd">        genconf: Model generation configuration. Defaults to None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Estimated number of tokens the thread will use.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># name = self._model_name</span>

    <span class="n">num_tokens</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">thread</span><span class="p">)):</span> <span class="c1"># -1 for system message</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">thread</span><span class="o">.</span><span class="n">msg_as_chatml</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="n">num_tokens</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tokens_per_message</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">message</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">num_tokens</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="c1"># if key == &quot;name&quot;:</span>
            <span class="c1">#     num_tokens += self._tokens_per_name</span>

    <span class="n">num_tokens</span> <span class="o">+=</span> <span class="mi">3</span>  <span class="c1"># every reply is primed with &lt;|start|&gt;assistant&lt;|message|&gt;</span>

    <span class="k">if</span> <span class="n">genconf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">genconf</span><span class="o">.</span><span class="n">json_schema</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">genconf</span><span class="o">.</span><span class="n">json_schema</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">js_str</span> <span class="o">=</span> <span class="n">genconf</span><span class="o">.</span><span class="n">json_schema</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">js_str</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">genconf</span><span class="o">.</span><span class="n">json_schema</span><span class="p">)</span>
        <span class="c1"># this is an upper bound, as empirically tested with the api.</span>
        <span class="n">num_tokens</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">token_len</span><span class="p">(</span><span class="n">js_str</span><span class="p">)</span>                

    <span class="k">return</span> <span class="n">num_tokens</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>






<div class="doc doc-object doc-attribute">



<h4 id="sibila.OpenAIModel.tokenizer" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">tokenizer</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">tokenizer</span> <span class="o">=</span> <span class="n"><a class="autorefs autorefs-internal" title="sibila.openai.OpenAITokenizer" href="#sibila.OpenAITokenizer">OpenAITokenizer</a></span><span class="p">(</span><span class="n"><span title="self._model_name">_model_name</span></span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  </div>

</div>






<div class="doc doc-object doc-attribute">



<h4 id="sibila.OpenAIModel.ctx_len" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">ctx_len</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">ctx_len</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Maximum context length, shared for input + output.
We assume a common in+out context where total token length must always be less than this number.</p>
  </div>

</div>






<div class="doc doc-object doc-attribute">



<h4 id="sibila.OpenAIModel.desc" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">desc</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">desc</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Model description.</p>
  </div>

</div>




  </div>

  </div>


</div><h2 id="messages-threads-context">Messages, Threads, Context</h2>


<div class="doc doc-object doc-class">



<h3 id="sibila.MsgKind" class="doc doc-heading">
          <span class="doc doc-object-name doc-class-name">MsgKind</span>


</h3>


  <div class="doc doc-contents first">

  
      <p>Enumeration for kinds of messages in a Thread.</p>


  

  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h4 id="sibila.MsgKind.IN" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">IN</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">IN</span> <span class="o">=</span> <span class="mi">0</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Input message, from user.</p>
  </div>

</div>






<div class="doc doc-object doc-attribute">



<h4 id="sibila.MsgKind.OUT" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">OUT</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">OUT</span> <span class="o">=</span> <span class="mi">1</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Model output message.</p>
  </div>

</div>






<div class="doc doc-object doc-attribute">



<h4 id="sibila.MsgKind.INST" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">INST</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">INST</span> <span class="o">=</span> <span class="mi">2</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Initial instructions for model.</p>
  </div>

</div>




  </div>

  </div>


</div>

<div class="doc doc-object doc-class">



<h3 id="sibila.Thread" class="doc doc-heading">
          <span class="doc doc-object-name doc-class-name">Thread</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">Thread</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inst</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">join_sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents first">

  
      <p>A sequence of messages alternating between IN ("user" role) and OUT ("assistant" role).</p>
<p>Stores a special initial INST information (known as "system" role in ChatML) providing instructions to the model.
Some models don't use system instructions - in those cases it's prepended to first IN message.</p>
<p>Messages are kept in a strict IN,OUT,IN,OUT,... order. To enforce this, if two IN messages are added, the second just appends to the text of the first.</p>
  



<p><strong>Examples:</strong></p>
    <p>Creation with message list</p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sibila</span> <span class="kn">import</span> <span class="n">Thread</span><span class="p">,</span> <span class="n">MsgKind</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">th</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">([(</span><span class="n">MsgKind</span><span class="o">.</span><span class="n">IN</span><span class="p">,</span> <span class="s2">&quot;Hello model!&quot;</span><span class="p">),</span> <span class="p">(</span><span class="n">MsgKind</span><span class="o">.</span><span class="n">OUT</span><span class="p">,</span> <span class="s2">&quot;Hello there human!&quot;</span><span class="p">)],</span>
<span class="gp">... </span>            <span class="n">inst</span><span class="o">=</span><span class="s2">&quot;Be helpful.&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">th</span><span class="p">)</span>
<span class="go">inst=Be helpful., sep=&#39;\n&#39;, len=2</span>
<span class="go">0: IN=Hello model!</span>
<span class="go">1: OUT=Hello there human!</span>
</code></pre></div>
    <p>Adding messages</p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sibila</span> <span class="kn">import</span> <span class="n">Thread</span><span class="p">,</span> <span class="n">MsgKind</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">th</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">inst</span><span class="o">=</span><span class="s2">&quot;Be helpful.&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">th</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">MsgKind</span><span class="o">.</span><span class="n">IN</span><span class="p">,</span> <span class="s2">&quot;Can you teach me how to cook?&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">th</span><span class="o">.</span><span class="n">add_IN</span><span class="p">(</span><span class="s2">&quot;I mean really cook as a chef?&quot;</span><span class="p">)</span> <span class="c1"># gets appended</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">th</span><span class="p">)</span>
<span class="go">inst=Be helpful., sep=&#39;\n&#39;, len=1</span>
<span class="go">0: IN=Can you teach me how to cook?\nI mean really cook as a chef?</span>
</code></pre></div>
    <p>Another way to add a message</p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sibila</span> <span class="kn">import</span> <span class="n">Thread</span><span class="p">,</span> <span class="n">MsgKind</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">th</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">inst</span><span class="o">=</span><span class="s2">&quot;Be informative.&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">th</span><span class="o">.</span><span class="n">add_IN</span><span class="p">(</span><span class="s2">&quot;Tell me about kangaroos, please?&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">th</span> <span class="o">+=</span> <span class="s2">&quot;They are so impressive.&quot;</span> <span class="c1"># appends text to last message</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">th</span><span class="p">)</span>
<span class="go">inst=Be informative., sep=&#39;\n&#39;, len=1</span>
<span class="go">0: IN=Tell me about kangaroos, please?\nThey are so impressive.</span>
</code></pre></div>
    <p>As a ChatML message list</p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sibila</span> <span class="kn">import</span> <span class="n">Thread</span><span class="p">,</span> <span class="n">MsgKind</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">th</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">([(</span><span class="n">MsgKind</span><span class="o">.</span><span class="n">IN</span><span class="p">,</span> <span class="s2">&quot;Hello model!&quot;</span><span class="p">),</span> <span class="p">(</span><span class="n">MsgKind</span><span class="o">.</span><span class="n">OUT</span><span class="p">,</span> <span class="s2">&quot;Hello there human!&quot;</span><span class="p">)],</span> 
<span class="gp">... </span>            <span class="n">inst</span><span class="o">=</span><span class="s2">&quot;Be helpful.&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">th</span><span class="o">.</span><span class="n">as_chatml</span><span class="p">()</span>
<span class="go">[{&#39;role&#39;: &#39;system&#39;, &#39;content&#39;: &#39;Be helpful.&#39;},</span>
<span class="go"> {&#39;role&#39;: &#39;user&#39;, &#39;content&#39;: &#39;Hello model!&#39;},</span>
<span class="go"> {&#39;role&#39;: &#39;assistant&#39;, &#39;content&#39;: &#39;Hello there human!&#39;}]</span>
</code></pre></div>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>t</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<span title="typing_extensions.Self">Self</span>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#tuple">tuple</a>]]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Can initialize from a Thread, from a list (containing messages in any format accepted in _parse_msg()) or a single message as an str, an (MsgKind,text) tuple or a dict. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>join_sep</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Separator used when message text needs to be joined. Defaults to "\n".</p>
            </div>
          </td>
          <td>
                <code>&#39;\n&#39;</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Raises:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#TypeError">TypeError</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>On invalid args passed.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

                <details class="quote">
                  <summary>Source code in <code>sibila/thread.py</code></summary>
                  <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
             <span class="n">t</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Self</span><span class="p">,</span><span class="nb">list</span><span class="p">,</span><span class="nb">str</span><span class="p">,</span><span class="nb">dict</span><span class="p">,</span><span class="nb">tuple</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">inst</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
             <span class="n">join_sep</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Examples:</span>
<span class="sd">        Creation with message list</span>

<span class="sd">        &gt;&gt;&gt; from sibila import Thread, MsgKind</span>
<span class="sd">        &gt;&gt;&gt; th = Thread([(MsgKind.IN, &quot;Hello model!&quot;), (MsgKind.OUT, &quot;Hello there human!&quot;)],</span>
<span class="sd">        ...             inst=&quot;Be helpful.&quot;)</span>
<span class="sd">        &gt;&gt;&gt; print(th)</span>
<span class="sd">        inst=Be helpful., sep=&#39;\\n&#39;, len=2</span>
<span class="sd">        0: IN=Hello model!</span>
<span class="sd">        1: OUT=Hello there human!</span>

<span class="sd">        Adding messages</span>

<span class="sd">        &gt;&gt;&gt; from sibila import Thread, MsgKind</span>
<span class="sd">        &gt;&gt;&gt; th = Thread(inst=&quot;Be helpful.&quot;)</span>
<span class="sd">        &gt;&gt;&gt; th.add(MsgKind.IN, &quot;Can you teach me how to cook?&quot;)</span>
<span class="sd">        &gt;&gt;&gt; th.add_IN(&quot;I mean really cook as a chef?&quot;) # gets appended</span>
<span class="sd">        &gt;&gt;&gt; print(th)</span>
<span class="sd">        inst=Be helpful., sep=&#39;\\n&#39;, len=1</span>
<span class="sd">        0: IN=Can you teach me how to cook?\\nI mean really cook as a chef?</span>

<span class="sd">        Another way to add a message</span>

<span class="sd">        &gt;&gt;&gt; from sibila import Thread, MsgKind</span>
<span class="sd">        &gt;&gt;&gt; th = Thread(inst=&quot;Be informative.&quot;)</span>
<span class="sd">        &gt;&gt;&gt; th.add_IN(&quot;Tell me about kangaroos, please?&quot;)</span>
<span class="sd">        &gt;&gt;&gt; th += &quot;They are so impressive.&quot; # appends text to last message</span>
<span class="sd">        &gt;&gt;&gt; print(th)</span>
<span class="sd">        inst=Be informative., sep=&#39;\\n&#39;, len=1</span>
<span class="sd">        0: IN=Tell me about kangaroos, please?\\nThey are so impressive.</span>

<span class="sd">        As a ChatML message list</span>
<span class="sd">        &gt;&gt;&gt; from sibila import Thread, MsgKind</span>
<span class="sd">        &gt;&gt;&gt; th = Thread([(MsgKind.IN, &quot;Hello model!&quot;), (MsgKind.OUT, &quot;Hello there human!&quot;)], </span>
<span class="sd">        ...             inst=&quot;Be helpful.&quot;)</span>
<span class="sd">        &gt;&gt;&gt; th.as_chatml()</span>
<span class="sd">        [{&#39;role&#39;: &#39;system&#39;, &#39;content&#39;: &#39;Be helpful.&#39;},</span>
<span class="sd">         {&#39;role&#39;: &#39;user&#39;, &#39;content&#39;: &#39;Hello model!&#39;},</span>
<span class="sd">         {&#39;role&#39;: &#39;assistant&#39;, &#39;content&#39;: &#39;Hello there human!&#39;}]</span>

<span class="sd">    Args:</span>
<span class="sd">        t: Can initialize from a Thread, from a list (containing messages in any format accepted in _parse_msg()) or a single message as an str, an (MsgKind,text) tuple or a dict. Defaults to None.</span>
<span class="sd">        join_sep: Separator used when message text needs to be joined. Defaults to &quot;\\n&quot;.</span>

<span class="sd">    Raises:</span>
<span class="sd">        TypeError: On invalid args passed.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Thread</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_msgs</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">_msgs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inst</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">inst</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">join_sep</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">join_sep</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_msgs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inst</span> <span class="o">=</span> <span class="n">inst</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">join_sep</span> <span class="o">=</span> <span class="n">join_sep</span>

        <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
                </details>

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">



<h4 id="sibila.Thread.clear" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">clear</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">clear</span><span class="p">()</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Delete all messages and clear inst.</p>

          <details class="quote">
            <summary>Source code in <code>sibila/thread.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Delete all messages and clear inst.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">inst</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_msgs</span> <span class="o">=</span> <span class="p">[]</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>






<div class="doc doc-object doc-attribute">



<h4 id="sibila.Thread.last_kind" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">last_kind</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">last_kind</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Get kind of last message in thread .</p>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-internal" title="sibila.thread.MsgKind" href="#sibila.MsgKind">MsgKind</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Kind of last message or MsgKind.IN if empty.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>
  </div>

</div>






<div class="doc doc-object doc-attribute">



<h4 id="sibila.Thread.inst" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">inst</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">inst</span> <span class="o">=</span> <span class="n"><span title="t.inst">inst</span></span>
</code></pre></div>

  <div class="doc doc-contents ">
  </div>

</div>







<div class="doc doc-object doc-function">



<h4 id="sibila.Thread.add" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">add</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">add</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Add a message to Thread by parsing a mix of types.</p>
<p>Accepts these combinations of arg types:</p>
<pre><code>t:MsgKind, text:str

t:str, text=None -&gt; uses last thread message's MsgKind

(MsgKind, text)

{"kind": "...", text: "..."}

{"role": "...", content: "..."} - ChatML format
</code></pre>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>t</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a>]]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>One of the accepted types listed above.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>text</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Message text if first type is MsgKind. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>sibila/thread.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
        <span class="n">t</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">list</span><span class="p">,</span><span class="nb">dict</span><span class="p">]],</span>
        <span class="n">text</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add a message to Thread by parsing a mix of types.</span>

<span class="sd">    Accepts these combinations of arg types:</span>

<span class="sd">        t:MsgKind, text:str</span>

<span class="sd">        t:str, text=None -&gt; uses last thread message&#39;s MsgKind</span>

<span class="sd">        (MsgKind, text)</span>

<span class="sd">        {&quot;kind&quot;: &quot;...&quot;, text: &quot;...&quot;}</span>

<span class="sd">        {&quot;role&quot;: &quot;...&quot;, content: &quot;...&quot;} - ChatML format</span>

<span class="sd">    Args:</span>
<span class="sd">        t: One of the accepted types listed above.</span>
<span class="sd">        text: Message text if first type is MsgKind. Defaults to None.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">kind</span><span class="p">,</span> <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_msg</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="n">MsgKind</span><span class="o">.</span><span class="n">INST</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">join_text</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inst</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_kind</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_msgs</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_msgs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">join_text</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_msgs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">text</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_msgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="c1"># in new kind</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>







<div class="doc doc-object doc-function">



<h4 id="sibila.Thread.addx" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">addx</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">addx</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Add message with text from a supplied arg or loaded from a path.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>path</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>If given, text is loaded from an UTF-8 file in this path. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>text</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>If given, text is added. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>kind</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-internal" title="sibila.thread.MsgKind" href="#sibila.MsgKind">MsgKind</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>MsgKind of message. If not given or the same as last thread message, it's appended to it. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>sibila/thread.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">addx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
         <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
         <span class="n">text</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
         <span class="n">kind</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">MsgKind</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add message with text from a supplied arg or loaded from a path.</span>

<span class="sd">    Args:</span>
<span class="sd">        path: If given, text is loaded from an UTF-8 file in this path. Defaults to None.</span>
<span class="sd">        text: If given, text is added. Defaults to None.</span>
<span class="sd">        kind: MsgKind of message. If not given or the same as last thread message, it&#39;s appended to it. Defaults to None.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">assert</span> <span class="p">(</span><span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;Only one of path or text&quot;</span>

    <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">kind</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># use last message role, so that it gets appended</span>
        <span class="n">kind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_kind</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>







<div class="doc doc-object doc-function">



<h4 id="sibila.Thread.get_text" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">get_text</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">get_text</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Return text for message at index.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>index</code></td>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Message index. Use -1 to get inst value.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Message text at index.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>sibila/thread.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
             <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return text for message at index.</span>

<span class="sd">    Args:</span>
<span class="sd">        index: Message index. Use -1 to get inst value.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Message text at index.</span>
<span class="sd">    &quot;&quot;&quot;</span>        
    <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">inst</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_msgs</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>







<div class="doc doc-object doc-function">



<h4 id="sibila.Thread.set_text" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">set_text</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">set_text</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Set text for message at index.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>index</code></td>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Message index. Use -1 to set inst value.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>text</code></td>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Text to replace in message at index.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>sibila/thread.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">set_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
             <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
             <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>        
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set text for message at index.</span>

<span class="sd">    Args:</span>
<span class="sd">        index: Message index. Use -1 to set inst value.</span>
<span class="sd">        text: Text to replace in message at index.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inst</span> <span class="o">=</span> <span class="n">text</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_msgs</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">text</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>







<div class="doc doc-object doc-function">



<h4 id="sibila.Thread.concat" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">concat</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">concat</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Concatenate a Thread or list of messages to the current Thread.</p>
<p>Take care that the other list starts with an IN message, therefore, 
if last message in self is also an IN kind, their text will be joined as in add().</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>t</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<span title="typing_extensions.Self">Self</span>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#tuple">tuple</a>]]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A Thread or a list of messages. Otherwise a single message as in add().</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Raises:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#TypeError">TypeError</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>If bad arg types provided.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>sibila/thread.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">concat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
           <span class="n">t</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Self</span><span class="p">,</span><span class="nb">list</span><span class="p">,</span><span class="nb">str</span><span class="p">,</span><span class="nb">dict</span><span class="p">,</span><span class="nb">tuple</span><span class="p">]]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Concatenate a Thread or list of messages to the current Thread.</span>

<span class="sd">    Take care that the other list starts with an IN message, therefore, </span>
<span class="sd">    if last message in self is also an IN kind, their text will be joined as in add().</span>

<span class="sd">    Args:</span>
<span class="sd">        t: A Thread or a list of messages. Otherwise a single message as in add().</span>

<span class="sd">    Raises:</span>
<span class="sd">        TypeError: If bad arg types provided.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Thread</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">join_text</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inst</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">inst</span><span class="p">)</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span> <span class="c1"># message list</span>
        <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span> <span class="c1"># single message</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Arg t must be: Thread --or-- list[messages] --or-- an str, tuple or dict single message.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>







<div class="doc doc-object doc-function">



<h4 id="sibila.Thread.load" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">load</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Load this Thread from a JSON file.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>path</code></td>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Path of file to load.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>sibila/thread.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
         <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load this Thread from a JSON file.</span>

<span class="sd">    Args:</span>
<span class="sd">        path: Path of file to load.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">js</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">js</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_msgs</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;_msgs&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">inst</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;inst&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">join_sep</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;join_sep&quot;</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>







<div class="doc doc-object doc-function">



<h4 id="sibila.Thread.save" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">save</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">save</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Serialize this Thread to JSON.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>path</code></td>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Path of file to save into.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>sibila/thread.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
         <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Serialize this Thread to JSON.</span>

<span class="sd">    Args:</span>
<span class="sd">        path: Path of file to save into.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">state</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;_msgs&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_msgs</span><span class="p">,</span>
             <span class="s2">&quot;inst&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">inst</span><span class="p">,</span>
             <span class="s2">&quot;join_sep&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">join_sep</span>
             <span class="p">}</span>

    <span class="n">json_str</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">vars</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json_str</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>







<div class="doc doc-object doc-function">



<h4 id="sibila.Thread.msg_as_chatml" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">msg_as_chatml</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">msg_as_chatml</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Returns message in a ChatML dict.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>index</code></td>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Index of the message to return.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A ChatML dict with "role" and "content" keys.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>sibila/thread.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">msg_as_chatml</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                  <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns message in a ChatML dict.</span>

<span class="sd">    Args:</span>
<span class="sd">        index: Index of the message to return.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A ChatML dict with &quot;role&quot; and &quot;content&quot; keys.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">kind</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="n">_kind_from_pos</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
    <span class="n">role</span> <span class="o">=</span> <span class="n">MsgKind</span><span class="o">.</span><span class="n">chatml_role_from_kind</span><span class="p">(</span><span class="n">kind</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_msgs</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">inst</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="n">role</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">text</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>







<div class="doc doc-object doc-function">



<h4 id="sibila.Thread.as_chatml" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">as_chatml</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">as_chatml</span><span class="p">()</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Returns Thread as a list of ChatML messages.</p>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A list of ChatML dict elements with "role" and "content" keys.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>sibila/thread.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">as_chatml</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns Thread as a list of ChatML messages.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list of ChatML dict elements with &quot;role&quot; and &quot;content&quot; keys.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">msgs</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">index</span><span class="p">,</span><span class="n">msg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_msgs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">inst</span><span class="p">:</span>
            <span class="n">msgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msg_as_chatml</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">msgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msg_as_chatml</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">msgs</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>







<div class="doc doc-object doc-function">



<h4 id="sibila.Thread.has_text_lower" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">has_text_lower</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">has_text_lower</span><span class="p">(</span><span class="n">text_lower</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Can the lowercase text be found in one of the messages?</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>text_lower</code></td>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The lowercase text to search for in messages.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>True if text was found.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>sibila/thread.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">has_text_lower</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                   <span class="n">text_lower</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Can the lowercase text be found in one of the messages?</span>

<span class="sd">    Args:</span>
<span class="sd">        text_lower: The lowercase text to search for in messages.</span>

<span class="sd">    Returns:</span>
<span class="sd">        True if text was found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_msgs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">text_lower</span> <span class="ow">in</span> <span class="n">msg</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="kc">False</span>        
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>




  </div>

  </div>


</div>

<div class="doc doc-object doc-class">



<h3 id="sibila.Trim" class="doc doc-heading">
          <span class="doc doc-object-name doc-class-name">Trim</span>


</h3>


  <div class="doc doc-contents first">

  
      <p>Flags for Thread trimming.</p>


  

  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h4 id="sibila.Trim.NONE" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">NONE</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">NONE</span> <span class="o">=</span> <span class="mi">0</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>No trimming.</p>
  </div>

</div>






<div class="doc doc-object doc-attribute">



<h4 id="sibila.Trim.INST" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">INST</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">INST</span> <span class="o">=</span> <span class="mi">1</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Can remove INST message.</p>
  </div>

</div>






<div class="doc doc-object doc-attribute">



<h4 id="sibila.Trim.IN" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">IN</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">IN</span> <span class="o">=</span> <span class="mi">2</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Can remove IN messages.</p>
  </div>

</div>






<div class="doc doc-object doc-attribute">



<h4 id="sibila.Trim.OUT" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">OUT</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">OUT</span> <span class="o">=</span> <span class="mi">4</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Can remove OUT messages.</p>
  </div>

</div>






<div class="doc doc-object doc-attribute">



<h4 id="sibila.Trim.KEEP_FIRST_IN" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">KEEP_FIRST_IN</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">KEEP_FIRST_IN</span> <span class="o">=</span> <span class="mi">1024</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>If trimming IN messages, never remove first one.</p>
  </div>

</div>






<div class="doc doc-object doc-attribute">



<h4 id="sibila.Trim.KEEP_FIRST_OUT" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">KEEP_FIRST_OUT</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">KEEP_FIRST_OUT</span> <span class="o">=</span> <span class="mi">2048</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>If trimming OUT messages, never remove first one.</p>
  </div>

</div>




  </div>

  </div>


</div>

<div class="doc doc-object doc-class">



<h3 id="sibila.Context" class="doc doc-heading">
          <span class="doc doc-object-name doc-class-name">Context</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">Context</span><span class="p">(</span>
    <span class="n">t</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">max_token_len</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">pinned_inst_text</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">join_sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents first">

  
      <p>A class based on Thread that manages total token length to be kept below a certain value.
Also supports a persistent instructions text.</p>
  



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>t</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-internal" title="sibila.thread.Thread" href="#sibila.Thread">Thread</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a>]]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Can initialize from a Thread, from a list (containing messages in any format accepted in _parse_msg()) or a single message as an str, an (MsgKind,text) tuple or a dict. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>max_token_len</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Maximum token count to use when trimming. Defaults to None, which will use max model context length.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>pinned_inst_text</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Pinned inst text which survives clear(). Defaults to "".</p>
            </div>
          </td>
          <td>
                <code>&#39;&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>join_sep</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Separator used when message text needs to be joined. Defaults to "\n".</p>
            </div>
          </td>
          <td>
                <code>&#39;\n&#39;</code>
          </td>
        </tr>
    </tbody>
  </table>

                <details class="quote">
                  <summary>Source code in <code>sibila/context.py</code></summary>
                  <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>

             <span class="n">t</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Thread</span><span class="p">,</span><span class="nb">list</span><span class="p">,</span><span class="nb">str</span><span class="p">,</span><span class="nb">dict</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>

             <span class="n">max_token_len</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>

             <span class="n">pinned_inst_text</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>

             <span class="n">join_sep</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        t: Can initialize from a Thread, from a list (containing messages in any format accepted in _parse_msg()) or a single message as an str, an (MsgKind,text) tuple or a dict. Defaults to None.</span>
<span class="sd">        max_token_len: Maximum token count to use when trimming. Defaults to None, which will use max model context length.</span>
<span class="sd">        pinned_inst_text: Pinned inst text which survives clear(). Defaults to &quot;&quot;.</span>
<span class="sd">        join_sep: Separator used when message text needs to be joined. Defaults to &quot;\\n&quot;.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">t</span><span class="p">,</span>
                     <span class="n">inst</span><span class="o">=</span><span class="n">pinned_inst_text</span><span class="p">,</span>
                     <span class="n">join_sep</span><span class="o">=</span><span class="n">join_sep</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">max_token_len</span> <span class="o">=</span> <span class="n">max_token_len</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">pinned_inst_text</span> <span class="o">=</span> <span class="n">pinned_inst_text</span>
</code></pre></div></td></tr></table></div>
                </details>

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">



<h4 id="sibila.Context.clear" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">clear</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">clear</span><span class="p">()</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Delete all messages but reset inst to a pinned text if any.</p>

          <details class="quote">
            <summary>Source code in <code>sibila/context.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Delete all messages but reset inst to a pinned text if any.&quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>        
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pinned_inst_text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pinned_inst_text</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>







<div class="doc doc-object doc-function">



<h4 id="sibila.Context.trim" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">trim</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">trim</span><span class="p">(</span>
    <span class="n">trim_flags</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">max_token_len</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">genconf</span><span class="o">=</span><span class="kc">None</span>
<span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p><em>summary</em></p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>trim_flags</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="sibila.context.Trim" href="#sibila.Trim">Trim</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p><em>description</em></p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>model</code></td>
          <td>
                <code><span title="sibila.model.Model">Model</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p><em>description</em></p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>max_token_len</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p><em>description</em>. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>genconf</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-internal" title="sibila.model.GenConf" href="#sibila.GenConf">GenConf</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p><em>description</em>. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Raises:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#RuntimeError">RuntimeError</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>If unable to trim anything.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>True if any trimmin occurred.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>sibila/context.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">trim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
         <span class="n">trim_flags</span><span class="p">:</span> <span class="n">Trim</span><span class="p">,</span>
         <span class="n">model</span><span class="p">:</span> <span class="n">Model</span><span class="p">,</span>
         <span class="o">*</span><span class="p">,</span>
         <span class="n">max_token_len</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
         <span class="n">genconf</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GenConf</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
         <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;_summary_</span>

<span class="sd">    Args:</span>
<span class="sd">        trim_flags: _description_</span>
<span class="sd">        model: _description_</span>
<span class="sd">        max_token_len: _description_. Defaults to None.</span>
<span class="sd">        genconf: _description_. Defaults to None.</span>

<span class="sd">    Raises:</span>
<span class="sd">        RuntimeError: If unable to trim anything.</span>

<span class="sd">    Returns:</span>
<span class="sd">        True if any trimmin occurred.</span>
<span class="sd">    &quot;&quot;&quot;</span>





    <span class="k">if</span> <span class="n">genconf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">genconf</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">genconf</span>            

    <span class="k">if</span> <span class="n">max_token_len</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">max_token_len</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_token_len</span>

    <span class="k">if</span> <span class="n">max_token_len</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">max_token_len</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">ctx_len</span>

    <span class="c1"># assert max_token_len &lt; model.ctx_len, f&quot;max_token_len ({max_token_len}) must be &lt; model&#39;s context size ({model.ctx_len}) - genconf.max_new_tokens&quot;</span>


    <span class="k">if</span> <span class="n">trim_flags</span> <span class="o">==</span> <span class="n">Trim</span><span class="o">.</span><span class="n">NONE</span><span class="p">:</span> <span class="c1"># no trimming</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">thread</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>

    <span class="n">any_trim</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>

        <span class="n">curr_len</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">token_len</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="n">genconf</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">curr_len</span> <span class="o">&lt;=</span> <span class="n">max_token_len</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;len=</span><span class="si">{</span><span class="n">curr_len</span><span class="si">}</span><span class="s2"> / max=</span><span class="si">{</span><span class="n">max_token_len</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inst</span> <span class="ow">and</span> <span class="n">trim_flags</span> <span class="o">&amp;</span> <span class="n">Trim</span><span class="o">.</span><span class="n">INST</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inst</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">any_trim</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cutting INST </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">inst</span><span class="p">[:</span><span class="mi">80</span><span class="p">]</span><span class="si">}</span><span class="s2"> (...)&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># cut first possible nessage, starting from oldest (first are older)</span>
        <span class="n">trimmed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">in_index</span> <span class="o">=</span> <span class="n">out_index</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">index</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">thread</span><span class="p">):</span>
            <span class="n">kind</span><span class="p">,</span><span class="n">text</span> <span class="o">=</span> <span class="n">m</span>

            <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="n">MsgKind</span><span class="o">.</span><span class="n">IN</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">trim_flags</span> <span class="o">&amp;</span> <span class="n">Trim</span><span class="o">.</span><span class="n">IN</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">trim_flags</span> <span class="o">&amp;</span> <span class="n">Trim</span><span class="o">.</span><span class="n">KEEP_FIRST_IN</span> <span class="ow">and</span> <span class="n">in_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                        <span class="k">del</span> <span class="n">thread</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                        <span class="n">trimmed</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cutting IN </span><span class="si">{</span><span class="n">text</span><span class="p">[:</span><span class="mi">80</span><span class="p">]</span><span class="si">}</span><span class="s2"> (...)&quot;</span><span class="p">)</span>
                        <span class="k">break</span>
                <span class="n">in_index</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="n">MsgKind</span><span class="o">.</span><span class="n">OUT</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">trim_flags</span> <span class="o">&amp;</span> <span class="n">Trim</span><span class="o">.</span><span class="n">OUT</span><span class="p">:</span>                        
                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">trim_flags</span> <span class="o">&amp;</span> <span class="n">Trim</span><span class="o">.</span><span class="n">KEEP_FIRST_OUT</span> <span class="ow">and</span> <span class="n">out_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                        <span class="k">del</span> <span class="n">thread</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                        <span class="n">trimmed</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cutting OUT </span><span class="si">{</span><span class="n">text</span><span class="p">[:</span><span class="mi">80</span><span class="p">]</span><span class="si">}</span><span class="s2"> (...)&quot;</span><span class="p">)</span>
                        <span class="k">break</span>
                <span class="n">out_index</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">trimmed</span><span class="p">:</span>
            <span class="c1"># all thread messages were cycled but not a single could be cut, so size remains the same</span>
            <span class="c1"># arriving here we did all we could for trim_flags but could not remove any more</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Unable to trim anything out of thread&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">any_trim</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># while end</span>


    <span class="k">if</span> <span class="n">any_trim</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_msgs</span> <span class="o">=</span> <span class="n">thread</span><span class="o">.</span><span class="n">_msgs</span>

    <span class="k">return</span> <span class="n">any_trim</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>




  </div>

  </div>


</div><h2 id="generation-configs">Generation Configs</h2>


<div class="doc doc-object doc-class">



<h3 id="sibila.GenConf" class="doc doc-heading">
          <span class="doc doc-object-name doc-class-name">GenConf</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


  <div class="doc doc-contents first">

  
      <p>Model generation configuration, used in Model.gen() and variants.</p>


  

  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h4 id="sibila.GenConf.max_tokens" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">max_tokens</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">max_tokens</span> <span class="o">=</span> <span class="mi">0</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Max generated token length. 0 means all available up to output context size (which equals: model.ctx_len - in_prompt_len)</p>
  </div>

</div>






<div class="doc doc-object doc-attribute">



<h4 id="sibila.GenConf.stop" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">stop</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">stop</span> <span class="o">=</span> <span class="n"><a class="autorefs autorefs-external" title="dataclasses.field" href="https://docs.python.org/3/library/dataclasses.html#dataclasses.field">field</a></span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a></span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>List of generation stop text sequences</p>
  </div>

</div>






<div class="doc doc-object doc-attribute">



<h4 id="sibila.GenConf.temperature" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">temperature</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">temperature</span> <span class="o">=</span> <span class="mf">0.0</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Generation temperature. Use 0 to always pick the most probable output, without random sampling. Other positive values will produce random outputs.</p>
  </div>

</div>






<div class="doc doc-object doc-attribute">



<h4 id="sibila.GenConf.top_p" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">top_p</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">top_p</span> <span class="o">=</span> <span class="mf">0.9</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Nucleus sampling top_p value. Only applies if temperature &gt; 0.</p>
  </div>

</div>






<div class="doc doc-object doc-attribute">



<h4 id="sibila.GenConf.format" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">format</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;text&#39;</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Output format: "text" or "json". For JSON output, text is validaded as in json.loads().
Thread msgs must explicitely request JSON output or a warning will be emited if string json not present
(this is automatically done in Model.json() and related calls).</p>
  </div>

</div>






<div class="doc doc-object doc-attribute">



<h4 id="sibila.GenConf.json_schema" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">json_schema</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">json_schema</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>A JSON schema to validate the JSON output.
Thread msgs must list the JSON schema and request its use; must also set the format to "json".</p>
  </div>

</div>







<div class="doc doc-object doc-function">



<h4 id="sibila.GenConf.asdict" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">asdict</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">asdict</span><span class="p">()</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Return GenConf as a dict.</p>

          <details class="quote">
            <summary>Source code in <code>sibila/gen.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">asdict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return GenConf as a dict.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">asdict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>







<div class="doc doc-object doc-function">



<h4 id="sibila.GenConf.clone" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">clone</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">clone</span><span class="p">()</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Return a copy of this configuration.</p>

          <details class="quote">
            <summary>Source code in <code>sibila/gen.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a copy of this configuration.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>







<div class="doc doc-object doc-function">



<h4 id="sibila.GenConf.__call__" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">__call__</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="fm">__call__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Return a copy of the current GenConf updated with values in kwargs. Doesn't modify object.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>**kwargs</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>update settings of the same names in the returned copy.</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Raises:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#KeyError">KeyError</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>If key does not exist.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="typing_extensions.Self">Self</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A copy of the current object with kwargs values updated. Doesn't modify object.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>sibila/gen.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
             <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a copy of the current GenConf updated with values in kwargs. Doesn&#39;t modify object.</span>

<span class="sd">    Args:</span>
<span class="sd">        **kwargs: update settings of the same names in the returned copy.</span>

<span class="sd">    Raises:</span>
<span class="sd">        KeyError: If key does not exist.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A copy of the current object with kwargs values updated. Doesn&#39;t modify object.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No such key &#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ret</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>







<div class="doc doc-object doc-function">



<h4 id="sibila.GenConf.__str__" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">__str__</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="fm">__str__</span><span class="p">()</span>
</code></pre></div>

  <div class="doc doc-contents ">

          <details class="quote">
            <summary>Source code in <code>sibila/gen.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">82</span>
<span class="normal">83</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">pformat</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>




  </div>

  </div>


</div>

<div class="doc doc-object doc-class">



<h3 id="sibila.JSchemaConf" class="doc doc-heading">
          <span class="doc doc-object-name doc-class-name">JSchemaConf</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


  <div class="doc doc-contents first">

  
      <p>Configuration for JSON schema massaging and validation.</p>


  

  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h4 id="sibila.JSchemaConf.resolve_refs" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">resolve_refs</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">resolve_refs</span> <span class="o">=</span> <span class="kc">True</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Set for $ref references to be resolved and replaced with actual definition.</p>
  </div>

</div>






<div class="doc doc-object doc-attribute">



<h4 id="sibila.JSchemaConf.collapse_single_combines" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">collapse_single_combines</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">collapse_single_combines</span> <span class="o">=</span> <span class="kc">True</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Any single-valued "oneOf"/"anyOf" is replaced with the actual value.</p>
  </div>

</div>






<div class="doc doc-object doc-attribute">



<h4 id="sibila.JSchemaConf.description_from_title" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">description_from_title</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">description_from_title</span> <span class="o">=</span> <span class="kc">False</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>If a value doesn't have a description entry, make one from its title or name.</p>
  </div>

</div>






<div class="doc doc-object doc-attribute">



<h4 id="sibila.JSchemaConf.force_all_required" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">force_all_required</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">force_all_required</span> <span class="o">=</span> <span class="kc">False</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Force all entries in an object to be required (except removed defaults if remove_with_default=True).</p>
  </div>

</div>






<div class="doc doc-object doc-attribute">



<h4 id="sibila.JSchemaConf.remove_with_default" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">remove_with_default</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">remove_with_default</span> <span class="o">=</span> <span class="kc">False</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Delete any values that have a "default" annotation.</p>
  </div>

</div>






<div class="doc doc-object doc-attribute">



<h4 id="sibila.JSchemaConf.default_to_last" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">default_to_last</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">default_to_last</span> <span class="o">=</span> <span class="kc">True</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Move any default value entry into the last position of properties dict.</p>
  </div>

</div>






<div class="doc doc-object doc-attribute">



<h4 id="sibila.JSchemaConf.additional_allowed_root_keys" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">additional_allowed_root_keys</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">additional_allowed_root_keys</span> <span class="o">=</span> <span class="n"><a class="autorefs autorefs-external" title="dataclasses.field" href="https://docs.python.org/3/library/dataclasses.html#dataclasses.field">field</a></span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a></span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>By default only "properties", "type", "required", "additionalProperties", "allOf", "anyOf", "oneOf", "not" are allowed in root - add to this setting for aditional ones.</p>
  </div>

</div>






<div class="doc doc-object doc-attribute">



<h4 id="sibila.JSchemaConf.pydantic_strict_validation" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">pydantic_strict_validation</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">pydantic_strict_validation</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Validate JSON values in a strict manner or not. None means validate individually per each value in the obj. (for example in pydantic with: Field(strict=True)).</p>
  </div>

</div>




  </div>

  </div>


</div><h2 id="generation-results-and-errors">Generation Results and Errors</h2>


<div class="doc doc-object doc-class">



<h3 id="sibila.GenRes" class="doc doc-heading">
          <span class="doc doc-object-name doc-class-name">GenRes</span>


</h3>


  <div class="doc doc-contents first">

  
      <p>Model generation result.</p>


  

  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h4 id="sibila.GenRes.OK_STOP" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">OK_STOP</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">OK_STOP</span> <span class="o">=</span> <span class="mi">1</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Generation complete without errors.</p>
  </div>

</div>






<div class="doc doc-object doc-attribute">



<h4 id="sibila.GenRes.OK_LENGTH" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">OK_LENGTH</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">OK_LENGTH</span> <span class="o">=</span> <span class="mi">0</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Generation stopped due to reaching max_tokens.</p>
  </div>

</div>






<div class="doc doc-object doc-attribute">



<h4 id="sibila.GenRes.ERROR_JSON" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">ERROR_JSON</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">ERROR_JSON</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Invalid JSON: this is often due to the model returning OK_LENGTH (finished due to max_tokens reached), which cuts off the JSON text.</p>
  </div>

</div>






<div class="doc doc-object doc-attribute">



<h4 id="sibila.GenRes.ERROR_JSON_SCHEMA_VAL" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">ERROR_JSON_SCHEMA_VAL</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">ERROR_JSON_SCHEMA_VAL</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Failed JSON schema validation.</p>
  </div>

</div>






<div class="doc doc-object doc-attribute">



<h4 id="sibila.GenRes.ERROR_JSON_SCHEMA_ERROR" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">ERROR_JSON_SCHEMA_ERROR</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">ERROR_JSON_SCHEMA_ERROR</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>JSON schema itself is not valid.</p>
  </div>

</div>






<div class="doc doc-object doc-attribute">



<h4 id="sibila.GenRes.ERROR_MODEL" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">ERROR_MODEL</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">ERROR_MODEL</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Other model internal error.</p>
  </div>

</div>







<div class="doc doc-object doc-function">



<h4 id="sibila.GenRes.from_finish_reason" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">from_finish_reason</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">from_finish_reason</span><span class="p">(</span><span class="n">finish</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Convert a ChatCompletion finish result into a GenRes.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>finish</code></td>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>ChatCompletion finish result.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="typing_extensions.Self">Self</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A GenRes result.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>sibila/gen.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">from_finish_reason</span><span class="p">(</span><span class="n">finish</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert a ChatCompletion finish result into a GenRes.</span>

<span class="sd">    Args:</span>
<span class="sd">        finish: ChatCompletion finish result.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A GenRes result.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">finish</span> <span class="o">==</span> <span class="s1">&#39;stop&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">GenRes</span><span class="o">.</span><span class="n">OK_STOP</span>
    <span class="k">elif</span> <span class="n">finish</span> <span class="o">==</span> <span class="s1">&#39;length&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">GenRes</span><span class="o">.</span><span class="n">OK_LENGTH</span>
    <span class="k">elif</span> <span class="n">finish</span> <span class="o">==</span> <span class="s1">&#39;!json&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">GenRes</span><span class="o">.</span><span class="n">ERROR_JSON</span>
    <span class="k">elif</span> <span class="n">finish</span> <span class="o">==</span> <span class="s1">&#39;!json_schema_val&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">GenRes</span><span class="o">.</span><span class="n">ERROR_JSON_SCHEMA_VAL</span>
    <span class="k">elif</span> <span class="n">finish</span> <span class="o">==</span> <span class="s1">&#39;!json_schema_error&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">GenRes</span><span class="o">.</span><span class="n">ERROR_JSON_SCHEMA_ERROR</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">GenRes</span><span class="o">.</span><span class="n">ERROR_MODEL</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>







<div class="doc doc-object doc-function">



<h4 id="sibila.GenRes.as_text" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">as_text</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">as_text</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Returns a friendlier description of the result.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>res</code></td>
          <td>
                <code><span title="typing_extensions.Self">Self</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Model output result.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Raises:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#ValueError">ValueError</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>If unknown GenRes.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A friendlier description of the GenRes.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>sibila/gen.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">as_text</span><span class="p">(</span><span class="n">res</span><span class="p">:</span> <span class="n">Self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns a friendlier description of the result.</span>

<span class="sd">    Args:</span>
<span class="sd">        res: Model output result.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If unknown GenRes.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A friendlier description of the GenRes.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">res</span> <span class="o">==</span> <span class="n">GenRes</span><span class="o">.</span><span class="n">OK_STOP</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Stop&quot;</span>
    <span class="k">elif</span> <span class="n">res</span> <span class="o">==</span> <span class="n">GenRes</span><span class="o">.</span><span class="n">OK_LENGTH</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Length (output cut)&quot;</span>
    <span class="k">elif</span> <span class="n">res</span> <span class="o">==</span> <span class="n">GenRes</span><span class="o">.</span><span class="n">ERROR_JSON</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;JSON decoding error&quot;</span>

    <span class="k">elif</span> <span class="n">res</span> <span class="o">==</span> <span class="n">GenRes</span><span class="o">.</span><span class="n">ERROR_JSON_SCHEMA_VAL</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;JSON SCHEMA validation error&quot;</span>
    <span class="k">elif</span> <span class="n">res</span> <span class="o">==</span> <span class="n">GenRes</span><span class="o">.</span><span class="n">ERROR_JSON_SCHEMA_ERROR</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Error in JSON SCHEMA&quot;</span>

    <span class="k">elif</span> <span class="n">res</span> <span class="o">==</span> <span class="n">GenRes</span><span class="o">.</span><span class="n">ERROR_MODEL</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Model internal error&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Bad/unknow GenRes&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>




  </div>

  </div>


</div>

<div class="doc doc-object doc-class">



<h3 id="sibila.GenError" class="doc doc-heading">
          <span class="doc doc-object-name doc-class-name">GenError</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">GenError</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents first">

  
      <p>Model generation exception.</p>
  
      <p>An error has happened during model generation.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>out</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="sibila.gen.GenOut" href="#sibila.GenOut">GenOut</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Model output</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

                <details class="quote">
                  <summary>Source code in <code>sibila/gen.py</code></summary>
                  <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
             <span class="n">out</span><span class="p">:</span> <span class="n">GenOut</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An error has happened during model generation.</span>

<span class="sd">    Args:</span>
<span class="sd">        out: Model output</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">assert</span> <span class="n">out</span><span class="o">.</span><span class="n">res</span> <span class="o">!=</span> <span class="n">GenRes</span><span class="o">.</span><span class="n">OK_STOP</span><span class="p">,</span> <span class="s2">&quot;OK_STOP is not an error&quot;</span>      

    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">res</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">res</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">text</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dic</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">dic</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">obj</span>
</code></pre></div></td></tr></table></div>
                </details>

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">



<h4 id="sibila.GenError.raise_if_error" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">raise_if_error</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">raise_if_error</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">ok_length_is_error</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Raise an exception if the model returned an error</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>out</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="sibila.gen.GenOut" href="#sibila.GenOut">GenOut</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Model returned info.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>ok_length_is_error</code></td>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Should a result of GenRes.OK_LENGTH be considered an error?</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Raises:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-internal" title="sibila.gen.GenError" href="#sibila.GenError">GenError</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>If an error was returned by model.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>sibila/gen.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">raise_if_error</span><span class="p">(</span><span class="n">out</span><span class="p">:</span> <span class="n">GenOut</span><span class="p">,</span>
                   <span class="n">ok_length_is_error</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raise an exception if the model returned an error</span>

<span class="sd">    Args:</span>
<span class="sd">        out: Model returned info.</span>
<span class="sd">        ok_length_is_error: Should a result of GenRes.OK_LENGTH be considered an error?</span>

<span class="sd">    Raises:</span>
<span class="sd">        GenError: If an error was returned by model.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">out</span><span class="o">.</span><span class="n">res</span> <span class="o">!=</span> <span class="n">GenRes</span><span class="o">.</span><span class="n">OK_STOP</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">out</span><span class="o">.</span><span class="n">res</span> <span class="o">==</span> <span class="n">GenRes</span><span class="o">.</span><span class="n">OK_LENGTH</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ok_length_is_error</span><span class="p">:</span>
            <span class="k">return</span> <span class="c1"># OK_LENGTH to not be considered an error</span>

        <span class="k">raise</span> <span class="n">GenError</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>




  </div>

  </div>


</div>

<div class="doc doc-object doc-class">



<h3 id="sibila.GenOut" class="doc doc-heading">
          <span class="doc doc-object-name doc-class-name">GenOut</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


  <div class="doc doc-contents first">

  
      <p>Model output, returned by gen_(), json_() and other Model calls that don't raise exceptions.</p>


  

  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h4 id="sibila.GenOut.res" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">res</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">res</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Result of model generation.</p>
  </div>

</div>






<div class="doc doc-object doc-attribute">



<h4 id="sibila.GenOut.text" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">text</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">text</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Text generated by model.</p>
  </div>

</div>






<div class="doc doc-object doc-attribute">



<h4 id="sibila.GenOut.dic" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">dic</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">dic</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Python dictionary output by the structured calls like json_() or dictype_().</p>
  </div>

</div>






<div class="doc doc-object doc-attribute">



<h4 id="sibila.GenOut.obj" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">obj</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">obj</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Pydantic BaseModel object initialized from class definition in pydantic_().</p>
  </div>

</div>







<div class="doc doc-object doc-function">



<h4 id="sibila.GenOut.asdict" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">asdict</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">asdict</span><span class="p">()</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Return GenOut as a dict.</p>

          <details class="quote">
            <summary>Source code in <code>sibila/gen.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">asdict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return GenOut as a dict.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">asdict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>







<div class="doc doc-object doc-function">



<h4 id="sibila.GenOut.__str__" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">__str__</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="fm">__str__</span><span class="p">()</span>
</code></pre></div>

  <div class="doc doc-contents ">

          <details class="quote">
            <summary>Source code in <code>sibila/gen.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="o">.</span><span class="n">as_text</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">)</span><span class="si">}</span><span class="s2"> text=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dic</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; dic=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dic</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; obj=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">out</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>




  </div>

  </div>


</div><h2 id="directories">Directories</h2>


<div class="doc doc-object doc-class">



<h3 id="sibila.ModelDir" class="doc doc-heading">
          <span class="doc doc-object-name doc-class-name">ModelDir</span>


</h3>


  <div class="doc doc-contents first">

  
      <p>Model directory that unifies (and simplify) model access and configuration.</p>
<p>Useful to create models from resource names like "llamacpp:openchat" or "openai:gpt-4". 
This makes it simple to change a model, store model settings, to compare model outputs, etc.</p>
<p>User can add new entries from script or with JSON filenames, via the add() call.
New directory entries with the same name are merged into existing ones for each added config.</p>
<p>Uses file base_modeldir.json in this script's directory for the initial defaults, 
which the user can augment by calling add() with own config files or directly adding model config with add_model().</p>
<p>These env variables are checked and used during initialization:</p>
<pre><code>SIBILA_MODEL_DIR_CONF: path of a JSON configuration file to add().

SIBILA_MODEL_SEARCH_PATH: ';'-delimited list of folders where to find models.
</code></pre>
<p>An example of a model directory JSON config file:</p>
<pre><code>{
    # &quot;llamacpp&quot; is a provider, you can then create models with names 
    # like &quot;provider:model_name&quot;, for ex: &quot;llamacpp:openchat&quot;
    &quot;llamacpp&quot;: { 

        &quot;default&quot;: {
            # Place here default args for all llamacpp: models. 
            # Each entry below can then override as needed.
        },

        &quot;openchat&quot;: { # this is model definition
            &quot;name&quot;: &quot;openchat-3.5-1210.Q4_K_M.gguf&quot;,
            &quot;format&quot;: &quot;openchat&quot; # FormatDir's format used by this model
                                 # (formats are chat templates)
        },

        &quot;phi2&quot;: {
            &quot;name&quot;: &quot;phi-2.Q5_K_M.gguf&quot;, # model filename
            &quot;format&quot;: &quot;phi2&quot;
        },

        &quot;oc&quot;: &quot;openchat&quot; 
        # this is an alias: &quot;oc&quot; forwards to the &quot;openchat&quot; entry
    },

    # The &quot;openai&quot; provider. A model can be created with name: &quot;openai:gpt-4&quot;
    &quot;openai&quot;: { 

        &quot;default&quot;: {}, # default settings for all openai models

        &quot;gpt-3.5&quot;: {
            &quot;name&quot;: &quot;gpt-3.5-turbo-1106&quot; # OpenAI's  model name
        },

        &quot;gpt-4&quot;: {
            &quot;name&quot;: &quot;gpt-4-1106-preview&quot;
        },
    },

    # Entry &quot;alias&quot; is not a provider but a way to have simpler alias names.
    # For example you can use &quot;alias:develop&quot; or even simpler, just &quot;develop&quot;.
    &quot;alias&quot;: { 
        &quot;develop&quot;: &quot;llamacpp:openchat&quot;,
        &quot;production&quot;: &quot;openai:gpt-3.5&quot;
    }

}

</code></pre>


  

  <div class="doc doc-children">








<div class="doc doc-object doc-function">



<h4 id="sibila.ModelDir.add" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">add</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">add</span><span class="p">(</span><span class="n">conf_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">conf</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Add a JSON file or configuration dict to the model directory.
When adding a JSON file, its folder is also added to the search path for model files.
~/ can be used in paths for current account's home directory.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>conf_path</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Path to a JSON file with directory configuration. See class <strong>doc</strong> for format. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>conf</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A dict with configuration as if loaded from JSON by json.loads(). Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Raises:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#TypeError">TypeError</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Only one of conf_path or conf can be given.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>sibila/modeldir.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span>
        <span class="n">conf_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">conf</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add a JSON file or configuration dict to the model directory.</span>
<span class="sd">    When adding a JSON file, its folder is also added to the search path for model files.</span>
<span class="sd">    ~/ can be used in paths for current account&#39;s home directory.</span>

<span class="sd">    Args:</span>
<span class="sd">        conf_path: Path to a JSON file with directory configuration. See class __doc__ for format. Defaults to None.</span>
<span class="sd">        conf: A dict with configuration as if loaded from JSON by json.loads(). Defaults to None.</span>

<span class="sd">    Raises:</span>
<span class="sd">        TypeError: Only one of conf_path or conf can be given.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="p">((</span><span class="n">conf_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">conf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Only one of conf_path or conf can be given&quot;</span><span class="p">)</span>

    <span class="bp">cls</span><span class="o">.</span><span class="n">ensure</span><span class="p">()</span>

    <span class="c1"># conf directory loading</span>
    <span class="k">if</span> <span class="n">conf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">dir</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">merge_dir_json</span><span class="p">(</span><span class="n">conf_path</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">dir</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">search_path</span><span class="p">)</span>

    <span class="bp">cls</span><span class="o">.</span><span class="n">_sanity_check</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>







<div class="doc doc-object doc-function">



<h4 id="sibila.ModelDir.add_model" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">add_model</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">add_model</span><span class="p">(</span><span class="n">res_name</span><span class="p">,</span> <span class="n">conf_or_link</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Add configuration or model alias at given res_name.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>res_name</code></td>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A name in the form "provider:model_name", for example "openai:gtp-4".</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>conf_or_link</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A configuration dict or an alias name (to an existing model).</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Raises:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#ValueError">ValueError</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>If unknown provider.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>sibila/modeldir.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">add_model</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span>
              <span class="n">res_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
              <span class="n">conf_or_link</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span><span class="nb">str</span><span class="p">]):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add configuration or model alias at given res_name.</span>

<span class="sd">    Args:</span>
<span class="sd">        res_name: A name in the form &quot;provider:model_name&quot;, for example &quot;openai:gtp-4&quot;.</span>
<span class="sd">        conf_or_link: A configuration dict or an alias name (to an existing model).</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If unknown provider.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="bp">cls</span><span class="o">.</span><span class="n">ensure</span><span class="p">()</span>

    <span class="n">provider</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">provider_name_from_urn</span><span class="p">(</span><span class="n">res_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">provider</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">ALL_PROVIDER_NAMES</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown provider &#39;</span><span class="si">{</span><span class="n">provider</span><span class="si">}</span><span class="s2">&#39; in &#39;</span><span class="si">{</span><span class="n">res_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

    <span class="bp">cls</span><span class="o">.</span><span class="n">dir</span><span class="p">[</span><span class="n">provider</span><span class="p">]</span> <span class="o">=</span> <span class="n">conf_or_link</span>

    <span class="bp">cls</span><span class="o">.</span><span class="n">_sanity_check</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>







<div class="doc doc-object doc-function">



<h4 id="sibila.ModelDir.add_search_path" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">add_search_path</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">add_search_path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Prepends new paths to model search path.</p>
<p>During initialization env variable SIBILA_MODEL_SEARCH_PATH is searched for ';'-delimited paths.
~/ can be used in paths for current account's home directory.        </p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>path</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A path or list of paths to add to model search path.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>sibila/modeldir.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">add_search_path</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span>
                    <span class="n">path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Prepends new paths to model search path.</span>

<span class="sd">    During initialization env variable SIBILA_MODEL_SEARCH_PATH is searched for &#39;;&#39;-delimited paths.</span>
<span class="sd">    ~/ can be used in paths for current account&#39;s home directory.        </span>

<span class="sd">    Args:</span>
<span class="sd">        path: A path or list of paths to add to model search path.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="bp">cls</span><span class="o">.</span><span class="n">ensure</span><span class="p">()</span>

    <span class="n">prepend_path</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">search_path</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>







<div class="doc doc-object doc-function">



<h4 id="sibila.ModelDir.set_genconf" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">set_genconf</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">set_genconf</span><span class="p">(</span><span class="n">genconf</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Set the GenConf to use as default for model creation.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>genconf</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="sibila.model.GenConf" href="#sibila.GenConf">GenConf</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Model generation configuration.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>sibila/modeldir.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">set_genconf</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span>
                <span class="n">genconf</span><span class="p">:</span> <span class="n">GenConf</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set the GenConf to use as default for model creation.</span>

<span class="sd">    Args:</span>
<span class="sd">        genconf: Model generation configuration.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">cls</span><span class="o">.</span><span class="n">genconf</span> <span class="o">=</span> <span class="n">genconf</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>







<div class="doc doc-object doc-function">



<h4 id="sibila.ModelDir.create" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">create</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">create</span><span class="p">(</span><span class="n">res_name</span><span class="p">,</span> <span class="n">genconf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">over_args</span><span class="o">=</span><span class="p">{})</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Create a model after an entry in the model directory.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>res_name</code></td>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Resource name in the format: provider:model_name, for example "llamacpp:openchat".</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>genconf</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-internal" title="sibila.model.GenConf" href="#sibila.GenConf">GenConf</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Optional model generation configuration, if not given, configuration given by a previous call to set_genconf() is used.  Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>over_args</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Model-specific creation args that will override default args set in directory. Defaults to {}.</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>Model</code></td>          <td>
                <code><span title="sibila.model.Model">Model</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>the initialized model.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>sibila/modeldir.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span>
           <span class="n">res_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
           <span class="n">genconf</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GenConf</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
           <span class="n">over_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{})</span> <span class="o">-&gt;</span> <span class="n">Model</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a model after an entry in the model directory.</span>

<span class="sd">    Args:</span>
<span class="sd">        res_name: Resource name in the format: provider:model_name, for example &quot;llamacpp:openchat&quot;.</span>
<span class="sd">        genconf: Optional model generation configuration, if not given, configuration given by a previous call to set_genconf() is used.  Defaults to None.</span>
<span class="sd">        over_args: Model-specific creation args that will override default args set in directory. Defaults to {}.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Model: the initialized model.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="bp">cls</span><span class="o">.</span><span class="n">ensure</span><span class="p">()</span>        

    <span class="c1"># resolve &quot;alias:name&quot; res names, or &quot;name&quot;: &quot;link_name&quot; links</span>
    <span class="n">provider</span><span class="p">,</span><span class="n">name</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">resolve_urn</span><span class="p">(</span><span class="n">res_name</span><span class="p">)</span>
    <span class="c1"># arriving here, prov as a non-link dict entry</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resolved &#39;</span><span class="si">{</span><span class="n">res_name</span><span class="si">}</span><span class="s2">&#39; to &#39;</span><span class="si">{</span><span class="n">provider</span><span class="si">}</span><span class="s2">&#39;,&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

    <span class="n">prov</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">dir</span><span class="p">[</span><span class="n">provider</span><span class="p">]</span>

    <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">prov</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;default&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="ow">or</span> <span class="p">{}</span>
    <span class="n">prov_conf</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">PROVIDER_CONF</span><span class="p">[</span><span class="n">provider</span><span class="p">]</span>    

    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">prov</span><span class="p">:</span>
        <span class="n">model_args</span> <span class="o">=</span> <span class="n">prov</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

        <span class="c1"># default(if any) &lt;- model_args &lt;- over_args</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">prov</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;default&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">model_args</span><span class="p">)</span>        
        <span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">over_args</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>                
        <span class="k">if</span> <span class="s2">&quot;name_passthrough&quot;</span> <span class="ow">in</span> <span class="n">prov_conf</span><span class="p">[</span><span class="s2">&quot;flags&quot;</span><span class="p">]:</span>
            <span class="n">model_args</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span>                
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; not found in provider &#39;</span><span class="si">{</span><span class="n">provider</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

        <span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">model_args</span><span class="p">)</span>
        <span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">over_args</span><span class="p">)</span>


    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating model &#39;</span><span class="si">{</span><span class="n">provider</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; with resolved args: </span><span class="si">{</span><span class="n">args</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">genconf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">genconf</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">genconf</span>

    <span class="k">if</span> <span class="n">provider</span> <span class="o">==</span> <span class="s2">&quot;llamacpp&quot;</span><span class="p">:</span>

        <span class="c1"># resolve filename -&gt; path</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_locate_file</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File not found in &#39;</span><span class="si">{</span><span class="n">res_name</span><span class="si">}</span><span class="s2">&#39; while looking for file &#39;</span><span class="si">{</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;. Make sure you initialized ModelDir with a path to this file&#39;s folder&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resolved &#39;</span><span class="si">{</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; to &#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

        <span class="k">del</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="n">args</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>

        <span class="kn">from</span> <span class="nn">.llamacpp</span> <span class="kn">import</span> <span class="n">LlamaCppModel</span>

        <span class="n">model</span> <span class="o">=</span> <span class="n">LlamaCppModel</span><span class="p">(</span><span class="n">genconf</span><span class="o">=</span><span class="n">genconf</span><span class="p">,</span>
                              <span class="o">**</span><span class="n">args</span><span class="p">)</span>


    <span class="k">elif</span> <span class="n">provider</span> <span class="o">==</span> <span class="s2">&quot;openai&quot;</span><span class="p">:</span>

        <span class="kn">from</span> <span class="nn">.openai</span> <span class="kn">import</span> <span class="n">OpenAIModel</span>

        <span class="n">model</span> <span class="o">=</span> <span class="n">OpenAIModel</span><span class="p">(</span><span class="n">genconf</span><span class="o">=</span><span class="n">genconf</span><span class="p">,</span>
                            <span class="o">**</span><span class="n">args</span><span class="p">)</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;            </span>
<span class="sd">    elif provider == &quot;hf&quot;:</span>
<span class="sd">        from .hf import HFModel</span>

<span class="sd">        model = HFModel(genconf=genconf,</span>
<span class="sd">                        **args)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">model</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>







<div class="doc doc-object doc-function">



<h4 id="sibila.ModelDir.clear" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">clear</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">clear</span><span class="p">()</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Clear the model directory.</p>

          <details class="quote">
            <summary>Source code in <code>sibila/modeldir.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Clear the model directory.&quot;&quot;&quot;</span>
    <span class="bp">cls</span><span class="o">.</span><span class="n">dir</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">cls</span><span class="o">.</span><span class="n">search_path</span> <span class="o">=</span> <span class="p">[]</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>




  </div>

  </div>


</div>

<div class="doc doc-object doc-class">



<h3 id="sibila.FormatDir" class="doc doc-heading">
          <span class="doc doc-object-name doc-class-name">FormatDir</span>


</h3>


  <div class="doc doc-contents first">

  
      <p>A singleton to store chat templates for the fine-tuned models used in Sibila.</p>
<p>Detects chat templates from model name/filename or uses from metadata if possible.</p>
<p>This directory can be setup from a JSON file or by calling add().</p>
<p>Any new directory entries with the same name replace previous ones on each new call.</p>
<p>Initializes from file base_formatdir.json in this module's directory.</p>
<p>This env variable is checked during initialization to load from a file:</p>
<pre><code>SIBILA_FORMAT_CONF: path of a JSON configuration file to add().
</code></pre>
<p>An example of a format directory JSON config file:</p>
<pre><code>{
    &quot;chatml&quot;: {
        # template is a Jinja2 template for this model
        &quot;template&quot;: &quot;{% for message in messages %}...&quot;
    },

    &quot;openchat&quot;: {
        &quot;match&quot;: &quot;openchat.3&quot;, # a regexp to match model name or filename
        &quot;template&quot;: &quot;{{ bos_token }}...&quot;
    },    

    &quot;phi2&quot;: {
        &quot;match&quot;: &quot;phi-2&quot;,
        &quot;template&quot;: &quot;...&quot;
    },

    &quot;phi&quot;: &quot;phi2&quot;,
    # this is an alias &quot;phi&quot; -&gt; &quot;phi2&quot;
}
</code></pre>
<p>Jinja2 templates receive a standard ChatML messages list (created from a Thread) and must deal with the following:</p>
<ul>
<li>
<p>In models that don't use a system message, template must take care of prepending it to first user message.</p>
</li>
<li>
<p>The add_generation_prompt template variable is always set as True.</p>
</li>
</ul>


  

  <div class="doc doc-children">








<div class="doc doc-object doc-function">



<h4 id="sibila.FormatDir.add" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">add</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">add</span><span class="p">(</span><span class="n">conf_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">conf</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Add a JSON file or configuration dict to the format directory.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>conf_path</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Path to a JSON file with dirctory configuration. See class <strong>doc</strong> for format. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>conf</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A dict with configuration as if loaded from JSON by json.loads(). Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Raises:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#TypeError">TypeError</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Only one of conf_path or conf can be given.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>sibila/formatdir.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span>
        <span class="n">conf_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">conf</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add a JSON file or configuration dict to the format directory.</span>

<span class="sd">    Args:</span>
<span class="sd">        conf_path: Path to a JSON file with dirctory configuration. See class __doc__ for format. Defaults to None.</span>
<span class="sd">        conf: A dict with configuration as if loaded from JSON by json.loads(). Defaults to None.</span>

<span class="sd">    Raises:</span>
<span class="sd">        TypeError: Only one of conf_path or conf can be given.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">expand_path</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;~&#39;</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="p">((</span><span class="n">conf_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">conf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;One of conf_path or conf must be given&quot;</span><span class="p">)</span>

    <span class="bp">cls</span><span class="o">.</span><span class="n">ensure</span><span class="p">()</span>

    <span class="c1"># conf directory loading</span>
    <span class="k">if</span> <span class="n">conf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">dir</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">update_dir_json</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">dir</span><span class="p">,</span> <span class="n">conf_path</span><span class="p">)</span>

    <span class="bp">cls</span><span class="o">.</span><span class="n">_sanity_check</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>







<div class="doc doc-object doc-function">



<h4 id="sibila.FormatDir.get" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">get</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Get a format entry by name, following aliases if required.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>name</code></td>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Format name.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a>, None]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Format dict with chat template.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>sibila/formatdir.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span><span class="kc">None</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get a format entry by name, following aliases if required.</span>

<span class="sd">    Args:</span>
<span class="sd">        name: Format name.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Format dict with chat template.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="bp">cls</span><span class="o">.</span><span class="n">ensure</span><span class="p">()</span>

    <span class="n">na</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">while</span> <span class="n">na</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">dir</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">val</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">dir</span><span class="p">[</span><span class="n">na</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span> <span class="c1"># str means link -&gt; follow it</span>
            <span class="n">na</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FormatDir get(&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;): found &#39;</span><span class="si">{</span><span class="n">na</span><span class="si">}</span><span class="s2">&#39; entry&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_prepare_entry</span><span class="p">(</span><span class="n">na</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>







<div class="doc doc-object doc-function">



<h4 id="sibila.FormatDir.search" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">search</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">search</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Search for model name or filename in the registry.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>model_id</code></td>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Name of filename of model.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a>, None]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Format dict with chat template or None if none found.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>sibila/formatdir.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">search</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span>
           <span class="n">model_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span><span class="kc">None</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Search for model name or filename in the registry.</span>

<span class="sd">    Args:</span>
<span class="sd">        model_id: Name of filename of model.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Format dict with chat template or None if none found.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Todo: cache compiled re patterns in &quot;_re&quot; entries</span>

    <span class="bp">cls</span><span class="o">.</span><span class="n">ensure</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">dir</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span> <span class="c1"># a link: ignore when searching</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="s2">&quot;match&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">val</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">patterns</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="s2">&quot;match&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">patterns</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">patterns</span> <span class="o">=</span> <span class="p">[</span><span class="n">patterns</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">pat</span> <span class="ow">in</span> <span class="n">patterns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pat</span><span class="p">,</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FormatDir search(&#39;</span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2">&#39;): found &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; entry&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_prepare_entry</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>







<div class="doc doc-object doc-function">



<h4 id="sibila.FormatDir.info" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">info</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">info</span><span class="p">()</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Format directory listing.</p>

          <details class="quote">
            <summary>Source code in <code>sibila/formatdir.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Format directory listing.&quot;&quot;&quot;</span>
    <span class="n">out</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">out</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Directory: </span><span class="si">{</span><span class="n">pformat</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">dir</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">out</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>







<div class="doc doc-object doc-function">



<h4 id="sibila.FormatDir.clear" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">clear</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">clear</span><span class="p">()</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Clear the model directory.</p>

          <details class="quote">
            <summary>Source code in <code>sibila/formatdir.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Clear the model directory.&quot;&quot;&quot;</span>
    <span class="bp">cls</span><span class="o">.</span><span class="n">dir</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>




  </div>

  </div>


</div><h2 id="multigen">Multigen</h2>


<div class="doc doc-object doc-module">



<h3 id="sibila.multigen" class="doc doc-heading">
          <span class="doc doc-object-name doc-module-name">multigen</span>


</h3>

  <div class="doc doc-contents first">
  
      <p>Functions for comparing output across models.</p>
<ul>
<li>thread_multigen(), query_multigen() and multigen(): Compare single output across models.</li>
<li>cycle_gen_print(): For a list of models, sequentially grow a Thread with model responses to given IN messages.</li>
</ul>

  

  <div class="doc doc-children">








<div class="doc doc-object doc-function">



<h4 id="sibila.multigen.thread_multigen" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">thread_multigen</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">thread_multigen</span><span class="p">(</span>
    <span class="n">threads</span><span class="p">,</span>
    <span class="n">model_names</span><span class="p">,</span>
    <span class="n">text</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">csv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">gencall</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">genconf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">out_keys</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;dic&quot;</span><span class="p">,</span> <span class="s2">&quot;obj&quot;</span><span class="p">],</span>
    <span class="n">thread_titles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Generate a single thread on a list of models, returning/saving results in text/CSV.</p>

<details class="actual-generation-for-each-model-is-implemented-by-an-optional-callable-with-this-signature" open>
  <summary>Actual generation for each model is implemented by an optional Callable with this signature</summary>
  <p>def gencall(model: Model,
            thread: Thread,
            genconf: GenConf) -&gt; GenOut</p>
</details>


  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>threads</code></td>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a>[<a class="autorefs autorefs-internal" title="sibila.thread.Thread" href="#sibila.Thread">Thread</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>List of threads to input into each model.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>model_names</code></td>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A list of ModelDir names.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>text</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>], None]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>An str list with "print"=print results, path=a path to output a text file with results. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>csv</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>], None]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>An str list with "print"=print CSV results, path=a path to output a CSV file with results. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>gencall</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" title="typing.Callable" href="https://docs.python.org/3/library/typing.html#typing.Callable">Callable</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Callable function that does the actual generation. Defaults to None, which will use a text generation default function.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>genconf</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-internal" title="sibila.gen.GenConf" href="#sibila.GenConf">GenConf</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Model generation configuration to use in models. Defaults to None, meaning default values.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>out_keys</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A list with GenOut members to output. Defaults to ["text","dic", "obj"].</p>
            </div>
          </td>
          <td>
                <code>[&#39;text&#39;, &#39;dic&#39;, &#39;obj&#39;]</code>
          </td>
        </tr>
        <tr>
          <td><code>thread_titles</code></td>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A human-friendly title for each Thread. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A list of lists in the format [thread,model] of shape (len(threads), len(models)). For example: out[0] holds threads[0] results on all models, out[1]: threads[1] on all models, ...</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>sibila/multigen.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">thread_multigen</span><span class="p">(</span><span class="n">threads</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Thread</span><span class="p">],</span>
                    <span class="n">model_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>

                    <span class="n">text</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span><span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">csv</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span><span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>

                    <span class="n">gencall</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>                   
                    <span class="n">genconf</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GenConf</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>

                    <span class="n">out_keys</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">,</span><span class="s2">&quot;dic&quot;</span><span class="p">,</span> <span class="s2">&quot;obj&quot;</span><span class="p">],</span>

                    <span class="n">thread_titles</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>                   
                    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a single thread on a list of models, returning/saving results in text/CSV.</span>

<span class="sd">    Actual generation for each model is implemented by an optional Callable with this signature:</span>
<span class="sd">        def gencall(model: Model,</span>
<span class="sd">                    thread: Thread,</span>
<span class="sd">                    genconf: GenConf) -&gt; GenOut</span>

<span class="sd">    Args:</span>
<span class="sd">        threads: List of threads to input into each model.</span>
<span class="sd">        model_names: A list of ModelDir names.</span>
<span class="sd">        text: An str list with &quot;print&quot;=print results, path=a path to output a text file with results. Defaults to None.</span>
<span class="sd">        csv: An str list with &quot;print&quot;=print CSV results, path=a path to output a CSV file with results. Defaults to None.</span>
<span class="sd">        gencall: Callable function that does the actual generation. Defaults to None, which will use a text generation default function.</span>
<span class="sd">        genconf: Model generation configuration to use in models. Defaults to None, meaning default values.</span>
<span class="sd">        out_keys: A list with GenOut members to output. Defaults to [&quot;text&quot;,&quot;dic&quot;, &quot;obj&quot;].</span>
<span class="sd">        thread_titles: A human-friendly title for each Thread. Defaults to None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list of lists in the format [thread,model] of shape (len(threads), len(models)). For example: out[0] holds threads[0] results on all models, out[1]: threads[1] on all models, ...</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_names</span><span class="p">,</span> <span class="nb">list</span><span class="p">),</span> <span class="s2">&quot;model_names must be a list of strings&quot;</span>

    <span class="n">table</span> <span class="o">=</span> <span class="n">multigen</span><span class="p">(</span><span class="n">threads</span><span class="p">,</span>
                     <span class="n">model_names</span><span class="o">=</span><span class="n">model_names</span><span class="p">,</span> 
                     <span class="n">gencall</span><span class="o">=</span><span class="n">gencall</span><span class="p">,</span>
                     <span class="n">genconf</span><span class="o">=</span><span class="n">genconf</span><span class="p">)</span>

    <span class="c1"># table[threads,models]</span>

    <span class="k">if</span> <span class="n">thread_titles</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">thread_titles</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">th</span><span class="p">)</span> <span class="k">for</span> <span class="n">th</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">format</span><span class="p">(</span><span class="n">format_fn</span><span class="p">,</span> <span class="n">cmds</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">cmds</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">cmds</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">(</span><span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="n">format_fn</span><span class="p">(</span><span class="n">f</span><span class="p">,</span>
                  <span class="n">table</span><span class="p">,</span> 
                  <span class="n">title_list</span><span class="o">=</span><span class="n">thread_titles</span><span class="p">,</span>
                  <span class="n">model_names</span><span class="o">=</span><span class="n">model_names</span><span class="p">,</span>
                  <span class="n">out_keys</span><span class="o">=</span><span class="n">out_keys</span><span class="p">)</span>
        <span class="n">fmtd</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cmds</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">cmds</span> <span class="o">=</span> <span class="p">[</span><span class="n">cmds</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cmds</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;print&#39;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">fmtd</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># path</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fmtd</span><span class="p">)</span>

    <span class="nb">format</span><span class="p">(</span><span class="n">format_text</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="nb">format</span><span class="p">(</span><span class="n">format_csv</span><span class="p">,</span> <span class="n">csv</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">table</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>







<div class="doc doc-object doc-function">



<h4 id="sibila.multigen.query_multigen" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">query_multigen</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">query_multigen</span><span class="p">(</span>
    <span class="n">in_list</span><span class="p">,</span>
    <span class="n">inst_text</span><span class="p">,</span>
    <span class="n">model_names</span><span class="p">,</span>
    <span class="n">text</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">csv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">gencall</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">genconf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">out_keys</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;dic&quot;</span><span class="p">,</span> <span class="s2">&quot;obj&quot;</span><span class="p">],</span>
    <span class="n">in_titles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Generate an INST+IN thread on a list of models, returning/saving results in text/CSV.</p>

<details class="actual-generation-for-each-model-is-implemented-by-an-optional-callable-with-this-signature" open>
  <summary>Actual generation for each model is implemented by an optional Callable with this signature</summary>
  <p>def gencall(model: Model,
            thread: Thread,
            genconf: GenConf) -&gt; GenOut</p>
</details>


  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>in_list</code></td>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>List of IN messages to initialize Threads.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>inst_text</code></td>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The common INST to use in all models.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>model_names</code></td>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A list of ModelDir names.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>text</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>], None]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>An str list with "print"=print results, path=a path to output a text file with results. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>csv</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>], None]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>An str list with "print"=print CSV results, path=a path to output a CSV file with results. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>gencall</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" title="typing.Callable" href="https://docs.python.org/3/library/typing.html#typing.Callable">Callable</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Callable function that does the actual generation. Defaults to None, which will use a text generation default function.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>genconf</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-internal" title="sibila.gen.GenConf" href="#sibila.GenConf">GenConf</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Model generation configuration to use in models. Defaults to None, meaning default values.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>out_keys</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A list with GenOut members to output. Defaults to ["text","dic", "obj"].</p>
            </div>
          </td>
          <td>
                <code>[&#39;text&#39;, &#39;dic&#39;, &#39;obj&#39;]</code>
          </td>
        </tr>
        <tr>
          <td><code>in_titles</code></td>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A human-friendly title for each Thread. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A list of lists in the format [thread,model] of shape (len(threads), len(models)). For example: out[0] holds threads[0] results on all models, out[1]: threads[1] on all models, ...</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>sibila/multigen.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">query_multigen</span><span class="p">(</span><span class="n">in_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                   <span class="n">inst_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>                                                
                   <span class="n">model_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>

                   <span class="n">text</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span><span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># &quot;print&quot;, path</span>
                   <span class="n">csv</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span><span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># &quot;print&quot;, path</span>

                   <span class="n">gencall</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>                   
                   <span class="n">genconf</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GenConf</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>

                   <span class="n">out_keys</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">,</span><span class="s2">&quot;dic&quot;</span><span class="p">,</span> <span class="s2">&quot;obj&quot;</span><span class="p">],</span>
                   <span class="n">in_titles</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                   <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate an INST+IN thread on a list of models, returning/saving results in text/CSV.</span>

<span class="sd">    Actual generation for each model is implemented by an optional Callable with this signature:</span>
<span class="sd">        def gencall(model: Model,</span>
<span class="sd">                    thread: Thread,</span>
<span class="sd">                    genconf: GenConf) -&gt; GenOut</span>

<span class="sd">    Args:</span>
<span class="sd">        in_list: List of IN messages to initialize Threads.</span>
<span class="sd">        inst_text: The common INST to use in all models.</span>
<span class="sd">        model_names: A list of ModelDir names.</span>
<span class="sd">        text: An str list with &quot;print&quot;=print results, path=a path to output a text file with results. Defaults to None.</span>
<span class="sd">        csv: An str list with &quot;print&quot;=print CSV results, path=a path to output a CSV file with results. Defaults to None.</span>
<span class="sd">        gencall: Callable function that does the actual generation. Defaults to None, which will use a text generation default function.</span>
<span class="sd">        genconf: Model generation configuration to use in models. Defaults to None, meaning default values.</span>
<span class="sd">        out_keys: A list with GenOut members to output. Defaults to [&quot;text&quot;,&quot;dic&quot;, &quot;obj&quot;].</span>
<span class="sd">        in_titles: A human-friendly title for each Thread. Defaults to None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list of lists in the format [thread,model] of shape (len(threads), len(models)). For example: out[0] holds threads[0] results on all models, out[1]: threads[1] on all models, ...</span>
<span class="sd">    &quot;&quot;&quot;</span>    

    <span class="n">th_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">in_text</span> <span class="ow">in</span> <span class="n">in_list</span><span class="p">:</span>
        <span class="n">th</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="n">make_INST_IN</span><span class="p">(</span><span class="n">inst_text</span><span class="p">,</span> <span class="n">in_text</span><span class="p">)</span>
        <span class="n">th_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">th</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">in_titles</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">in_titles</span> <span class="o">=</span> <span class="n">in_list</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">thread_multigen</span><span class="p">(</span><span class="n">th_list</span><span class="p">,</span>                     
                          <span class="n">model_names</span><span class="o">=</span><span class="n">model_names</span><span class="p">,</span> 
                          <span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">,</span>
                          <span class="n">csv</span><span class="o">=</span><span class="n">csv</span><span class="p">,</span>
                          <span class="n">gencall</span><span class="o">=</span><span class="n">gencall</span><span class="p">,</span>
                          <span class="n">genconf</span><span class="o">=</span><span class="n">genconf</span><span class="p">,</span>
                          <span class="n">out_keys</span><span class="o">=</span><span class="n">out_keys</span><span class="p">,</span>
                          <span class="n">thread_titles</span><span class="o">=</span><span class="n">in_titles</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">out</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>







<div class="doc doc-object doc-function">



<h4 id="sibila.multigen.multigen" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">multigen</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">multigen</span><span class="p">(</span>
    <span class="n">threads</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">models</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">model_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">model_names_del_after</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">gencall</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">genconf</span><span class="o">=</span><span class="kc">None</span>
<span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Generate a list of Threads in multiple models, returning the GenOut for each [thread,model] combination.</p>

<details class="actual-generation-for-each-model-is-implemented-by-the-gencall-arg-callable-with-this-signature" open>
  <summary>Actual generation for each model is implemented by the gencall arg Callable with this signature</summary>
  <p>def gencall(model: Model,
            thread: Thread,
            genconf: GenConf) -&gt; GenOut</p>
</details>


  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>threads</code></td>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a>[<a class="autorefs autorefs-internal" title="sibila.thread.Thread" href="#sibila.Thread">Thread</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>List of threads to input into each model.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>models</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a>[<span title="sibila.model.Model">Model</span>]]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A list of initialized models. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>model_names</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>--Or-- A list of ModelDir names. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>model_names_del_after</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Delete model_names models after using them: important or an out-of-memory error will eventually happen. Defaults to True.</p>
            </div>
          </td>
          <td>
                <code>True</code>
          </td>
        </tr>
        <tr>
          <td><code>gencall</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" title="typing.Callable" href="https://docs.python.org/3/library/typing.html#typing.Callable">Callable</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Callable function that does the actual generation. Defaults to None, which will use a text generation default function.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>genconf</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-internal" title="sibila.gen.GenConf" href="#sibila.GenConf">GenConf</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Model generation configuration to use in models. Defaults to None, meaning default values.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Raises:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#ValueError">ValueError</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Only one of models or model_names can be given.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a>[<a class="autorefs autorefs-internal" title="sibila.gen.GenOut" href="#sibila.GenOut">GenOut</a>]]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A list of lists in the format [thread,model] of shape (len(threads), len(models)). For example: out[0] holds threads[0] results on all models, out[1]: threads[1] on all models, ...</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>sibila/multigen.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">multigen</span><span class="p">(</span><span class="n">threads</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Thread</span><span class="p">],</span>
             <span class="o">*</span><span class="p">,</span>
             <span class="n">models</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">Model</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># existing models</span>

             <span class="n">model_names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">model_names_del_after</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>

             <span class="n">gencall</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">genconf</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GenConf</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
             <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">GenOut</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a list of Threads in multiple models, returning the GenOut for each [thread,model] combination.</span>

<span class="sd">    Actual generation for each model is implemented by the gencall arg Callable with this signature:</span>
<span class="sd">        def gencall(model: Model,</span>
<span class="sd">                    thread: Thread,</span>
<span class="sd">                    genconf: GenConf) -&gt; GenOut</span>

<span class="sd">    Args:</span>
<span class="sd">        threads: List of threads to input into each model.</span>
<span class="sd">        models: A list of initialized models. Defaults to None.</span>
<span class="sd">        model_names: --Or-- A list of ModelDir names. Defaults to None.</span>
<span class="sd">        model_names_del_after: Delete model_names models after using them: important or an out-of-memory error will eventually happen. Defaults to True.</span>
<span class="sd">        gencall: Callable function that does the actual generation. Defaults to None, which will use a text generation default function.</span>
<span class="sd">        genconf: Model generation configuration to use in models. Defaults to None, meaning default values.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: Only one of models or model_names can be given.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list of lists in the format [thread,model] of shape (len(threads), len(models)). For example: out[0] holds threads[0] results on all models, out[1]: threads[1] on all models, ...</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="p">((</span><span class="n">models</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">^</span> <span class="p">((</span><span class="n">model_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">))):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Only one of models or model_names can be given&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">gencall</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">gencall</span> <span class="o">=</span> <span class="n">_default_gencall_text</span>

    <span class="n">mod_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">)</span> <span class="k">if</span> <span class="n">models</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_names</span><span class="p">)</span>

    <span class="n">all_out</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mod_count</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">models</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model: </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">desc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">model_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">ModelDir</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">desc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">mod_out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">th</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">gencall</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">th</span><span class="p">,</span> <span class="n">genconf</span><span class="p">)</span>

            <span class="n">mod_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

        <span class="n">all_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mod_out</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">model_names_del_after</span> <span class="ow">and</span> <span class="n">models</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">model</span>

    <span class="c1"># all_out is currently shaped (M,T) -&gt; transpose to (T,M), so that each row contains thread t for all models</span>
    <span class="n">tout</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">threads</span><span class="p">)):</span>
        <span class="n">tmout</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># thread t for all models</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mod_count</span><span class="p">):</span>
            <span class="n">tmout</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">all_out</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="n">t</span><span class="p">])</span>

        <span class="n">tout</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmout</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tout</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>







<div class="doc doc-object doc-function">



<h4 id="sibila.multigen.cycle_gen_print" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">cycle_gen_print</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">cycle_gen_print</span><span class="p">(</span>
    <span class="n">in_list</span><span class="p">,</span>
    <span class="n">inst_text</span><span class="p">,</span>
    <span class="n">model_names</span><span class="p">,</span>
    <span class="n">gencall</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">genconf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">out_keys</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;dic&quot;</span><span class="p">,</span> <span class="s2">&quot;obj&quot;</span><span class="p">],</span>
    <span class="n">json_kwargs</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;indent&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s2">&quot;sort_keys&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;ensure_ascii&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>For a list of models, sequentially grow a Thread with model responses to given IN messages and print the results.</p>
<p>Works by doing:</p>
<pre><code>1) Generate an INST+IN prompt for a list of models. (Same INST for all).
2) Append the output of each model to its own Thread.
3) Append the next IN prompt and generate again. Back to 2.
</code></pre>

<details class="actual-generation-for-each-model-is-implemented-by-an-optional-callable-with-this-signature" open>
  <summary>Actual generation for each model is implemented by an optional Callable with this signature</summary>
  <p>def gencall(model: Model,
            thread: Thread,
            genconf: GenConf) -&gt; GenOut</p>
</details>


  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>in_list</code></td>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>List of IN messages to initialize Threads.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>inst_text</code></td>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The common INST to use in all models.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>model_names</code></td>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A list of ModelDir names.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>gencall</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" title="typing.Callable" href="https://docs.python.org/3/library/typing.html#typing.Callable">Callable</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Callable function that does the actual generation. Defaults to None, which will use a text generation default function.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>genconf</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-internal" title="sibila.gen.GenConf" href="#sibila.GenConf">GenConf</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Model generation configuration to use in models. Defaults to None, meaning default values.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>out_keys</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A list with GenOut members to output. Defaults to ["text","dic", "obj"].</p>
            </div>
          </td>
          <td>
                <code>[&#39;text&#39;, &#39;dic&#39;, &#39;obj&#39;]</code>
          </td>
        </tr>
        <tr>
          <td><code>json_kwargs</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>JSON dumps() configuration. Defaults to {"indent": 2, "sort_keys": False, "ensure_ascii": False }.</p>
            </div>
          </td>
          <td>
                <code>{&#39;indent&#39;: 2, &#39;sort_keys&#39;: False, &#39;ensure_ascii&#39;: False}</code>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>sibila/multigen.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">cycle_gen_print</span><span class="p">(</span><span class="n">in_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                    <span class="n">inst_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>                                                
                    <span class="n">model_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>

                    <span class="n">gencall</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>                   
                    <span class="n">genconf</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GenConf</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>

                    <span class="n">out_keys</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">,</span><span class="s2">&quot;dic&quot;</span><span class="p">,</span> <span class="s2">&quot;obj&quot;</span><span class="p">],</span>

                    <span class="n">json_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;indent&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                                                   <span class="s2">&quot;sort_keys&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                                   <span class="s2">&quot;ensure_ascii&quot;</span><span class="p">:</span> <span class="kc">False</span>
                                                   <span class="p">}</span>
                    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;For a list of models, sequentially grow a Thread with model responses to given IN messages and print the results.</span>

<span class="sd">    Works by doing:</span>
<span class="sd">    ```</span>
<span class="sd">    1) Generate an INST+IN prompt for a list of models. (Same INST for all).</span>
<span class="sd">    2) Append the output of each model to its own Thread.</span>
<span class="sd">    3) Append the next IN prompt and generate again. Back to 2.</span>
<span class="sd">    ```</span>

<span class="sd">    Actual generation for each model is implemented by an optional Callable with this signature:</span>
<span class="sd">        def gencall(model: Model,</span>
<span class="sd">                    thread: Thread,</span>
<span class="sd">                    genconf: GenConf) -&gt; GenOut</span>

<span class="sd">    Args:</span>
<span class="sd">        in_list: List of IN messages to initialize Threads.</span>
<span class="sd">        inst_text: The common INST to use in all models.</span>
<span class="sd">        model_names: A list of ModelDir names.</span>
<span class="sd">        gencall: Callable function that does the actual generation. Defaults to None, which will use a text generation default function.</span>
<span class="sd">        genconf: Model generation configuration to use in models. Defaults to None, meaning default values.</span>
<span class="sd">        out_keys: A list with GenOut members to output. Defaults to [&quot;text&quot;,&quot;dic&quot;, &quot;obj&quot;].</span>
<span class="sd">        json_kwargs: JSON dumps() configuration. Defaults to {&quot;indent&quot;: 2, &quot;sort_keys&quot;: False, &quot;ensure_ascii&quot;: False }.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_names</span><span class="p">,</span> <span class="nb">list</span><span class="p">),</span> <span class="s2">&quot;model_names must be a list of strings&quot;</span>

    <span class="k">if</span> <span class="n">gencall</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">gencall</span> <span class="o">=</span> <span class="n">_default_gencall_text</span>


    <span class="n">n_model</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_names</span><span class="p">)</span>
    <span class="n">n_ins</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">in_list</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_model</span><span class="p">):</span>

        <span class="n">name</span> <span class="o">=</span> <span class="n">model_names</span><span class="p">[</span><span class="n">m</span><span class="p">]</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">ModelDir</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">desc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">th</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">inst</span><span class="o">=</span><span class="n">inst_text</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_ins</span><span class="p">):</span>
            <span class="n">in_text</span> <span class="o">=</span> <span class="n">in_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;IN: </span><span class="si">{</span><span class="n">in_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">th</span> <span class="o">+=</span> <span class="p">(</span><span class="n">MsgKind</span><span class="o">.</span><span class="n">IN</span><span class="p">,</span> <span class="n">in_text</span><span class="p">)</span>

            <span class="n">out</span> <span class="o">=</span> <span class="n">gencall</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">th</span><span class="p">,</span> <span class="n">genconf</span><span class="p">)</span>

            <span class="n">out_dict</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">asdict</span><span class="p">()</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;OUT&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">out_keys</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">out_dict</span> <span class="ow">and</span> <span class="n">out_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                    <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="n">out_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="c1"># not first</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">20</span><span class="p">)</span>

                    <span class="n">val</span> <span class="o">=</span> <span class="n">nice_print</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">out_dict</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">json_kwargs</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

            <span class="n">th</span> <span class="o">+=</span> <span class="p">(</span><span class="n">MsgKind</span><span class="o">.</span><span class="n">OUT</span><span class="p">,</span> <span class="n">out</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

        <span class="k">del</span> <span class="n">model</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>




  </div>

  </div>

</div><h2 id="tools">Tools</h2>


<div class="doc doc-object doc-module">



<h3 id="sibila.tools" class="doc doc-heading">
          <span class="doc doc-object-name doc-module-name">tools</span>


</h3>

  <div class="doc doc-contents first">
  
      <p>Tools for model interaction, summarization, etc.</p>
<ul>
<li>interact(): Interact with model as in a chat, using input().</li>
<li>loop(): Iteratively append inputs and generate model outputs.</li>
<li>recursive_summarize(): Recursively summarize a (large) text or text file.</li>
</ul>

  

  <div class="doc doc-children">








<div class="doc doc-object doc-function">



<h4 id="sibila.tools.interact" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">interact</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">interact</span><span class="p">(</span>
    <span class="n">model</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">ctx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">inst_text</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">trim_flags</span><span class="o">=</span><span class="n">TRIM_DEFAULT</span><span class="p">,</span>
    <span class="n">genconf</span><span class="o">=</span><span class="kc">None</span>
<span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Interact with model as in a chat, using input().</p>
<p>Includes a list of commands: type !? to see help.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>model</code></td>
          <td>
                <code><span title="sibila.model.Model">Model</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Model to use for generating.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>ctx</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-internal" title="sibila.context.Context" href="#sibila.Context">Context</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Optional input Context. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>inst_text</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>text for Thread instructions. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>trim_flags</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-internal" title="sibila.context.Trim" href="#sibila.Trim">Trim</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Context trimming flags, when Thread is too long. Defaults to TRIM_DEFAULT.</p>
            </div>
          </td>
          <td>
                <code><span title="sibila.tools.TRIM_DEFAULT">TRIM_DEFAULT</span></code>
          </td>
        </tr>
        <tr>
          <td><code>genconf</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-internal" title="sibila.gen.GenConf" href="#sibila.GenConf">GenConf</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Model generation configuration. Defaults to None, defaults to model's.    </p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-internal" title="sibila.context.Context" href="#sibila.Context">Context</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Context after all the interactions.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>sibila/tools.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">interact</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">Model</span><span class="p">,</span>
             <span class="o">*</span><span class="p">,</span>
             <span class="n">ctx</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Context</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">inst_text</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">trim_flags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Trim</span><span class="p">]</span> <span class="o">=</span> <span class="n">TRIM_DEFAULT</span><span class="p">,</span>

             <span class="n">genconf</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GenConf</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Context</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Interact with model as in a chat, using input().</span>

<span class="sd">    Includes a list of commands: type !? to see help.</span>

<span class="sd">    Args:</span>
<span class="sd">        model: Model to use for generating.</span>
<span class="sd">        ctx: Optional input Context. Defaults to None.</span>
<span class="sd">        inst_text: text for Thread instructions. Defaults to None.</span>
<span class="sd">        trim_flags: Context trimming flags, when Thread is too long. Defaults to TRIM_DEFAULT.</span>
<span class="sd">        genconf: Model generation configuration. Defaults to None, defaults to model&#39;s.    </span>

<span class="sd">    Returns:</span>
<span class="sd">        Context after all the interactions.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="n">out</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">GenOut</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span> 
                 <span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> 
                 <span class="n">model</span><span class="p">:</span> <span class="n">Model</span><span class="p">,</span>
                 <span class="n">genconf</span><span class="p">:</span> <span class="n">GenConf</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">out</span><span class="o">.</span><span class="n">res</span> <span class="o">!=</span> <span class="n">GenRes</span><span class="o">.</span><span class="n">OK_STOP</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;***Result=</span><span class="si">{</span><span class="n">GenRes</span><span class="o">.</span><span class="n">as_text</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">res</span><span class="p">)</span><span class="si">}</span><span class="s2">***&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">out</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">text</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;***No text out***&quot;</span>

            <span class="n">ctx</span><span class="o">.</span><span class="n">add_OUT</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>


        <span class="k">def</span> <span class="nf">print_thread_info</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">ctx</span><span class="o">.</span><span class="n">max_token_len</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># use from ctx</span>
                <span class="n">max_token_len</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">max_token_len</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># assume max possible for model context and genconf</span>
                <span class="n">max_token_len</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">ctx_len</span> <span class="o">-</span> <span class="n">genconf</span><span class="o">.</span><span class="n">max_tokens</span>

            <span class="n">length</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">token_len</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">genconf</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Thread token len=</span><span class="si">{</span><span class="n">length</span><span class="si">}</span><span class="s2">, max len before next gen=</span><span class="si">{</span><span class="n">max_token_len</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>



        <span class="c1"># input loop ===============================================</span>
        <span class="n">MARKER</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&quot;&quot;&quot;&#39;</span>
        <span class="n">multiline</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>

            <span class="n">user</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">multiline</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">MARKER</span><span class="p">):</span>
                    <span class="n">user</span> <span class="o">=</span> <span class="n">multiline</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">user</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
                    <span class="n">multiline</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">multiline</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">user</span>
                    <span class="k">continue</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span> <span class="c1"># terminate loop</span>

                <span class="k">elif</span> <span class="n">user</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">MARKER</span><span class="p">):</span>
                    <span class="n">multiline</span> <span class="o">=</span> <span class="n">user</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>
                    <span class="k">continue</span>

                <span class="k">elif</span> <span class="n">user</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">):</span>
                    <span class="n">user</span> <span class="o">=</span> <span class="n">user</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">user</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">n&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">ctx</span><span class="o">.</span><span class="n">add_IN</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="k">elif</span> <span class="n">user</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;!&quot;</span><span class="p">):</span> <span class="c1"># a command</span>
                    <span class="n">params</span> <span class="o">=</span> <span class="n">user</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)</span>
                    <span class="n">cmd</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

                    <span class="k">if</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;sys&quot;</span><span class="p">:</span>
                        <span class="n">ctx</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">params</span><span class="p">:</span>
                            <span class="n">text</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">n&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="n">ctx</span><span class="o">.</span><span class="n">set_sys</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

                    <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;append&quot;</span> <span class="ow">or</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;a&quot;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">params</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">path</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                <span class="n">ctx</span><span class="o">.</span><span class="n">appendx</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">)</span>
                                <span class="n">ct</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">last</span><span class="o">.</span><span class="n">text</span>
                                <span class="nb">print</span><span class="p">(</span><span class="n">ct</span><span class="p">[:</span><span class="mi">500</span><span class="p">])</span>
                            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not load &#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Path needed&quot;</span><span class="p">)</span>

                    <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span>
                        <span class="n">print_thread_info</span><span class="p">()</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>

                    <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s1">&#39;cl&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">params</span><span class="p">:</span>
                            <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;ctx.json&quot;</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">ctx</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded context from </span><span class="si">{</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not load &#39;</span><span class="si">{</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

                    <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s1">&#39;cs&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">params</span><span class="p">:</span>
                            <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;ctx.json&quot;</span><span class="p">)</span>
                        <span class="n">ctx</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved context to </span><span class="si">{</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s1">&#39;tl&#39;</span><span class="p">:</span>
                        <span class="n">print_thread_info</span><span class="p">()</span>

                    <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s1">&#39;i&#39;</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model:</span><span class="se">\n</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">info</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;GenConf:</span><span class="se">\n</span><span class="si">{</span><span class="n">genconf</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

                        <span class="n">print_thread_info</span><span class="p">()</span>

                    <span class="c1"># elif cmd == &#39;p&#39;:</span>
                    <span class="c1">#     print(model.text_from_turns(ctx.turns))</span>

                    <span class="c1"># elif cmd == &#39;to&#39;:</span>
                    <span class="c1">#     token_ids = model.tokens_from_turns(ctx.turns)</span>
                    <span class="c1">#     print(f&quot;Prompt tokens={token_ids}&quot;)</span>


                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown command &#39;!</span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s2">&#39; - known commands:</span><span class="se">\n</span><span class="s2">&quot;</span>
                              <span class="s2">&quot; !sys[=text] - clear messages and add sys message</span><span class="se">\n</span><span class="s2">&quot;</span>
                              <span class="s2">&quot; !append|!a=path - load file and append to last msg</span><span class="se">\n</span><span class="s2">&quot;</span>
                              <span class="s2">&quot; !c - list context msgs</span><span class="se">\n</span><span class="s2">&quot;</span>
                              <span class="s2">&quot; !cl=path - load context (default=ctx.json)</span><span class="se">\n</span><span class="s2">&quot;</span>
                              <span class="s2">&quot; !cs=path - save context (default=ctx.json)</span><span class="se">\n</span><span class="s2">&quot;</span>
                              <span class="s2">&quot; !tl - thread&#39;s token length</span><span class="se">\n</span><span class="s2">&quot;</span>
                              <span class="s2">&quot; !i - model and genconf info</span><span class="se">\n</span><span class="s2">&quot;</span>
                              <span class="s1">&#39; Delimit with &quot;&quot;&quot; for multiline begin/end or terminate line with </span><span class="se">\\</span><span class="s1"> to continue into a new line</span><span class="se">\n</span><span class="s1">&#39;</span>
                              <span class="s2">&quot; Empty line + enter to quit&quot;</span>
                              <span class="p">)</span>
                        <span class="c1"># &quot; !p - show formatted prompt (if model supports it)\n&quot;</span>
                        <span class="c1"># &quot; !to - prompt&#39;s tokens\n&quot;</span>

                    <span class="k">continue</span>

            <span class="c1"># we have a user prompt</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">n&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">break</span>


        <span class="n">ctx</span><span class="o">.</span><span class="n">add_IN</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">True</span> <span class="c1"># continue looping</span>



    <span class="c1"># start prompt loop</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="n">loop</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span>
               <span class="n">model</span><span class="p">,</span>

               <span class="n">ctx</span><span class="o">=</span><span class="n">ctx</span><span class="p">,</span>
               <span class="n">inst_text</span><span class="o">=</span><span class="n">inst_text</span><span class="p">,</span>
               <span class="n">in_text</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="c1"># call callback for first prompt</span>
               <span class="n">trim_flags</span><span class="o">=</span><span class="n">trim_flags</span><span class="p">,</span>
               <span class="n">genconf</span><span class="o">=</span><span class="n">genconf</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ctx</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>







<div class="doc doc-object doc-function">



<h4 id="sibila.tools.loop" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">loop</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">loop</span><span class="p">(</span>
    <span class="n">callback</span><span class="p">,</span>
    <span class="n">model</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">inst_text</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">in_text</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">trim_flags</span><span class="o">=</span><span class="n">TRIM_DEFAULT</span><span class="p">,</span>
    <span class="n">ctx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">genconf</span><span class="o">=</span><span class="kc">None</span>
<span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Iteratively append inputs and generate model outputs.</p>
<p>Callback should call ctx.add_OUT(), ctx.add_IN() and return a bool to continue looping or not.</p>
<p>If last Thread msg is not MsgKind.IN, callback() will be called with out_text=None.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>callback</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Callable" href="https://docs.python.org/3/library/typing.html#typing.Callable">Callable</a>[[<a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-internal" title="sibila.gen.GenOut" href="#sibila.GenOut">GenOut</a>, None], <a class="autorefs autorefs-internal" title="sibila.context.Context" href="#sibila.Context">Context</a>, <span title="sibila.model.Model">Model</span>, <a class="autorefs autorefs-internal" title="sibila.gen.GenConf" href="#sibila.GenConf">GenConf</a>], <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A function(out, ctx, model) that will be iteratively called with model's output.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>model</code></td>
          <td>
                <code><span title="sibila.model.Model">Model</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Model to use for generating.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>inst_text</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>text for Thread instructions. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>in_text</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Text for Thread's initial MsgKind.IN. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>trim_flags</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-internal" title="sibila.context.Trim" href="#sibila.Trim">Trim</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Context trimming flags, when Thread is too long. Defaults to TRIM_DEFAULT.</p>
            </div>
          </td>
          <td>
                <code><span title="sibila.tools.TRIM_DEFAULT">TRIM_DEFAULT</span></code>
          </td>
        </tr>
        <tr>
          <td><code>ctx</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-internal" title="sibila.context.Context" href="#sibila.Context">Context</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Optional input Context. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>genconf</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-internal" title="sibila.gen.GenConf" href="#sibila.GenConf">GenConf</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Model generation configuration. Defaults to None, defaults to model's.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>sibila/tools.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">loop</span><span class="p">(</span><span class="n">callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Union</span><span class="p">[</span><span class="n">GenOut</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span> <span class="n">Context</span><span class="p">,</span> <span class="n">Model</span><span class="p">,</span> <span class="n">GenConf</span><span class="p">],</span> <span class="nb">bool</span><span class="p">],</span>
         <span class="n">model</span><span class="p">:</span> <span class="n">Model</span><span class="p">,</span>
         <span class="o">*</span><span class="p">,</span>
         <span class="n">inst_text</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
         <span class="n">in_text</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>

         <span class="n">trim_flags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Trim</span><span class="p">]</span> <span class="o">=</span> <span class="n">TRIM_DEFAULT</span><span class="p">,</span>
         <span class="n">ctx</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Context</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>

         <span class="n">genconf</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GenConf</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
         <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Iteratively append inputs and generate model outputs.</span>

<span class="sd">    Callback should call ctx.add_OUT(), ctx.add_IN() and return a bool to continue looping or not.</span>

<span class="sd">    If last Thread msg is not MsgKind.IN, callback() will be called with out_text=None.</span>

<span class="sd">    Args:</span>
<span class="sd">        callback: A function(out, ctx, model) that will be iteratively called with model&#39;s output.</span>
<span class="sd">        model: Model to use for generating.</span>
<span class="sd">        inst_text: text for Thread instructions. Defaults to None.</span>
<span class="sd">        in_text: Text for Thread&#39;s initial MsgKind.IN. Defaults to None.</span>
<span class="sd">        trim_flags: Context trimming flags, when Thread is too long. Defaults to TRIM_DEFAULT.</span>
<span class="sd">        ctx: Optional input Context. Defaults to None.</span>
<span class="sd">        genconf: Model generation configuration. Defaults to None, defaults to model&#39;s.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">ctx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="n">Context</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="n">ctx</span>

    <span class="k">if</span> <span class="n">inst_text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">inst</span> <span class="o">=</span> <span class="n">inst_text</span>
    <span class="k">if</span> <span class="n">in_text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">add_IN</span><span class="p">(</span><span class="n">in_text</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">genconf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">genconf</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">genconf</span>

    <span class="k">if</span> <span class="n">ctx</span><span class="o">.</span><span class="n">max_token_len</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># use from ctx</span>
        <span class="n">max_token_len</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">max_token_len</span>
    <span class="k">else</span><span class="p">:</span> <span class="c1"># assume max possible for model context and genconf</span>
        <span class="n">max_token_len</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">ctx_len</span> <span class="o">-</span> <span class="n">genconf</span><span class="o">.</span><span class="n">max_tokens</span>


    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ctx</span><span class="o">.</span><span class="n">last_kind</span> <span class="o">==</span> <span class="n">MsgKind</span><span class="o">.</span><span class="n">IN</span><span class="p">:</span>
            <span class="c1"># last is an IN message: we can trim and generate</span>

            <span class="n">ctx</span><span class="o">.</span><span class="n">trim</span><span class="p">(</span><span class="n">trim_flags</span><span class="p">,</span>
                     <span class="n">model</span><span class="p">,</span>
                     <span class="n">max_token_len</span><span class="o">=</span><span class="n">max_token_len</span><span class="p">,</span>
                     <span class="n">genconf</span><span class="o">=</span><span class="n">genconf</span>
                     <span class="p">)</span>

            <span class="n">out</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">gen_</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">genconf</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># first call</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">callback</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> 
                       <span class="n">ctx</span><span class="o">=</span><span class="n">ctx</span><span class="p">,</span> 
                       <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                       <span class="n">genconf</span><span class="o">=</span><span class="n">genconf</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="p">:</span>
            <span class="k">break</span>


    <span class="k">return</span> <span class="n">ctx</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>







<div class="doc doc-object doc-function">



<h4 id="sibila.tools.recursive_summarize" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">recursive_summarize</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">recursive_summarize</span><span class="p">(</span>
    <span class="n">model</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">overlap_size</span><span class="o">=</span><span class="mi">20</span>
<span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Recursively summarize a (large) text or text file.</p>
<p>Works by:</p>
<pre><code>1) Breaking text into chunks that fit models context.
2) Run model to summarize chunks.
3) Join summries and jump to 1) - do this until text size no longer decreases.
</code></pre>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>model</code></td>
          <td>
                <code><span title="sibila.model.Model">Model</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Model to use for summarizing.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>text</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Initial text.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>path</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>--Or-- A path to an UTF-8 text file.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>overlap_size</code></td>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Size in model tokens of the overlapping portions at begining and end of chunks.</p>
            </div>
          </td>
          <td>
                <code>20</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The summarized text.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>sibila/tools.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">recursive_summarize</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">Model</span><span class="p">,</span>
                        <span class="n">text</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">overlap_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Recursively summarize a (large) text or text file.</span>

<span class="sd">    Works by:</span>
<span class="sd">    ```</span>
<span class="sd">    1) Breaking text into chunks that fit models context.</span>
<span class="sd">    2) Run model to summarize chunks.</span>
<span class="sd">    3) Join summries and jump to 1) - do this until text size no longer decreases.</span>
<span class="sd">    ``` </span>

<span class="sd">    Args:</span>
<span class="sd">        model: Model to use for summarizing.</span>
<span class="sd">        text: Initial text.</span>
<span class="sd">        path: --Or-- A path to an UTF-8 text file.</span>
<span class="sd">        overlap_size: Size in model tokens of the overlapping portions at begining and end of chunks.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The summarized text.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Only one of text or path can be given&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="n">inst_text</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Your task is to do short summaries of text.&quot;&quot;&quot;</span>
    <span class="n">in_text</span> <span class="o">=</span> <span class="s2">&quot;Summarize the following text:</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="n">Context</span><span class="p">(</span><span class="n">pinned_inst_text</span><span class="o">=</span><span class="n">inst_text</span><span class="p">)</span>

    <span class="c1"># split initial text</span>
    <span class="n">max_token_len</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">ctx_len</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">genconf</span><span class="o">.</span><span class="n">max_tokens</span> <span class="o">-</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">token_len</span><span class="p">(</span><span class="n">inst_text</span> <span class="o">+</span> <span class="n">in_text</span><span class="p">)</span> <span class="o">+</span> <span class="mi">16</span><span class="p">)</span> 
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Max ctx token len </span><span class="si">{</span><span class="n">max_token_len</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">token_len_fn</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">token_len_lambda</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initial text token_len </span><span class="si">{</span><span class="n">token_len_fn</span><span class="p">(</span><span class="n">text</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">spl</span> <span class="o">=</span> <span class="n">RecursiveTextSplitter</span><span class="p">(</span><span class="n">max_token_len</span><span class="p">,</span> <span class="n">overlap_size</span><span class="p">,</span> <span class="n">len_fn</span><span class="o">=</span><span class="n">token_len_fn</span><span class="p">)</span>

    <span class="nb">round</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span> <span class="c1"># summarization rounds</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Round </span><span class="si">{</span><span class="nb">round</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">in_list</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">)</span>
        <span class="n">in_len</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">in_list</span><span class="p">])</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Split in </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">in_list</span><span class="p">)</span><span class="si">}</span><span class="s2"> parts, total len </span><span class="si">{</span><span class="n">in_len</span><span class="si">}</span><span class="s2"> chars&quot;</span><span class="p">)</span>

        <span class="n">out_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">in_list</span><span class="p">):</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">round</span><span class="si">}</span><span class="s2">&gt;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">30</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">ctx</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">add_IN</span><span class="p">(</span><span class="n">in_text</span><span class="p">)</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">add_IN</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

            <span class="n">out</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">gen_</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>        
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

            <span class="n">out_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

        <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_list</span><span class="p">)</span>

        <span class="n">out_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="c1"># sum([len(t) for t in out_list])</span>
        <span class="k">if</span> <span class="n">out_len</span> <span class="o">&gt;=</span> <span class="n">in_len</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">out_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">round</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">text</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>




  </div>

  </div>

</div><h2 id="dictype">Dictype</h2>


<div class="doc doc-object doc-module">



<h3 id="sibila.dictype" class="doc doc-heading">
          <span class="doc doc-object-name doc-module-name">dictype</span>


</h3>

  <div class="doc doc-contents first">
  
      <p>A simple way to define typed fields in a dict. Kind of a simpler and convenient pydantic for dicts.</p>
<p>A dictype is defined in python dict, where each entry represents a typed data field with an optional description.</p>
<p>For example:</p>
<pre><code>dictype = {
    &quot;summary&quot;: { &quot;type&quot;: str, &quot;desc&quot;: &quot;A general summary of stuff&quot; },
    &quot;names&quot;: { &quot;type&quot;: [str], &quot;desc&quot;: &quot;List of stuff names&quot; },
    &quot;cost&quot;: { &quot;type&quot;: float, &quot;desc&quot;: &quot;Cost of stuff&quot;, &quot;optional&quot;: True },
    &quot;kind&quot;: { &quot;type&quot;: [&quot;Open&quot;, &quot;Closed&quot;], &quot;desc&quot;: &quot;The kind of stuff&quot; },

    # For lists, desc can be split in list_description|item_description:
    &quot;colors&quot;: { &quot;type&quot;: [str], &quot;desc&quot;: &quot;Color list for stuff|Color names&quot; },

    # Or desc can be a list, first item for the list, second for its items: 
    &quot;colors2&quot;: { &quot;type&quot;: [str], &quot;desc&quot;: [&quot;Color list for stuff&quot;, &quot;Color names&quot;] },
}
</code></pre>
<h4 id="sibila.dictype--allowed-types">Allowed types</h4>
<pre><code>Primitive types:
    bool
    int
    float
    str
</code></pre>
<pre><code>Enums: Represented by a list of values (only primitive types).
    For example:

    &quot;kind&quot;: { &quot;type&quot;: [&quot;Open&quot;, &quot;Closed&quot;], &quot;desc&quot;: &quot;The kind of stuff&quot; },
</code></pre>
<pre><code>Lists: A list of an allowed type.
    For example to define an str list (note the [] around str):

    &quot;names&quot;: { &quot;type&quot;: [str], &quot;desc&quot;: &quot;List of stuff names&quot; },
</code></pre>
<pre><code>Dicts: A field can also be a dict, which allows for composing hierarchies.
    For example, person_type is first defined and then used below:

    person_type = {
        &quot;name&quot;: { &quot;type&quot;: str, &quot;desc&quot;: &quot;Name of person&quot; },
        &quot;occupation&quot;: { &quot;type&quot;: str, &quot;desc&quot;: &quot;Person's occupation&quot; },
    }

    team_type = {
        &quot;chief&quot;: {&quot;type&quot;: person_type, &quot;desc&quot;: &quot;Team's chief&quot;},
        &quot;members&quot;: {&quot;type&quot;: [person_type], &quot;desc&quot;: &quot;List of team members&quot;}
    }
</code></pre>
<h4 id="sibila.dictype--alternative-shorter-notation">Alternative shorter notation</h4>
<pre><code>Fields can also be specified as an ordered list with the following entries:
    type, desc, &quot;optional&quot;/True

    For example:

    dictype = {
        &quot;summary&quot;: [str, &quot;A general summary of stuff&quot;],
        &quot;names&quot;: [ [str], &quot;List of stuff names&quot; ],
        &quot;cost&quot;: [ float, &quot;Cost of stuff&quot;, &quot;optional&quot; ],
        &quot;kind&quot;: [ [&quot;Open&quot;, &quot;Closed&quot;], &quot;The kind of stuff&quot; ],

        # For lists, desc can be split in two:
        &quot;colors&quot;: [ [str], &quot;Color list for stuff|Color names&quot; ],
        &quot;colors2&quot;: [ [str], [&quot;Color list for stuff&quot;, &quot;Color names&quot;] ],
    }

    The order in the list is: type, dec, &quot;optional/True
</code></pre>

  

  <div class="doc doc-children">








<div class="doc doc-object doc-function">



<h4 id="sibila.dictype.json_schema_from_dictype" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">json_schema_from_dictype</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">json_schema_from_dictype</span><span class="p">(</span>
    <span class="n">dictype</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">desc_from_title</span><span class="o">=</span><span class="mi">0</span>
<span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Create a JSON schema representation of a dictype.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>dictype</code></td>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The dictype.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>desc</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Top-level description of the dictype. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>desc_from_title</code></td>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Should title be used as description for fields that don't have one?. Values: 0=No, 1=Yes, 2=Yes + capitalize first letter and convert _ to space. Defaults to 0.</p>
            </div>
          </td>
          <td>
                <code>0</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Raises:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#TypeError">TypeError</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>If dictype inconsistencies found.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A dict with the created JSON schema.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>sibila/dictype.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">json_schema_from_dictype</span><span class="p">(</span><span class="n">dictype</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                             <span class="n">desc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                             <span class="n">desc_from_title</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a JSON schema representation of a dictype.</span>

<span class="sd">    Args:</span>
<span class="sd">        dictype: The dictype.</span>
<span class="sd">        desc: Top-level description of the dictype. Defaults to None.</span>
<span class="sd">        desc_from_title: Should title be used as description for fields that don&#39;t have one?. Values: 0=No, 1=Yes, 2=Yes + capitalize first letter and convert _ to space. Defaults to 0.</span>

<span class="sd">    Raises:</span>
<span class="sd">        TypeError: If dictype inconsistencies found.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A dict with the created JSON schema.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="n">desc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">out</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">desc</span>

    <span class="n">props</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span> 

    <span class="n">required_names</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">field_</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dictype</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>

        <span class="c1"># extract field&#39;s keys</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field_</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">if</span> <span class="s2">&quot;type&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">field_</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;All fields must include a type key at &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">field_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">ftype</span> <span class="o">=</span> <span class="n">field_</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>

            <span class="n">fdesc</span> <span class="o">=</span> <span class="n">field_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;desc&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">field_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">)</span>
            <span class="n">foptional</span> <span class="o">=</span> <span class="n">field_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;optional&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field_</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">field_</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fields specified as lists must at least have a type entry at &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">field_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">ftype</span> <span class="o">=</span> <span class="n">field_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">field_</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">fdesc</span> <span class="o">=</span> <span class="n">field_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fdesc</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">field_</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">foptional</span> <span class="o">=</span> <span class="n">field_</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">field_</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fields specified as lists must have 3 entries at most (type, desc, optional) at &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">field_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>                 
            <span class="k">else</span><span class="p">:</span>
                <span class="n">foptional</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fields can only be specified as dicts or lists at &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">field_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>                             

        <span class="c1"># verify field values</span>
        <span class="k">if</span> <span class="n">fdesc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># extract &quot;list desc&quot; | &quot;item desc&quot;</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fdesc</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">fdesc</span> <span class="o">=</span> <span class="n">fdesc</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fdesc</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">fdesc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fdesc</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Field&#39;s desc can only be list or str (divide str with &#39;|&#39; char) at &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">field_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fdesc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fields&#39;s desc can only have up to 2 strings at &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">field_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fdesc</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">foptional</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">foptional</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">foptional</span> <span class="o">=</span> <span class="n">foptional</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="n">foptional</span> <span class="o">=</span> <span class="p">(</span><span class="n">foptional</span> <span class="o">==</span> <span class="s2">&quot;optional&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">foptional</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">foptional</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Field&#39;s optional can only be bool or str at &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">field_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">foptional</span> <span class="o">=</span> <span class="kc">False</span>


        <span class="c1"># now emit</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ftype</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span> <span class="c1"># list=[type] or [enum1,enum2]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ftype</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># a list of type or of enum</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ftype</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span> <span class="c1"># list of enum</span>
                    <span class="n">items</span> <span class="o">=</span> <span class="n">make_enum</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">ftype</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fdesc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                      <span class="n">desc_from_title</span><span class="o">=</span><span class="n">desc_from_title</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span> <span class="c1"># list of type</span>
                    <span class="n">items</span> <span class="o">=</span> <span class="n">make_prim</span><span class="p">(</span><span class="n">ftype</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">fdesc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                      <span class="n">desc_from_title</span><span class="o">=</span><span class="n">desc_from_title</span><span class="p">)</span>

                <span class="n">props</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">make_prop</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span> <span class="n">fdesc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">items</span><span class="o">=</span><span class="n">items</span><span class="p">,</span>
                                        <span class="n">desc_from_title</span><span class="o">=</span><span class="n">desc_from_title</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span> <span class="c1"># list of enum</span>
                <span class="k">if</span> <span class="n">fdesc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Enums must have single description at &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">field_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="n">props</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">make_enum</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">ftype</span><span class="p">,</span> <span class="n">fdesc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                        <span class="n">desc_from_title</span><span class="o">=</span><span class="n">desc_from_title</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span> <span class="c1"># a primitive type</span>
            <span class="k">if</span> <span class="n">fdesc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Primitive types must have single description at &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">field_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">props</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">make_prim</span><span class="p">(</span><span class="n">ftype</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">fdesc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                    <span class="n">desc_from_title</span><span class="o">=</span><span class="n">desc_from_title</span><span class="p">)</span>


        <span class="k">if</span> <span class="ow">not</span> <span class="n">foptional</span><span class="p">:</span>
            <span class="n">required_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>


    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">required_names</span><span class="p">):</span>
        <span class="n">out</span><span class="p">[</span><span class="s2">&quot;required&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">required_names</span>

    <span class="n">out</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;object&quot;</span>

    <span class="k">return</span> <span class="n">out</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>




  </div>

  </div>

</div><h2 id="tokenizers">Tokenizers</h2>
<p>Tokenizers used in models.</p>


<div class="doc doc-object doc-class">



<h3 id="sibila.LlamaCppTokenizer" class="doc doc-heading">
          <span class="doc doc-object-name doc-class-name">LlamaCppTokenizer</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">LlamaCppTokenizer</span><span class="p">(</span><span class="n">llama</span><span class="p">,</span> <span class="n">reg_flags</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents first">

  
      <p>Tokenizer for llama.cpp loaded GGUF models.</p>

                <details class="quote">
                  <summary>Source code in <code>sibila/llamacpp.py</code></summary>
                  <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
             <span class="n">llama</span><span class="p">:</span> <span class="n">Llama</span><span class="p">,</span> 
             <span class="n">reg_flags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_llama</span> <span class="o">=</span> <span class="n">llama</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">vocab_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_llama</span><span class="o">.</span><span class="n">n_vocab</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">bos_token_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_llama</span><span class="o">.</span><span class="n">token_bos</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bos_token</span> <span class="o">=</span> <span class="n">llama_token_get_text</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_llama</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bos_token_id</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">eos_token_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_llama</span><span class="o">.</span><span class="n">token_eos</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">eos_token</span> <span class="o">=</span> <span class="n">llama_token_get_text</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_llama</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eos_token_id</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">pad_token_id</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pad_token</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">unk_token_id</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># ? fill by taking a look at id 0?</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">unk_token</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># workaround for https://github.com/ggerganov/llama.cpp/issues/4772</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_workaround1</span> <span class="o">=</span> <span class="n">reg_flags</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;llamacpp1&quot;</span> <span class="ow">in</span> <span class="n">reg_flags</span>
</code></pre></div></td></tr></table></div>
                </details>

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">



<h4 id="sibila.LlamaCppTokenizer.encode" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">encode</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">encode</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Encode text into model tokens. Inverse of Decode().</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>text</code></td>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Text to be encoded.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A list of ints with the encoded tokens.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>sibila/llamacpp.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
           <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Encode text into model tokens. Inverse of Decode().</span>

<span class="sd">    Args:</span>
<span class="sd">        text: Text to be encoded.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list of ints with the encoded tokens.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_workaround1</span><span class="p">:</span>
        <span class="c1"># append a space after each bos and eos, so that llama&#39;s tokenizer matches HF</span>
        <span class="k">def</span> <span class="nf">space_post</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
            <span class="n">out</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">index</span> <span class="o">:=</span> <span class="n">text</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">after</span> <span class="o">=</span> <span class="n">index</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="n">text</span><span class="p">[:</span><span class="n">after</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">text</span><span class="p">[</span><span class="n">after</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39; &#39;</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="n">after</span><span class="p">:]</span>

            <span class="n">out</span> <span class="o">+=</span> <span class="n">text</span>
            <span class="k">return</span> <span class="n">out</span>

        <span class="n">text</span> <span class="o">=</span> <span class="n">space_post</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bos_token</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">space_post</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eos_token</span><span class="p">)</span>
        <span class="c1"># print(text)</span>

    <span class="c1"># str -&gt; bytes</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_llama</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">add_bos</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">special</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>







<div class="doc doc-object doc-function">



<h4 id="sibila.LlamaCppTokenizer.decode" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">decode</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">decode</span><span class="p">(</span><span class="n">token_ids</span><span class="p">,</span> <span class="n">skip_special</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Decode model tokens to text. Inverse of Encode().</p>
<p>Using instead of llama-cpp-python's to fix error: remove first character after a bos only if it's a space.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>token_ids</code></td>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>List of model tokens.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>skip_special</code></td>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Don't decode special tokens like bos and eos. Defaults to True.</p>
            </div>
          </td>
          <td>
                <code>True</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Decoded text.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>sibila/llamacpp.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
           <span class="n">token_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
           <span class="n">skip_special</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Decode model tokens to text. Inverse of Encode().</span>

<span class="sd">    Using instead of llama-cpp-python&#39;s to fix error: remove first character after a bos only if it&#39;s a space.</span>

<span class="sd">    Args:</span>
<span class="sd">        token_ids: List of model tokens.</span>
<span class="sd">        skip_special: Don&#39;t decode special tokens like bos and eos. Defaults to True.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Decoded text.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">token_ids</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="n">output</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
    <span class="n">size</span> <span class="o">=</span> <span class="mi">32</span>
    <span class="n">buffer</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_char</span> <span class="o">*</span> <span class="n">size</span><span class="p">)()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_special</span><span class="p">:</span>
        <span class="n">special_toks</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bos_token_id</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">bos_token</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">),</span> 
                        <span class="bp">self</span><span class="o">.</span><span class="n">eos_token_id</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">eos_token</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)}</span>

        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">token_ids</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">token</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">bos_token_id</span><span class="p">:</span>
                <span class="n">output</span> <span class="o">+=</span> <span class="n">special_toks</span><span class="p">[</span><span class="n">token</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">token</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">eos_token_id</span><span class="p">:</span>
                <span class="n">output</span> <span class="o">+=</span> <span class="n">special_toks</span><span class="p">[</span><span class="n">token</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">llama_cpp</span><span class="o">.</span><span class="n">llama_token_to_piece</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_llama</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">llama_cpp</span><span class="o">.</span><span class="n">llama_token</span><span class="p">(</span><span class="n">token</span><span class="p">),</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">size</span>
                <span class="p">)</span>
                <span class="n">output</span> <span class="o">+=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">buffer</span><span class="p">[:</span><span class="n">n</span><span class="p">])</span>

    <span class="k">else</span><span class="p">:</span> <span class="c1"># skip special</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">token_ids</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">token</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bos_token_id</span> <span class="ow">and</span> <span class="n">token</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eos_token_id</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">llama_cpp</span><span class="o">.</span><span class="n">llama_token_to_piece</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_llama</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">llama_cpp</span><span class="o">.</span><span class="n">llama_token</span><span class="p">(</span><span class="n">token</span><span class="p">),</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">size</span>
                <span class="p">)</span>
                <span class="n">output</span> <span class="o">+=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">buffer</span><span class="p">[:</span><span class="n">n</span><span class="p">])</span>


    <span class="c1"># &quot;User code is responsible for removing the leading whitespace of the first non-BOS token when decoding multiple tokens.&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="c1"># token_ids[0] != self.bos_token_id and # we also try cutting if first is bos to approximate HF tokenizer</span>
       <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="ow">and</span> <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">32</span> <span class="c1"># 32 = ord(&#39; &#39;)</span>
       <span class="p">):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

    <span class="k">return</span> <span class="n">output</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>







<div class="doc doc-object doc-function">



<h4 id="sibila.LlamaCppTokenizer.token_len" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">token_len</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">token_len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Returns token length for given text.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>text</code></td>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Text to be measured.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Token length for given text.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>sibila/model.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">token_len</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
              <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns token length for given text.</span>

<span class="sd">    Args:</span>
<span class="sd">        text: Text to be measured.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Token length for given text.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>        
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>




  </div>

  </div>


</div>

<div class="doc doc-object doc-class">



<h3 id="sibila.OpenAITokenizer" class="doc doc-heading">
          <span class="doc doc-object-name doc-class-name">OpenAITokenizer</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">OpenAITokenizer</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents first">

  
      <p>Tokenizer for OpenAI models.</p>

                <details class="quote">
                  <summary>Source code in <code>sibila/openai.py</code></summary>
                  <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
             <span class="n">model</span><span class="p">:</span> <span class="nb">str</span>
             <span class="p">):</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">has_tiktoken</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Please install tiktoken by running: pip install tiktoken&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_tok</span> <span class="o">=</span> <span class="n">tiktoken</span><span class="o">.</span><span class="n">encoding_for_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">vocab_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tok</span><span class="o">.</span><span class="n">n_vocab</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">bos_token_id</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bos_token</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">eos_token_id</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">eos_token</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">pad_token_id</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pad_token</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">unk_token_id</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">unk_token</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
                </details>

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">



<h4 id="sibila.OpenAITokenizer.encode" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">encode</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">encode</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Encode text into model tokens. Inverse of Decode().</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>text</code></td>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Text to be encoded.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A list of ints with the encoded tokens.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>sibila/openai.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
           <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Encode text into model tokens. Inverse of Decode().</span>

<span class="sd">    Args:</span>
<span class="sd">        text: Text to be encoded.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list of ints with the encoded tokens.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tok</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>







<div class="doc doc-object doc-function">



<h4 id="sibila.OpenAITokenizer.decode" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">decode</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">decode</span><span class="p">(</span><span class="n">token_ids</span><span class="p">,</span> <span class="n">skip_special</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Decode model tokens to text. Inverse of Encode().</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>token_ids</code></td>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>List of model tokens.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>skip_special</code></td>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Don't decode special tokens like bos and eos. Defaults to True.</p>
            </div>
          </td>
          <td>
                <code>True</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Decoded text.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>sibila/openai.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
           <span class="n">token_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
           <span class="n">skip_special</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Decode model tokens to text. Inverse of Encode().</span>

<span class="sd">    Args:</span>
<span class="sd">        token_ids: List of model tokens.</span>
<span class="sd">        skip_special: Don&#39;t decode special tokens like bos and eos. Defaults to True.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Decoded text.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">skip_special</span><span class="p">,</span> <span class="s2">&quot;OpenAITokenizer only supports skip_special=True&quot;</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tok</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token_ids</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>







<div class="doc doc-object doc-function">



<h4 id="sibila.OpenAITokenizer.token_len" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">token_len</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">token_len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Returns token length for given text.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>text</code></td>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Text to be measured.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Token length for given text.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>sibila/model.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">token_len</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
              <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns token length for given text.</span>

<span class="sd">    Args:</span>
<span class="sd">        text: Text to be measured.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Token length for given text.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>        
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>




  </div>

  </div>


</div>







  
  






                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.e1c3ead8.min.js"></script>
      
    
  </body>
</html>